{{/* jsBuild partial
    输入：
    字符串路径: "js/main.ts"
    或 partial "jsBuild" (dict "path" "js/main.ts" "opts" (dict "minify" false "target" "es2020"))
    输出： fingerprint 后 js 路径（map 文件同名加 .map）
*/}}
{{- $input := . -}}
{{- $path := "" -}}
{{- $userOpts := dict -}}

{{/* 判断输入类型：字符串或 map */}}
{{- if reflect.IsMap $input -}}
    {{- if (isset $input "path") -}}
        {{- $path = index $input "path" -}}
    {{- else -}}
        {{- errorf "jsBuild: dict input must include 'path' key" -}}
    {{- end -}}
    {{- if (isset $input "opts") -}}
        {{- $userOpts = index $input "opts" -}}
    {{- end -}}
{{- else -}}
    {{- $path = $input -}}
{{- end -}}

{{- if not $path -}}
    {{- errorf "jsBuild: missing 'path' argument" -}}
{{- end -}}

{{- $res := resources.Get $path -}}
{{- if not $res -}}
    {{- errorf "jsBuild: resource not found for path %q" $path -}}
{{- end -}}

{{/* 默认构建参数 */}}
{{- $defaultOpts := dict "minify" true "sourceMap" "inline" -}}

{{/* 合并用户覆盖项 */}}
{{- $opts := merge $defaultOpts $userOpts -}}

{{- $built := $res | js.Build $opts | fingerprint -}}

{{- $content := $built.Content -}}
{{- $pattern := `(?m)^//# sourceMappingURL=data:application/json;base64,([A-Za-z0-9+/=]+)$` -}}
{{- $matches := findRESubmatch $pattern $content 1 -}}
{{- $finalJs := $built -}}

{{- if gt (len $matches) 0 -}}
    {{- $base64 := index (index $matches 0) 1 -}}
    {{- $mapBytes := base64Decode $base64 -}}
    {{- $clean := replaceRE $pattern "" $content -}}

    {{- $dir := path.Dir $built.RelPermalink | strings.TrimPrefix "/" -}}
    {{- $filename := path.Base $built.RelPermalink -}}
    {{- $mapPath := printf "%s.map" (printf "%s/%s" $dir $filename) -}}

    {{- $map := resources.FromString $mapPath $mapBytes -}}

    {{- $mapURL := path.Base $map.RelPermalink -}}
    {{- $newJsContent := printf "%s\n//# sourceMappingURL=%s" $clean $mapURL -}}
    {{- $finalJs = resources.FromString (printf "%s/%s" $dir $filename) $newJsContent | fingerprint -}}
{{- end -}}

{{- return $finalJs.RelPermalink -}}
