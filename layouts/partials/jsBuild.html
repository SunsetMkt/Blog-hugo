{{/* jsBuild partial
    输入：
    - 字符串路径: "js/main.ts"
    - 或 dict: (dict "path" "js/main.ts" "opts" (dict "minify" false "target" "es2020"))
    输出：
    fingerprint 后 js 路径（map 文件同名加 .map）
*/}}

{{- $input := . -}}
{{- $path := "" -}}
{{- $userOpts := dict -}}

{{/* 支持字符串或 map 输入 */}}
{{- if reflect.IsMap $input -}}
    {{- if (isset $input "path") -}}
        {{- $path = index $input "path" -}}
    {{- else -}}
        {{- errorf "jsBuild: dict input must include 'path' key" -}}
    {{- end -}}
    {{- if (isset $input "opts") -}}
        {{- $userOpts = index $input "opts" -}}
    {{- end -}}
{{- else -}}
    {{- $path = $input -}}
{{- end -}}

{{- if not $path -}}
    {{- errorf "jsBuild: missing 'path' argument" -}}
{{- end -}}

{{- $res := resources.Get $path -}}
{{- if not $res -}}
    {{- errorf "jsBuild: resource not found for path %q" $path -}}
{{- end -}}

{{- $defaultOpts := dict "minify" true "sourceMap" "inline" -}}
{{- $opts := merge $defaultOpts $userOpts -}}

{{- $built := $res | js.Build $opts | fingerprint -}}

{{- $content := $built.Content -}}
{{- $pattern := `(?m)^//# sourceMappingURL=data:application/json;base64,([A-Za-z0-9+/=]+)$` -}}
{{- $matches := findRESubmatch $pattern $content 1 -}}
{{- $finalJs := $built -}}

{{- if gt (len $matches) 0 -}}
    {{- $base64 := index (index $matches 0) 1 -}}
    {{- $mapBytes := base64Decode $base64 -}}
    {{- $mapContent := string $mapBytes -}}

    {{/* 替换 <stdin> 为原始文件名 */}}
    {{- $sourceFile := path.Base $path -}}
    {{- $mapContent = replace $mapContent "<stdin>" $sourceFile -}}

    {{- $clean := replaceRE $pattern "" $content -}}

    {{- $dir := path.Dir $built.RelPermalink | strings.TrimPrefix "/" -}}
    {{- $filename := path.Base $built.RelPermalink -}}
    {{- $mapPath := cond (ne $dir "") (printf "%s/%s.map" $dir $filename) (printf "%s.map" $filename) -}}

    {{- $map := resources.FromString $mapPath $mapContent -}}

    {{- $mapURL := path.Base $map.RelPermalink -}}
    {{- $newJsContent := printf "%s\n//# sourceMappingURL=%s" $clean $mapURL -}}
    {{- $jsOutPath := cond (ne $dir "") (printf "%s/%s" $dir $filename) $filename -}}
    {{- $finalJs = resources.FromString $jsOutPath $newJsContent | fingerprint -}}
{{- end -}}

{{- return $finalJs.RelPermalink -}}
