(self.webpackChunkAVPlayer=self.webpackChunkAVPlayer||[]).push([[115],{64436:(t,e,i)=>{"use strict";i.d(e,{A:()=>o});var a=i(49859),r=i(63939),s=(i(77162),i(37837)),n=i(71766);class o{constructor(){(0,a.A)(this,"inCodecpar",void 0),(0,a.A)(this,"inTimeBase",void 0),(0,a.A)(this,"outCodecpar",void 0)}init(t,e){return this.inCodecpar=(0,s.Gy)(168),(0,n.Yi)(this.inCodecpar,t),this.inTimeBase={den:r.f[15](e+4),num:r.f[15](e)},0}destroy(){this.inCodecpar&&((0,n.dn)(this.inCodecpar),this.inCodecpar=0)}}},26173:(t,e,i)=>{"use strict";i.d(e,{A:()=>m});var a=i(49859),r=i(63939),s=i(50932),n=i(64436),o=i(71517),c=i(62815),d=i(67659),u=i(59166),f=i(14686),l=i(9705),p=i(37837),h=i(4624);class m extends n.A{constructor(t=!1){super(),(0,a.A)(this,"cache",void 0),(0,a.A)(this,"cached",void 0),(0,a.A)(this,"reverseSps",void 0),this.reverseSps=t}init(t,e){return super.init(t,e),this.cache=(0,o._5)(),this.cached=!1,0}destroy(){super.destroy(),(0,o.Qe)(this.cache),this.cache=0}sendAVPacket(t){if(64&r.f[15](t+36)){let e;(0,o.zu)(this.cache,t);const i=(0,f.JW)(r.f[20](t+24),r.f[15](t+28));if(27===r.f[15](this.inCodecpar+4)?e=c.oT(i,this.reverseSps):173===r.f[15](this.inCodecpar+4)?e=d.oT(i,this.reverseSps):196===r.f[15](this.inCodecpar+4)?e=u.oT(i,this.reverseSps):h.h2(`not support for codecId: ${r.f[15](this.inCodecpar+4)}`,"src/avformat/bsf/h2645/Annexb2AvccFilter.ts",97),s.M[15](this.cache+36,-65&r.f[15](this.cache+36)),(0,o.NX)(this.cache,e.bufferPointer,e.length),e.key&&s.M[15](this.cache+36,1|r.f[15](this.cache+36)),e.extradata){const t=(0,p.sY)(e.extradata.length);(0,f.lW)(t,e.extradata.length,e.extradata),(0,o.Ow)(this.cache,1,t,e.extradata.length)}}else(0,o.rN)(this.cache,t);return this.cached=!0,0}receiveAVPacket(t){return this.cached?((0,o.Up)(t),(0,o.rN)(t,this.cache),this.cached=!1,0):l.LR}reset(){return 0}}},51597:(t,e,i)=>{"use strict";i.d(e,{A:()=>r});var a=i(49859);class r{constructor(){(0,a.A)(this,"type",-1)}async destroy(t){}}(0,a.A)(r,"Capabilities",[])},92695:(t,e,i)=>{"use strict";i.d(e,{A:()=>W});var a=i(49859),r=i(86226),s=i.n(r),n=i(71426),o=i.n(n),c=i(18979),d=i.n(c),u=i(48079),f=i.n(u),l=i(61499),p=i(63939),h=(i(9599),i(51597)),m=i(49922),g=i(65977),k=i(64061),w=i(16978),v=i(93194),b=i(35336),U=i(72739),I=i(4624),P=i(92647),y=i(52150),S=i(77231),A=i(95335),B=i(20841),x=i(59989),T=i(44328),D=i(71517),C=i(26173),M=i(67672),z=i(43607),E=i(87518),F=i(14686),N=i(331),R=i(50315);const O="src/avformat/formats/OIsobmffFormat.ts",Q={fragmentMode:0,mp4Mode:0,fragment:!1,fastOpen:!1,defaultBaseIsMoof:!1,reverseSpsInAvcc:!1,ignoreEncryption:!1,minFragmentLength:5e3,minFragmentIndexLength:5e3,hasTfra:!0,useMetadataTags:!1};class W extends h.A{constructor(t={}){super(),(0,a.A)(this,"type",1),(0,a.A)(this,"context",void 0),(0,a.A)(this,"options",void 0),(0,a.A)(this,"annexb2AvccFilter",void 0),(0,a.A)(this,"avpacket",void 0),this.options=A.X$({},Q,t),this.context=(0,m.A)()}init(t){var e;return t.ioWriter.setEndian(!0),s()(e=t.streams).call(e,(t=>{this.annexb2AvccFilter||27!==t.codecpar.codecId&&173!==t.codecpar.codecId&&196!==t.codecpar.codecId||(this.annexb2AvccFilter=new C.A(this.options.reverseSpsInAvcc),this.annexb2AvccFilter.init(t.codecpar[l.o9],t.timeBase[l.o9]))})),this.avpacket=(0,D._5)(),this.context.metadata=t.metadata,this.context.chapters=t.chapters,0}async destroy(t){this.annexb2AvccFilter&&(this.annexb2AvccFilter.destroy(),this.annexb2AvccFilter=null),this.avpacket&&((0,D.Qe)(this.avpacket),this.avpacket=0)}enableStreams(t){const e=[],i=[];for(let t=0;t<5;t++)e[t]=0,i[t]=-1;U.__(t.streams,((t,a)=>{if(-1===t.codecpar.codecType||t.codecpar.codecType>=5||1024&t.disposition)return!0;i[t.codecpar.codecType]<0&&(i[t.codecpar.codecType]=a),1&t.disposition&&(e[t.codecpar.codecType]++,t.privData.flags|=1)}));for(let a=0;a<5;a++)switch(a){case 0:case 1:case 3:e[a]>1&&(t.streams[e[a]].privData.perStreamGrouping=!0),!e[a]&&i[a]>=0&&(t.streams[i[a]].privData.flags|=1)}}writeHeader(t){var e;this.context.majorBrand=(0,g.A)("isom"),this.context.minorVersion=512,this.context.compatibleBrand=[(0,g.A)("isom")],this.context.timescale=1e3,this.context.ignoreEncryption=this.options.ignoreEncryption,this.context.useMetadataTags=this.options.useMetadataTags;const i=o()(e=t.streams).call(e,(t=>1024&t.disposition&&(7===t.codecpar.codecId||61===t.codecpar.codecId||78===t.codecpar.codecId)));if(i&&i.attachedPic&&(this.context.covr={type:27,data:(0,D.iI)(i.attachedPic)},61===i.codecpar.codecId?this.context.covr.type=14:7===i.codecpar.codecId&&(this.context.covr.type=13)),this.options.fragment&&(this.context.compatibleBrand.push((0,g.A)("iso6")),this.context.fragment=!0),1===this.options.mp4Mode&&(this.context.isom=!0,this.context.majorBrand=(0,g.A)("qt  "),this.context.compatibleBrand=[this.context.majorBrand]),1!==this.options.mp4Mode){this.context.compatibleBrand.push((0,g.A)("iso2"));const e=t.getStreamByMediaType(0);e&&27===e.codecpar.codecId&&this.context.compatibleBrand.push((0,g.A)("avc1")),this.context.compatibleBrand.push((0,g.A)("mp41"))}if(k.l7(t.ioWriter,this.context),this.context.holdMoovPos=t.ioWriter.getPos(),this.options.fragment)this.context.currentFragment={pos:BigInt(0),currentTrack:null,sequence:1,tracks:[],size:0,firstWrote:!1},U.__(t.streams,((t,e)=>{const i=(0,w.A)();if(t.privData=i,i.chunkOffsets=[],i.cttsSampleCounts=[],i.cttsSampleOffsets=[],i.stscFirstChunk=[],i.stscSamplesPerChunk=[],i.stscSampleDescriptionIndex=[],i.stssSampleNumbers=[],i.sampleSizes=[],i.sttsSampleCounts=[],i.sttsSampleDeltas=[],i.alternateGroup=e,!(1024&t.disposition)){const e=(0,v.A)();e.baseIsMoof=this.options.defaultBaseIsMoof,e.streamIndex=t.index,e.trackId=this.context.nextTrackId++,i.trackId=e.trackId;const a=this.options.encryption||t.metadata.encryption;if(a){const t=this.context.cencs||{};t[e.trackId]={schemeType:a.schemeType,schemeVersion:a.schemeVersion,cryptByteBlock:a.cryptByteBlock,skipByteBlock:a.skipByteBlock,defaultConstantIV:a.constantIV,isProtected:1,defaultPerSampleIVSize:a.perSampleIVSize,defaultKeyId:a.kid,pattern:!!a.pattern},this.context.cencs=t}e.ioWriter=new b.A,e.ioWriter.onFlush=t=>(e.buffers.push(d()(t).call(t)),0),this.context.currentFragment.tracks.push(e)}})),this.enableStreams(t),k.dI(t.ioWriter,t,this.context),t.ioWriter.flush();else{U.__(t.streams,((t,e)=>{const i=(0,w.A)();t.privData=i,i.trackId=this.context.nextTrackId++,i.chunkOffsets=[],i.cttsSampleCounts=[],i.cttsSampleOffsets=[],i.stscFirstChunk=[],i.stscSamplesPerChunk=[],i.stscSampleDescriptionIndex=[],i.stssSampleNumbers=[],i.sampleSizes=[],i.sttsSampleCounts=[],i.sttsSampleDeltas=[],i.alternateGroup=e})),this.enableStreams(t);const e=t.ioWriter.getPos();t.ioWriter.writeUint32(0),t.ioWriter.writeUint32((0,g.A)("mdat")),this.context.boxsPositionInfo.push({pos:e,type:"mdat",size:0})}return t.getStreamByMediaType(0)||(this.context.audioOnly=!0),0}updateCurrentChunk(t){var e;let i=this.context.currentChunk;if(!i||!i.sampleCount)return;const a=o()(e=t.streams).call(e,(t=>t.index===i.streamIndex)).privData;a.chunkCount++,a.chunkOffsets.push(i.pos),a.stscFirstChunk.length?a.lastStscCount!==i.sampleCount&&(a.stscFirstChunk.push(a.chunkCount),a.stscSamplesPerChunk.push(i.sampleCount),a.stscSampleDescriptionIndex.push(1),a.lastStscCount=i.sampleCount):(a.stscFirstChunk.push(a.chunkCount),a.stscSamplesPerChunk.push(i.sampleCount),a.stscSampleDescriptionIndex.push(1),a.lastStscCount=i.sampleCount)}updateCurrentFragment(t,e){if(this.context.currentFragment.firstWrote){U.__(this.context.currentFragment.tracks,(i=>{var a;const r=o()(a=t.streams).call(a,(t=>t.index===i.streamIndex));if(!i.sampleCount||!r)return!0;const s=r.privData;var n,c;i.baseDataOffset=t.ioWriter.getPos(),this.context.currentFragment.pos=t.ioWriter.getPos(),i.sampleDurations.length?e&&i.sampleDurations.length===i.sampleSizes.length-1&&i.sampleDurations.push(Number(e-s.lastDts)):1===r.codecpar.codecType?e?i.sampleDurations.push(Number(e-s.lastDts)):r.codecpar.frameSize>0?i.sampleDurations.push(Number((0,T.k)(BigInt(Math.floor(r.codecpar.frameSize/r.codecpar.sampleRate*S.SF)),S.KR,r.timeBase))):(r.codecpar.codecId,i.sampleDurations.push(Number((0,T.k)(BigInt(Math.floor(1024/r.codecpar.sampleRate*S.SF)),S.KR,r.timeBase)))):0===r.codecpar.codecType?e?i.sampleDurations.push(Number(e-s.lastDts)):(0,T.lb)(r.codecpar.framerate)>0?i.sampleDurations.push(Number((0,T.k)(BigInt(Math.floor(1/(0,T.lb)(r.codecpar.framerate)*S.SF)),S.KR,r.timeBase))):i.sampleDurations.push(r.timeBase.den/(30*r.timeBase.num)>>>0):i.sampleDurations.push(0),s.lastDuration=i.sampleDurations[i.sampleSizes.length-1],(1===i.sampleFlags.length||(0,x.A)(i.sampleFlags,1))&&(i.firstSampleFlags=i.sampleFlags[0],i.defaultSampleFlags=null!==(n=i.sampleFlags[1])&&void 0!==n?n:i.firstSampleFlags,i.sampleFlags=[]),(1===i.sampleSizes.length||(0,x.A)(i.sampleSizes))&&(i.defaultSampleSize=i.sampleSizes[0],i.sampleSizes=[]),(1===i.sampleDurations.length||(0,x.A)(i.sampleDurations))&&(i.defaultSampleDuration=i.sampleDurations[0],i.sampleDurations=[]),i.cenc&&(1===i.cenc.sampleSizes.length||(0,x.A)(i.cenc.sampleSizes))&&(i.cenc.defaultSampleInfoSize=i.cenc.sampleSizes[0],i.cenc.sampleSizes=[]),1===r.codecpar.codecType?i.defaultSampleFlags=33554432:i.sampleFlags.length&&(i.defaultSampleFlags=i.sampleFlags[0]),i.sampleSizes.length&&(i.defaultSampleSize=i.sampleSizes[0]),i.sampleDurations.length&&(i.defaultSampleDuration=i.sampleDurations[0]),this.options.hasTfra&&(!s.fragIndexes.length||0===this.options.fragmentMode||(0,T.k)(i.baseDataOffset-i.lastFragIndexDts,r.timeBase,S.i0)>=this.options.minFragmentIndexLength)&&(s.fragIndexes.push({pos:i.baseDataOffset,time:i.baseMediaDecodeTime+BigInt(Math.floor(null!==(c=i.sampleCompositionTimeOffset[0])&&void 0!==c?c:0))}),i.lastFragIndexDts=s.lastDts)})),t.ioWriter.flush(),this.options.onFragmentStart&&this.options.onFragmentStart(),k.Ro(t.ioWriter,t,this.context);let i=this.context.currentFragment.size+8;const a=[];let r=8;U.__(this.context.currentFragment.tracks,(e=>{if(!e.sampleCount)return!0;e.ioWriter.flush();const s=(0,P.A)(Uint8Array,e.buffers);e.dataOffset=i,i+=s.length,r+=s.length,a.push(s),(0,B.A)(t.ioWriter,e.dataOffsetPos,e.dataOffset,"int32"),e.cenc&&e.cenc.offsetPos&&(0,B.A)(t.ioWriter,e.cenc.offsetPos,e.cenc.offset,"int32"),e.buffers=[],e.sampleFlags=[],e.sampleSizes=[],e.sampleDurations=[],e.sampleCompositionTimeOffset=[],e.sampleCount=0,e.firstSampleFlags=0,e.cenc=null})),t.ioWriter.writeUint32(r),t.ioWriter.writeUint32((0,g.A)("mdat")),U.__(a,(e=>{t.ioWriter.writeBuffer(e)})),(0,y.A)(t.ioWriter,this.context),t.ioWriter.flush(),this.context.currentFragment.firstWrote=!1,this.context.currentFragment.sequence++}}handleEAC3(t,e){this.context.ac3Info||(this.context.ac3Info={done:!1,numBlocks:0,dataRate:0,ac3BitrateCode:-1,numIndSub:0,substream:[]});const i=this.context.ac3Info,a=E.R((0,F.s3)(p.f[20](t+24),p.f[15](t+28)));if(M.ai(a))i.done=!0;else if(i.dataRate=Math.max(i.dataRate,a.bitrate/1e3),i.ac3BitrateCode=Math.max(i.ac3BitrateCode,a.ac3BitrateCode),!i.done){if(a.bitstreamId<=10&&0!=a.substreamId)return;if(0===a.frameType||2==a.frameType){var r;if(a.substreamId>i.numIndSub+1)return;if(a.substreamId==i.numIndSub+1)return;if(a.substreamId<i.numIndSub||0==a.substreamId&&null!==(r=i.substream[0])&&void 0!==r&&r.bsid)return void(i.done=!0)}else if(0!=a.substreamId)return;if(i.substream[a.substreamId]||(i.substream[a.substreamId]={fscod:0,bsid:0,bsmod:0,acmod:0,lfeon:0,numDepSub:0,chanLoc:0}),i.substream[a.substreamId].fscod=a.srCode,i.substream[a.substreamId].bsid=a.bitstreamId,i.substream[a.substreamId].bsmod=a.bitstreamMode,i.substream[a.substreamId].acmod=a.channelMode,i.substream[a.substreamId].lfeon=a.lfeOn,86019===e.codecpar.codecId)return void(i.done=!0)}}writeTrackData(t,e,i,a){if(94226===a.codecpar.codecId){const s=a.privData;if(s.lastDuration>0){const n=s.lastDts+BigInt(Math.floor(s.lastDuration));if(n<i&&(0,T.k)(i-n,a.timeBase,S.i0)>200){t.writeUint32(8),t.writeString("vtte");const a=Number(i-n);if(this.context.fragment){var r;const t=o()(r=this.context.currentFragment.tracks).call(r,(t=>t.streamIndex===p.f[15](e+32)));t.sampleCount++,t.sampleSizes.length||(t.baseMediaDecodeTime=n),t.sampleDurations.push(a),t.sampleSizes.push(8)}else{const t=Number(n-s.lastDts);this.context.currentChunk.sampleCount++,s.sampleSizes.push(8),s.sttsSampleDeltas[s.sttsSampleDeltas.length-1]===t?s.sttsSampleCounts[s.sttsSampleCounts.length-1]++:(s.sttsSampleCounts.push(1),s.sttsSampleDeltas.push(t))}s.lastPts=n,s.lastDts=n,s.lastDuration=a}}const n=(0,D.rU)(e,16),c=(0,D.rU)(e,17);let d=p.f[15](e+28)+8;return n&&(d+=8+(0|p.f[25](n+4))),c&&(d+=8+(0|p.f[25](c+4))),t.writeUint32(8+d),t.writeString("vttc"),n&&(t.writeUint32(8+p.f[25](n+4)),t.writeString("iden"),t.writeBuffer((0,F.s3)(p.f[20](n),p.f[25](n+4)))),c&&(t.writeUint32(8+p.f[25](c+4)),t.writeString("sttg"),t.writeBuffer((0,F.s3)(p.f[20](c),p.f[25](c+4)))),t.writeUint32(8+p.f[15](e+28)),t.writeString("payl"),t.writeBuffer((0,D.iI)(e)),8+d}return t.writeBuffer((0,D.iI)(e)),p.f[15](e+28)}writeAVPacket(t,e){if(!p.f[15](e+28))return I.R8(`packet's size is 0: ${p.f[15](e+32)}, ignore it`,O,755),0;const i=t.getStreamByIndex(p.f[15](e+32));if(!i||1024&i.disposition)return void I.R8(`can not found the stream width the avpacket's streamIndex: ${p.f[15](e+32)}, ignore it`,O,762);const a=i.privData;let r=(0,T.Mr)(p.f[17](e+16),e+72,i.timeBase),s=(0,T.Mr)(p.f[17](e+8)!==S.Dh?p.f[17](e+8):p.f[17](e+16),e+72,i.timeBase);const n=p.f[17](e+48)!==S.Dh?(0,T.Mr)(p.f[17](e+48),e+72,i.timeBase):S.Dh;if((27===i.codecpar.codecId||173===i.codecpar.codecId||196===i.codecpar.codecId)&&64&p.f[15](e+36)?(this.annexb2AvccFilter.sendAVPacket(e),this.annexb2AvccFilter.receiveAVPacket(this.avpacket),e=this.avpacket):86019!==i.codecpar.codecId&&86056!==i.codecpar.codecId||this.context.ac3Info&&this.context.ac3Info.done||this.handleEAC3(e,i),this.context.fragment){var c;const u=o()(c=this.context.currentFragment.tracks).call(c,(t=>t.streamIndex===p.f[15](e+32)));if(u){u.tfdtDelay===S.Dh&&(u.tfdtDelay=r<0?-r:BigInt(0),s<0&&(u.trunPtsDelay=u.tfdtDelay)),r+=u.tfdtDelay,s+=u.trunPtsDelay,(0===this.options.fragmentMode&&(0===i.codecpar.codecType&&1&p.f[15](e+36)||this.context.audioOnly&&(0,T.k)(r-u.baseMediaDecodeTime,i.timeBase,S.i0)>=this.options.minFragmentLength)||1===this.options.fragmentMode)&&(1===this.context.currentFragment.tracks.length?this.updateCurrentFragment(t,r):this.updateCurrentFragment(t));const o=this.writeTrackData(u.ioWriter,e,r,i);if(u.sampleSizes.length||(u.baseMediaDecodeTime=r),u.sampleSizes.length&&(!u.sampleDurations[u.sampleSizes.length-1]||u.sampleDurations[u.sampleSizes.length-1]<=0)&&(u.sampleDurations[u.sampleSizes.length-1]=Number(r-a.lastDts)),n>0&&u.sampleDurations.push(Number(n)),u.sampleSizes.push(o),0===i.codecpar.codecType){let t=0;1&p.f[15](e+36)?t|=33554432:t|=16842752,u.sampleCompositionTimeOffset.push(Number((s!==S.Dh?s:r)-r)),u.sampleFlags.push(t)}const c=(0,D.Un)(e+40,e+44,25),l=this.context.cencs&&this.context.cencs[a.trackId];if(c&&l){const t=(0,R.p$)((0,F.s3)(p.f[20](c),p.f[25](c+4)));var d;if(u.cenc||(u.cenc={sampleCount:0,defaultSampleInfoSize:0,sampleSizes:[],offset:0,useSubsamples:!1,sampleInfoOffset:[],sampleEncryption:[]}),t.subsamples.length)!u.cenc.useSubsamples&&u.cenc.sampleSizes.length&&(u.cenc.sampleSizes=f()(d=u.cenc.sampleSizes).call(d,(t=>t+2))),u.cenc.useSubsamples=!0;u.cenc.sampleCount++,u.cenc.sampleSizes.push(l.defaultPerSampleIVSize+(u.cenc.useSubsamples?2+6*t.subsamples.length:0)),u.cenc.sampleEncryption.push({iv:t.iv,subsamples:t.subsamples})}u.sampleCount++,a.lastPts=z.T9(a.lastPts,s+(n!==S.Dh?n:BigInt(0))),a.lastDts=r,n>0&&(a.lastDuration=Number(n)),this.context.currentFragment.firstWrote=!0}else I.R8(`can not found track width streamIndex ${p.f[15](e+32)}, ignore it`,O,900)}else{const o=t.ioWriter.getPos();let c=this.context.currentChunk;if(c?c.streamIndex!==p.f[15](e+32)?(this.updateCurrentChunk(t),c.streamIndex=p.f[15](e+32),c.sampleCount=1,c.pos=o):c.sampleCount++:c=this.context.currentChunk={pos:o,streamIndex:p.f[15](e+32),sampleCount:1},a.sampleSizes.push(this.writeTrackData(t.ioWriter,e,r,i)),0===i.codecpar.codecType&&1&p.f[15](e+36)&&a.stssSampleNumbers.push(a.sampleSizes.length),a.firstWrote){const t=Number(r-a.lastDts);a.sttsSampleDeltas[a.sttsSampleDeltas.length-1]===t?a.sttsSampleCounts[a.sttsSampleCounts.length-1]++:(a.sttsSampleCounts.push(1),a.sttsSampleDeltas.push(t))}else a.startDts=r,a.startCT=Number((s!==S.Dh?s:r)-r),a.firstWrote=!0;if(s>=0&&(a.startPts===S.Dh?a.startPts=s:a.startPts=z.jk(a.startPts,s)),0===i.codecpar.codecType){const t=Number((s!==S.Dh?s:r)-r);a.cttsSampleCounts.length&&a.cttsSampleOffsets[a.cttsSampleOffsets.length-1]===t?a.cttsSampleCounts[a.cttsSampleCounts.length-1]++:(a.cttsSampleCounts.push(1),a.cttsSampleOffsets.push(t))}a.lastPts=z.T9(a.lastPts,s+(n!==S.Dh?n:BigInt(0))),a.lastDts=r,a.lastDuration=Number(n)}return 0}writeTrailer(t){if(this.context.fragment)U.__(this.context.currentFragment.tracks,(e=>{var i;const a=o()(i=t.streams).call(i,(t=>t.index===e.streamIndex)).privData;e.sampleCount&&(e.sampleDurations.length?e.sampleDurations.push(e.sampleDurations[e.sampleDurations.length-1]):e.sampleDurations=[a.lastDuration])})),this.updateCurrentFragment(t),this.options.hasTfra?k.yT(t.ioWriter,t,this.context):(t.ioWriter.writeUint32(8),t.ioWriter.writeString("mfra")),t.ioWriter.flush();else{this.updateCurrentChunk(t);let e=BigInt(0);U.__(t.streams,(t=>{if(1024&t.disposition)return!0;const i=t.privData;i.sampleSizes.length&&(i.sttsSampleDeltas.length?i.lastDuration>0&&i.lastDuration!==i.sttsSampleDeltas[i.sttsSampleDeltas.length-1]?(i.sttsSampleCounts.push(1),i.sttsSampleDeltas.push(i.lastDuration)):i.sttsSampleCounts[i.sttsSampleCounts.length-1]++:(i.sttsSampleCounts=[1],i.sttsSampleDeltas=[0]));const a=(0,T.k)((0,N.A)(i),t.timeBase,{den:1e3,num:1});a>e&&(e=a)})),this.context.duration=e;const i=this.context.boxsPositionInfo[this.context.boxsPositionInfo.length-1];if("mdat"!==i.type&&I.z3("last box is not mdat",O,1027),i.size=Number(t.ioWriter.getPos()-i.pos),i.size>S.f7){const e=t.ioWriter.getPos();t.ioWriter.seek(i.pos-BigInt(8)),t.ioWriter.writeUint32(1),t.ioWriter.writeUint32((0,g.A)("mdat")),t.ioWriter.writeUint64(BigInt(i.size)+BigInt(8)),t.ioWriter.seek(e),this.context.boxsPositionInfo.pop(),this.context.use64Mdat=!0}if((0,y.A)(t.ioWriter,this.context),this.options.fastOpen){t.ioWriter.flush();let e=[];const i=t.ioWriter.onFlush;t.ioWriter.onFlush=t=>(e.push(d()(t).call(t)),0),k.dI(t.ioWriter,t,this.context),t.ioWriter.flush();let a=(0,P.A)(Uint8Array,e);U.__(t.streams,(t=>{const e=t.privData;if(e.chunkOffsets.length)for(let t=0;t<e.chunkOffsets.length;t++)e.chunkOffsets[t]+=BigInt(Math.floor(a.length))})),e=[],k.dI(t.ioWriter,t,this.context),t.ioWriter.flush(),a=(0,P.A)(Uint8Array,e),i&&i(a,this.context.holdMoovPos),t.ioWriter.onFlush=i}else k.dI(t.ioWriter,t,this.context),t.ioWriter.flush()}return 0}flush(t){return this.options.fragment&&(U.__(this.context.currentFragment.tracks,(e=>{var i;const a=o()(i=t.streams).call(i,(t=>t.index===e.streamIndex)).privData;e.sampleCount&&(e.sampleDurations.length?e.sampleDurations.push(e.sampleDurations[e.sampleDurations.length-1]):e.sampleDurations=[a.lastDuration])})),this.updateCurrentFragment(t)),t.ioWriter.flush(),0}getCapabilities(){return W.Capabilities}}(0,a.A)(W,"Capabilities",[86021,86076,86018,86017,86028,86051,86019,86056,167,225,27,173,196,12,94226,94213])},331:(t,e,i)=>{"use strict";i.d(e,{A:()=>r});var a=i(77231);function r(t){return t.startPts!==a.Dh?t.lastPts-t.startPts:t.startDts===a.Dh?t.lastPts:t.lastPts-(t.startDts+BigInt(0|t.startCT))}},52150:(t,e,i)=>{"use strict";i.d(e,{A:()=>r});var a=i(72739);function r(t,e){const i=t.getPos(),r=t.getPointer(),s=i-BigInt(Math.floor(r)),n=[];a.__(e.boxsPositionInfo,(e=>{e.pos<i&&e.pos>=s?(t.seekInline(r+Number(e.pos-i)),t.writeUint32(e.size)):n.push(e)})),t.seekInline(r),n.length&&(a.__(n,(e=>{t.seek(e.pos),t.writeUint32(e.size)})),t.seek(i)),e.boxsPositionInfo=[]}},74244:(t,e,i)=>{"use strict";i.d(e,{BB:()=>n,Ip:()=>o,Jl:()=>s});var a=i(52730),r=i.n(a);const s={1:function(t,e){return[{type:"tkhd"},{type:"mdia",children:[{type:"mdhd"},{type:"hdlr"},{type:"minf",children:[{type:"smhd"},t.isom?{type:"minf_hdlr"}:null,{type:"dinf",children:[{type:"dref",children:[{type:"url "}]}]},{type:"stbl",children:[{type:"stsd"},{type:"stts"},{type:"stsc"},{type:"stsz"},{type:"stco"}]}]}]}]},0:function(t,e){return[{type:"tkhd"},{type:"mdia",children:[{type:"mdhd"},{type:"hdlr"},{type:"minf",children:[{type:"vmhd"},t.isom?{type:"minf_hdlr"}:null,{type:"dinf",children:[{type:"dref",children:[{type:"url "}]}]},{type:"stbl",children:[{type:"stsd"},{type:"stts"},{type:"stsc"},{type:"stsz"},{type:"stco"}]}]}]}]},3:function(t,e){return[{type:"tkhd"},{type:"mdia",children:[{type:"mdhd"},{type:"hdlr"},{type:"minf",children:[{type:94232===e.codecpar.codecId?"sthd":"nmhd"},t.isom?{type:"minf_hdlr"}:null,{type:"dinf",children:[{type:"dref",children:[{type:"url "}]}]},{type:"stbl",children:[{type:"stsd"},{type:"stts"},{type:"stsc"},{type:"stsz"},{type:"stco"}]}]}]}]}},n={1:function(t,e){return[{type:"tkhd"},{type:"edts"},{type:"mdia",children:[{type:"mdhd"},{type:"hdlr"},{type:"minf",children:[{type:"smhd"},t.isom?{type:"minf_hdlr"}:null,{type:"dinf",children:[{type:"dref",children:[{type:"url "}]}]},{type:"stbl",children:[{type:"stsd"},{type:"stts"},{type:"stsc"},{type:"stsz"},{type:t.use64Mdat?"co64":"stco"}]}]}]}]},0:function(t,e){let i=!0;if(27===e.codecpar.codecId||173===e.codecpar.codecId||196===e.codecpar.codecId){const t=e.privData;2&r()(e.codecpar)&&(!t.cttsSampleCounts||!t.cttsSampleCounts.length||1===t.cttsSampleCounts.length&&0===t.cttsSampleOffsets[0])&&(i=!1)}return[{type:"tkhd"},{type:"edts"},{type:"mdia",children:[{type:"mdhd"},{type:"hdlr"},{type:"minf",children:[{type:"vmhd"},t.isom?{type:"minf_hdlr"}:null,{type:"dinf",children:[{type:"dref",children:[{type:"url "}]}]},{type:"stbl",children:[{type:"stsd"},{type:"stts"},{type:"stss"},i?{type:"ctts"}:null,{type:"stsc"},{type:"stsz"},{type:t.use64Mdat?"co64":"stco"}]}]}]}]},3:function(t,e){return[{type:"tkhd"},{type:"edts"},{type:"mdia",children:[{type:"mdhd"},{type:"hdlr"},{type:"minf",children:[{type:94232===e.codecpar.codecId?"sthd":"nmhd"},t.isom?{type:"minf_hdlr"}:null,{type:"dinf",children:[{type:"dref",children:[{type:"url "}]}]},{type:"stbl",children:[{type:"stsd"},{type:"stts"},{type:"stsc"},{type:"stsz"},{type:t.use64Mdat?"co64":"stco"}]}]}]}]}},o=function(t){return[{type:"tfhd"},{type:"tfdt"},{type:"trun"},t.cenc&&(t.cenc.defaultSampleInfoSize||t.cenc.sampleSizes.length)?{type:"saiz"}:null,t.cenc&&(t.cenc.defaultSampleInfoSize||t.cenc.sampleSizes.length)?{type:"saio"}:null,t.cenc?{type:"senc"}:null]}},64061:(t,e,i)=>{"use strict";i.d(e,{Ro:()=>I,dI:()=>U,l7:()=>v,yT:()=>P});var a=i(86226),r=i.n(a),s=i(71426),n=i.n(s),o=i(61499),c=i(63939),d=i(65977),u=i(91153),f=i(72739),l=i(7543),p=i(74244),h=i(52150),m=i(71517),g=i(50315),k=i(14686),w=i(50011);function v(t,e){t.flush();const i=t.getPointer(),a=t.getPos();t.writeUint32(0),t.writeUint32((0,d.A)("ftyp")),t.writeUint32(e.majorBrand||(0,d.A)("isom")),t.writeUint32(e.minorVersion||512),f.__(e.compatibleBrand,(e=>{t.writeUint32(e)})),function(t,e,i){const a=t.getPointer();t.seekInline(e),t.writeUint32(i),t.seekInline(a)}(t,i,Number(t.getPos()-a)),e.isom?(t.writeUint32(8),t.writeUint32((0,d.A)("wide"))):e.fragment||(t.writeUint32(8),t.writeUint32((0,d.A)("free")))}function b(t,e,i,a){f.__(e,(e=>{if(!e)return!0;if(l.A[e.type])l.A[e.type](t,i,a);else if(e.children){const r=t.getPos();t.writeUint32(0),t.writeUint32((0,d.A)(e.type)),b(t,e.children,i,a),a.boxsPositionInfo.push({pos:r,type:e.type,size:Number(t.getPos()-r)})}else!function(t,e){const i=f.zy(u._l,e);t.writeUint32(i?12:8),t.writeUint32((0,d.A)(e)),i&&t.writeUint32(0)}(t,e.type)}))}function U(t,e,i){var a;const s=t.getPos();t.writeUint32(0),t.writeUint32((0,d.A)("moov")),l.A.mvhd(t,null,i),f.__(e.streams,(e=>{if(1024&e.disposition||1!==e.codecpar.codecType&&0!==e.codecpar.codecType&&3!==e.codecpar.codecType)return!0;const a=t.getPos();t.writeUint32(0),t.writeUint32((0,d.A)("trak")),b(t,i.fragment?p.Jl[e.codecpar.codecType](i,e):p.BB[e.codecpar.codecType](i,e),e,i);const r=e.metadata.title;if(r){const e=w.encode(r);t.writeUint32(16+e.length),t.writeUint32((0,d.A)("udta")),t.writeUint32(8+e.length),t.writeUint32((0,d.A)("name")),t.writeBuffer(e)}i.boxsPositionInfo.push({pos:a,type:"trak",size:Number(t.getPos()-a)})}));let n=t.getPos();if(t.writeUint32(0),t.writeUint32((0,d.A)("udta")),l.A.meta(t,null,i),null!==(a=i.chapters)&&void 0!==a&&a.length&&l.A.chpl(t,null,i),i.boxsPositionInfo.push({pos:n,type:"udta",size:Number(t.getPos()-n)}),i.fragment){const a=t.getPos();t.writeUint32(0),t.writeUint32((0,d.A)("mvex")),f.__(e.streams,(e=>{if(1024&e.disposition||1!==e.codecpar.codecType&&0!==e.codecpar.codecType&&3!==e.codecpar.codecType)return!0;l.A.trex(t,e,i)})),i.boxsPositionInfo.push({pos:a,type:"mvex",size:Number(t.getPos()-a)}),i.ignoreEncryption||function(t,e,i){const a=[];f.__(e.streams,(t=>{const e=(0,m.Un)(t.codecpar[o.o9]+20,t.codecpar[o.o9]+24,24);if(e){const t=(0,g.ZK)((0,k.s3)(c.f[20](e),c.f[25](e+4)));r()(t).call(t,(t=>{(function(t){if(!a.length)return!1;for(let e=0;e<a.length;e++){const i=a[e];if(!f.FB(i.systemId,t.systemId))return!1;if(!i.keyIds||!t.keyIds)return!1;if(i.keyIds.length!==t.keyIds.length)return!1;for(let e=0;e<i.keyIds.length;e++)if(!f.FB(i.keyIds[e],t.keyIds[e]))return!1;if(!f.FB(i.data,t.data))return!1}return!0})(t)||a.push(t)}))}})),a.length&&r()(a).call(a,(e=>{var a;const s=t.getPos();t.writeUint32(0),t.writeUint32((0,d.A)("pssh")),t.writeUint8(1),t.writeUint24(0),t.writeBuffer(e.systemId),t.writeUint32(e.keyIds.length),r()(a=e.keyIds).call(a,(e=>{t.writeBuffer(e)})),t.writeUint32(e.data.length),t.writeBuffer(e.data),i.boxsPositionInfo.push({pos:s,type:"pssh",size:Number(t.getPos()-s)})}))}(t,e,i)}i.boxsPositionInfo.push({pos:s,type:"moov",size:Number(t.getPos()-s)}),(0,h.A)(t,i)}function I(t,e,i){const a=t.getPos();t.writeUint32(0),t.writeUint32((0,d.A)("moof")),l.A.mfhd(t,null,i),f.__(i.currentFragment.tracks,(a=>{var r;if(!a.sampleCount)return!0;const s=t.getPos();t.writeUint32(0),t.writeUint32((0,d.A)("traf"));const o=n()(r=e.streams).call(r,(t=>t.privData.trackId===a.trackId));b(t,(0,p.Ip)(a),o,i),i.boxsPositionInfo.push({pos:s,type:"traf",size:Number(t.getPos()-s)})}));const r=Number(t.getPos()-a);i.boxsPositionInfo.push({pos:a,type:"moof",size:r}),i.currentFragment.size=r}function P(t,e,i){let a=24;f.__(i.currentFragment.tracks,(t=>{var i;const r=n()(i=e.streams).call(i,(e=>e.index===t.streamIndex)).privData;r.fragIndexes.length&&(a+=24+19*r.fragIndexes.length)})),t.writeUint32(a),t.writeString("mfra"),f.__(i.currentFragment.tracks,(i=>{var a;const s=n()(a=e.streams).call(a,(t=>t.index===i.streamIndex)).privData;var o;s.fragIndexes.length&&(t.writeUint32(24+19*s.fragIndexes.length),t.writeString("tfra"),t.writeUint8(1),t.writeUint24(0),t.writeUint32(i.trackId),t.writeUint32(0),t.writeUint32(s.fragIndexes.length),r()(o=s.fragIndexes).call(o,(e=>{t.writeUint64(e.time),t.writeUint64(e.pos),t.writeUint8(1),t.writeUint8(1),t.writeUint8(1)})))})),t.writeUint32(16),t.writeString("mfro"),t.writeUint32(0),t.writeUint32(a)}},61368:(t,e,i)=>{"use strict";i.d(e,{A:()=>r});var a=i(14686);function r(t,e,i){var r;t.writeUint32(8+(null!==(r=e.codecpar.extradataSize)&&void 0!==r?r:0)),t.writeString("av1C"),i.fragment&&e.sideData[1]?(t.writeBuffer(e.sideData[1]),delete e.sideData[1]):e.codecpar.extradata&&t.writeBuffer((0,a.s3)(e.codecpar.extradata,e.codecpar.extradataSize))}},17630:(t,e,i)=>{"use strict";i.d(e,{A:()=>n});var a=i(14686),r=i(60264),s=i(62815);function n(t,e,i){let n;i.fragment&&e.sideData[1]?(n=e.sideData[1],delete e.sideData[1]):e.codecpar.extradata&&(n=(0,a.s3)(e.codecpar.extradata,e.codecpar.extradataSize)),n&&r.Bs(n)&&(n=s.S1(n)),t.writeUint32(8+(n?n.length:0)),t.writeString("avcC"),n&&t.writeBuffer(n)}},90935:(t,e,i)=>{"use strict";function a(t,e,i){t.writeUint32(20),t.writeString("btrt"),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0)}i.d(e,{A:()=>a})},62336:(t,e,i)=>{"use strict";i.d(e,{A:()=>u});var a=i(86226),r=i.n(a),s=i(18979),n=i.n(s),o=i(67672),c=i(44328),d=i(50011);function u(t,e,i){const a=t.getPos();t.writeUint32(0),t.writeString("chpl"),t.writeUint32(16777216),t.writeUint32(0);const s=i.chapters;t.writeUint8(s.length),r()(s).call(s,(e=>{t.writeUint64((0,c.k)(e.start,e.timeBase,{num:1,den:1e7}));let i=e.metadata.title;if(i&&o.Yj(i)){let e=d.encode(i);e.length>255&&(e=n()(e).call(e,0,255)),t.writeUint8(e.length),t.writeBuffer(e)}else t.writeUint8(0)})),i.boxsPositionInfo.push({pos:a,type:"chpl",size:Number(t.getPos()-a)})}},78427:(t,e,i)=>{"use strict";function a(t,e,i){const a=e.privData.chunkOffsets||[];t.writeUint32(16+8*a.length),t.writeString("co64"),t.writeUint8(0),t.writeUint24(0),t.writeUint32(a.length);for(let e=0;e<a.length;e++)t.writeUint64(a[e])}i.d(e,{A:()=>a})},55707:(t,e,i)=>{"use strict";function a(t,e,i){const a=e.sideData[28];if(a)t.writeUint32(12+a.length),t.writeString("colr"),t.writeString("prof"),t.writeBuffer(a);else{const i=2===e.codecpar.colorRange;t.writeUint32(19),t.writeString("colr"),t.writeString("nclx"),t.writeUint16(e.codecpar.colorPrimaries),t.writeUint16(e.codecpar.colorTrc),t.writeUint16(e.codecpar.colorSpace),t.writeUint8(i?128:0)}}i.d(e,{A:()=>a})},613:(t,e,i)=>{"use strict";i.d(e,{A:()=>s});var a=i(4624);const r="src/avformat/formats/isobmff/writing/ctts.ts";function s(t,e,i){const s=e.privData,n=s.cttsSampleCounts||[],o=s.cttsSampleOffsets||[];n.length!==o.length&&a.R8("ctts sampleCounts's length is not match sampleOffsets's length",r,39);const c=Math.min(n.length,o.length);t.writeUint32(16+8*c),t.writeString("ctts"),t.writeUint8(1),t.writeUint24(0),t.writeUint32(c);for(let e=0;e<c;e++)t.writeUint32(n[e]),t.writeInt32(o[e])}},98522:(t,e,i)=>{"use strict";i.d(e,{A:()=>r});var a=i(83314);function r(t,e,i){t.writeUint32(11),t.writeString("dac3");const r=new a.A(3),s=i.ac3Info;r.writeU(2,s.substream[0].fscod),r.writeU(5,s.substream[0].bsid),r.writeU(3,s.substream[0].bsmod),r.writeU(3,s.substream[0].acmod),r.writeU(1,s.substream[0].lfeon),r.writeU(5,s.ac3BitrateCode),r.writeU(5,0),t.writeBuffer(r.getBuffer())}},47038:(t,e,i)=>{"use strict";i.d(e,{A:()=>r});var a=i(83314);function r(t,e,i){const r=i.ac3Info,s=new a.A(2+(34*(r.numIndSub+1)+7>>3));s.writeU(13,r.dataRate),s.writeU(3,r.numIndSub);for(let t=0;t<r.numIndSub;t++)s.writeU(2,r.substream[t].fscod),s.writeU(5,r.substream[t].bsid),s.writeU(1,0),s.writeU(1,0),s.writeU(3,r.substream[t].bsmod),s.writeU(3,r.substream[t].acmod),s.writeU(1,r.substream[t].lfeon),s.writeU(5,0),s.writeU(4,r.substream[t].numDepSub),r.substream[t].numDepSub?s.writeU(9,r.substream[t].chanLoc):s.writeU(1,0);s.padding();const n=s.getPointer();t.writeUint32(8+n),t.writeString("dec3"),t.writeBuffer(s.getBuffer().subarray(0,n))}},79142:(t,e,i)=>{"use strict";i.d(e,{A:()=>o});var a=i(14686),r=i(4624),s=i(14769);const n="src/avformat/formats/isobmff/writing/dfla.ts";function o(t,e,i){let o;i.fragment&&e.sideData[1]?(o=e.sideData[1],delete e.sideData[1]):e.codecpar.extradata&&(o=(0,a.s3)(e.codecpar.extradata,e.codecpar.extradataSize)),o&&o.length===s.ob?(t.writeUint32(o.length+16),t.writeString("dfLa"),t.writeUint8(0),t.writeUint24(0),t.writeUint8(128),t.writeUint24(o.length),t.writeBuffer(o)):r.z3("invalid extradata",n,57)}},6799:(t,e,i)=>{"use strict";i.d(e,{A:()=>s});var a=i(14686),r=i(31865);function s(t,e,i){let s;if(i.fragment&&e.sideData[1]?(s=e.sideData[1],delete e.sideData[1]):e.codecpar.extradata&&(s=(0,a.s3)(e.codecpar.extradata,e.codecpar.extradataSize)),!s||s.length<19)t.writeUint32(19),t.writeString("dOps"),t.writeUint8(0),t.writeUint8(e.codecpar.chLayout.nbChannels),t.writeUint16(e.codecpar.initialPadding),t.writeUint32(e.codecpar.sampleRate),t.writeUint16(0),t.writeUint8(0);else{const e=new r.A(s,!1);t.writeUint32(s.length),t.writeString("dOps"),t.writeUint8(0),e.seek(9),t.writeUint8(e.readUint8()),t.writeUint16(e.readUint16()),t.writeUint32(e.readUint32()),t.writeUint16(e.readUint16()),t.writeBuffer(s.subarray(18))}}},40222:(t,e,i)=>{"use strict";function a(t,e,i){t.writeUint32(28),t.writeString("dref"),t.writeUint32(0),t.writeUint32(1),t.writeUint32(12),t.writeString("url "),t.writeUint32(1)}i.d(e,{A:()=>a})},567:(t,e,i)=>{"use strict";i.d(e,{A:()=>n});var a=i(77231),r=i(44328),s=i(331);function n(t,e,i){const n=e.privData;let o=(0,r.k)((0,s.A)(n),e.timeBase,{den:i.timescale,num:1}),c=n.startCT;const d=(0,r.k)(n.startDts+BigInt(Math.floor(c)),e.timeBase,{den:i.timescale,num:1});let u=o<a.go?0:1;u|=d<a.go?0:1;const f=1+(d>0?1:0),l=24+f*(1===u?20:12);t.writeUint32(l),t.writeString("edts"),t.writeUint32(l-8),t.writeString("elst"),t.writeUint8(u),t.writeUint24(0),t.writeUint32(f),d>0?(1===u?(t.writeUint64(d),t.writeInt64(a.Dh)):(t.writeUint32(Number(d)),t.writeInt32(-1)),t.writeUint32(65536)):(c=-Math.min(Number(n.startDts),0),o+=d),i.fragment&&(o=BigInt(0)),1===u?(t.writeUint64(o),t.writeInt64(BigInt(Math.floor(c)))):(t.writeUint32(Number(o)),t.writeInt32(c)),t.writeUint32(65536)}},45086:(t,e,i)=>{"use strict";i.d(e,{A:()=>n});var a=i(54916),r=i(14686);function s(t,e,i){t.writeUint8(e);for(let e=3;e>0;e--)t.writeUint8(i>>7*e|128);t.writeUint8(127&i)}function n(t,e,i){const n=e.privData,o=e.codecpar.extradata?5+e.codecpar.extradataSize:0,c=t.getPos();t.writeUint32(0),t.writeString("esds"),t.writeUint32(0),s(t,3,21+o+5+1),t.writeUint16(n.trackId),t.writeUint8(0),s(t,4,13+o),(86016===e.codecpar.codecId||86017===e.codecpar.codecId)&&e.codecpar.sampleRate>24e3?t.writeUint8(107):t.writeUint8(a.zs[e.codecpar.codecId]),94208===e.codecpar.codecId?t.writeUint8(225):1===e.codecpar.codecType?t.writeUint8(21):t.writeUint8(17),t.writeUint24(0),t.writeUint32(0),t.writeUint32(0),e.codecpar.extradata&&(s(t,5,e.codecpar.extradataSize),t.writeBuffer((0,r.s3)(e.codecpar.extradata,e.codecpar.extradataSize))),s(t,6,1),t.writeUint8(2),i.boxsPositionInfo.push({pos:c,type:"esds",size:Number(t.getPos()-c)})}},75526:(t,e,i)=>{"use strict";function a(t,e,i,a,r,s,n){t.writeInt32(Math.floor(65536*e)),t.writeInt32(Math.floor(65536*i)),t.writeInt32(0),t.writeInt32(Math.floor(65536*a)),t.writeInt32(Math.floor(65536*r)),t.writeInt32(0),t.writeInt32(Math.floor(65536*s)),t.writeInt32(Math.floor(65536*n)),t.writeInt32(1073741824)}i.d(e,{A:()=>a})},95297:(t,e,i)=>{"use strict";function a(t,e,i){const a=t.getPos();t.writeUint32(0),t.writeString("hdlr"),t.writeUint8(0),t.writeUint24(0);let r="dhlr",s="url ",n="DataHandler";e&&(r="mhlr",1===e.codecpar.codecType?(s="soun",n="SoundHandler"):0===e.codecpar.codecType?(s="vide",n="VideoHandler"):3===e.codecpar.codecType?(s="text",n="SubtitleHandler"):(e.metadata.handlerName&&(n=e.metadata.handlerName),e.metadata.hdlrType&&(s=e.metadata.hdlrType))),t.writeString(r),t.writeString(s),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),e&&!i.isom||t.writeUint8(n.length),t.writeString(n),e&&!i.isom&&t.writeUint8(0),i.boxsPositionInfo.push({pos:a,type:"hdlr",size:Number(t.getPos()-a)})}i.d(e,{A:()=>a})},54219:(t,e,i)=>{"use strict";i.d(e,{A:()=>n});var a=i(14686),r=i(60264),s=i(67659);function n(t,e,i){let n;i.fragment&&e.sideData[1]?(n=e.sideData[1],delete e.sideData[1]):e.codecpar.extradata&&(n=(0,a.s3)(e.codecpar.extradata,e.codecpar.extradataSize)),n&&r.Bs(n)&&(n=s.S1(n)),t.writeUint32(8+(n?n.length:0)),t.writeString("hvcC"),n&&t.writeBuffer(n)}},49562:(t,e,i)=>{"use strict";i.d(e,{A:()=>n});var a=i(77231),r=i(331),s=i(67672);function n(t,e,i){const n=e.privData,o=(0,r.A)(n),c=e.metadata.creationTime||0,d=e.metadata.modificationTime||0;let u=21956,f=e.metadata.language;f&&s.Yj(f)&&f.length>=3&&(u=(f.charCodeAt(0)-96&31)<<10|(f.charCodeAt(1)-96&31)<<5|f.charCodeAt(2)-96&31);let l=o<BigInt(a.f7)?0:1;l=c<a.f7?0:1,l=d<a.f7?0:1,t.writeUint32(1===l?44:32),t.writeString("mdhd"),t.writeUint8(l),t.writeUint24(0),1===l?(t.writeUint64(c),t.writeUint64(d)):(t.writeUint32(Number(c)),t.writeUint32(Number(d))),t.writeUint32(e.timeBase.den),1===l?t.writeUint64(o):t.writeUint32(Number(o)),t.writeUint16(u),t.writeUint16(0)}},73746:(t,e,i)=>{"use strict";i.d(e,{A:()=>h});var a=i(73363),r=i.n(a),s=i(86226),n=i.n(s),o=i(18182),c=i.n(o),d=i(67672),u=i(96108),f=i(95335),l=i(65977),p=i(50011);function h(t,e,i){const a=t.getPos();t.writeUint32(0),t.writeString("meta"),t.writeUint32(0),t.writeUint32(33),t.writeString("hdlr"),t.writeUint32(0),t.writeString("dhlr"),t.writeString(i.useMetadataTags?"mdta":"mdir"),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint8(0);let s=[],o=[];const h=f.BE(u.c);function m(t){return i.useMetadataTags?(s.push(t),s.length):h[t]||4===t.length?(0,l.A)(h[t]||t):void 0}if(o.push({key:m("encoder"),value:"libmedia-v0.6.1-355-g72ba4aa7"}),i.covr&&o.push({key:m("covr"),value:i.covr.data,type:i.covr.type}),i.metadata&&f.__(i.metadata,((t,e)=>{if((d.Yj(t)||d.ai(t)||t instanceof Uint8Array)&&"encoder"!==e.toLocaleLowerCase()){let i=m(e);i&&o.push({key:i,value:t})}})),s.length&&(t.writeUint32(16+r()(s).call(s,((t,e)=>t+(8+e.length)),0)),t.writeString("keys"),t.writeUint32(0),t.writeUint32(s.length),n()(s).call(s,(e=>{t.writeUint32(e.length+8),t.writeString("mdta"),t.writeString(e)}))),o.length){const e=t.getPos();t.writeUint32(0),t.writeString("ilst"),n()(o).call(o,(e=>{let i,a=0,r=0;if(d.ai(e.value))a=c()(e.value)===e.value?e.value<0?21:22:23,r=4;else if(e.value instanceof Uint8Array){var s;a=null!==(s=e.type)&&void 0!==s?s:0,r=e.value.length}else{if(!d.Yj(e.value))return;a=1,i=p.encode(e.value),r=i.length}t.writeUint32(24+r),t.writeUint32(e.key),t.writeUint32(16+r),t.writeString("data"),t.writeUint32(a),t.writeUint32(0),0===a||e.value instanceof Uint8Array?t.writeBuffer(e.value):1===a?t.writeBuffer(i):21===a?t.writeInt32(e.value):22===a?t.writeUint32(e.value):23===a&&t.writeFloat(e.value)})),i.boxsPositionInfo.push({pos:e,type:"ilst",size:Number(t.getPos()-e)})}i.boxsPositionInfo.push({pos:a,type:"meta",size:Number(t.getPos()-a)})}},24432:(t,e,i)=>{"use strict";function a(t,e,i){t.writeUint32(16),t.writeString("mfhd"),t.writeUint8(0),t.writeUint24(0),t.writeUint32(i.currentFragment.sequence)}i.d(e,{A:()=>a})},42259:(t,e,i)=>{"use strict";i.d(e,{A:()=>r});var a=i(95297);function r(t,e,i){(0,a.A)(t,null,i)}},75456:(t,e,i)=>{"use strict";i.d(e,{A:()=>s});var a=i(77231),r=i(75526);function s(t,e,i){const s=i.duration,n=i.creationTime||0,o=i.modificationTime||0,c=i.timescale||0;let d=i.nextTrackId||1;i.fragment&&(d=2);let u=s<BigInt(a.f7)?0:1;u=n<a.f7?0:1,u=o<a.f7?0:1,t.writeUint32(1===u?120:108),t.writeString("mvhd"),t.writeUint8(u),t.writeUint24(0),1===u?(t.writeUint64(n),t.writeUint64(o)):(t.writeUint32(Number(n)),t.writeUint32(Number(o))),t.writeUint32(c),1===u?t.writeUint64(s):t.writeUint32(Number(s)),t.writeUint32(65536),t.writeUint16(256),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),(0,r.A)(t,1,0,0,1,0,0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(d)}},97882:(t,e,i)=>{"use strict";function a(t,e,i){t.writeUint32(12),t.writeString("nmhd"),t.writeUint32(0)}i.d(e,{A:()=>a})},10211:(t,e,i)=>{"use strict";function a(t,e,i){t.writeUint32(16),t.writeString("pasp"),t.writeUint32(1),t.writeUint32(1)}i.d(e,{A:()=>a})},19755:(t,e,i)=>{"use strict";i.d(e,{A:()=>s});var a=i(71426),r=i.n(a);function s(t,e,i){var a;const s=r()(a=i.currentFragment.tracks).call(a,(t=>t.trackId===e.privData.trackId));t.writeUint32(20),t.writeString("saio"),t.writeUint32(0),t.writeUint32(1),s.cenc.offsetPos=t.getPos(),t.writeUint32(0)}},2192:(t,e,i)=>{"use strict";i.d(e,{A:()=>o});var a=i(71426),r=i.n(a),s=i(86226),n=i.n(s);function o(t,e,i){var a;const s=r()(a=i.currentFragment.tracks).call(a,(t=>t.trackId===e.privData.trackId)),o=t.getPos();var c;t.writeUint32(0),t.writeString("saiz"),t.writeUint32(0),t.writeUint8(s.cenc.sampleSizes.length?0:s.cenc.defaultSampleInfoSize),t.writeUint32(s.cenc.sampleCount),s.cenc.sampleSizes.length&&n()(c=s.cenc.sampleSizes).call(c,(e=>{t.writeUint8(e)})),i.boxsPositionInfo.push({pos:o,type:"saiz",size:Number(t.getPos()-o)})}},69856:(t,e,i)=>{"use strict";i.d(e,{A:()=>o});var a=i(71426),r=i.n(a),s=i(86226),n=i.n(s);function o(t,e,i){var a,s;const o=r()(a=i.currentFragment.tracks).call(a,(t=>t.trackId===e.privData.trackId)),c=i.cencs?i.cencs[o.trackId]:null,d=t.getPos();t.writeUint32(0),t.writeString("senc"),t.writeUint32(o.cenc.useSubsamples?2:0),t.writeUint32(o.cenc.sampleEncryption.length),o.cenc.offset=Number(t.getPos()-i.currentFragment.pos),n()(s=o.cenc.sampleEncryption).call(s,(e=>{var i;c.defaultPerSampleIVSize&&t.writeBuffer(e.iv),o.cenc.useSubsamples&&(t.writeUint16(e.subsamples.length),n()(i=e.subsamples).call(i,(e=>{t.writeUint16(e.bytesOfClearData),t.writeUint32(e.bytesOfProtectedData)})))})),i.boxsPositionInfo.push({pos:d,type:"senc",size:Number(t.getPos()-d)})}},96451:(t,e,i)=>{"use strict";function a(t,e,i){t.writeUint32(16),t.writeString("smhd"),t.writeUint32(0),t.writeUint16(0),t.writeUint16(0)}i.d(e,{A:()=>a})},51554:(t,e,i)=>{"use strict";function a(t,e,i){const a=e.privData.chunkOffsets||[];t.writeUint32(16+4*a.length),t.writeString("stco"),t.writeUint8(0),t.writeUint24(0),t.writeUint32(a.length);for(let e=0;e<a.length;e++)t.writeUint32(Number(a[e]))}i.d(e,{A:()=>a})},48068:(t,e,i)=>{"use strict";function a(t,e,i){t.writeUint32(12),t.writeString("sthd"),t.writeUint32(0)}i.d(e,{A:()=>a})},96598:(t,e,i)=>{"use strict";i.d(e,{A:()=>s});var a=i(4624);const r="src/avformat/formats/isobmff/writing/stsc.ts";function s(t,e,i){const s=e.privData,n=s.stscFirstChunk,o=s.stscSamplesPerChunk,c=s.stscSampleDescriptionIndex;n.length===o.length&&n.length===c.length||a.R8("ctts firstChunk's length is not match samplesPerChunk's length or sampleDescriptionIndex's length",r,42);const d=Math.min(n.length,o.length,c.length);t.writeUint32(16+12*d),t.writeString("stsc"),t.writeUint8(0),t.writeUint24(0),t.writeUint32(d);for(let e=0;e<d;e++)t.writeUint32(n[e]),t.writeUint32(o[e]),t.writeUint32(c[e])}},14159:(t,e,i)=>{"use strict";i.d(e,{A:()=>T});var a=i(18979),r=i.n(a),s=i(17630),n=i(54219),o=i(85121),c=i(40695),d=i(61368),u=i(79142),f=i(6799),l=i(45086),p=i(55707),h=i(10211),m=i(90935),g=i(63030),k=i(98522),w=i(47038),v=i(14686),b=i(61619),U=i(65977);const I={27:"avc1",173:"hvc1",196:"vvc1",225:"av01",167:"vp09",86019:"ac-3",86056:"ec-3",94226:"wvtt",94232:"stpp",94213:"tx3g"};function P(t){if(t.codecTag)return(0,b.A)(t.codecTag);let e=I[t.codecId];return e||(e=0===t.codecType?"mp4v":1===t.codecType?86076===t.codecId?"Opus":86028===t.codecId?"fLaC":"mp4a":3===t.codecType?"text":"none"),e}function y(t,e,i){const a=e.privData,r=i.cencs[a.trackId],s=t.getPos();t.writeUint32(0),t.writeString("sinf"),t.writeUint32(12),t.writeString("frma"),t.writeString(P(e.codecpar)),t.writeUint32(20),t.writeString("schm"),t.writeUint32(0),t.writeUint32(r.schemeType||(0,U.A)("cenc")),t.writeUint32(r.schemeVersion||65536),t.writeUint32(16+r.defaultKeyId.length+8+(r.defaultConstantIV?1+r.defaultConstantIV.length:0)),t.writeString("schi"),t.writeUint32(16+r.defaultKeyId.length+(r.defaultConstantIV?1+r.defaultConstantIV.length:0)),t.writeString("tenc"),r.cryptByteBlock||r.skipByteBlock||r.pattern?t.writeUint8(1):t.writeUint8(0),t.writeUint24(0),t.writeUint8(0),t.writeUint8((15&(r.cryptByteBlock||0))<<4|15&(r.skipByteBlock||0)),t.writeUint8(1),t.writeUint8(r.defaultPerSampleIVSize),t.writeBuffer(r.defaultKeyId),r.defaultConstantIV&&(t.writeUint8(r.defaultConstantIV.length),t.writeBuffer(r.defaultConstantIV)),i.boxsPositionInfo.push({pos:s,type:"sinf",size:Number(t.getPos()-s)})}function S(t,e,i){const a=i.isom?1:0;t.writeUint32(0),t.writeUint16(0),t.writeUint16(1),t.writeUint16(a),t.writeUint16(0),t.writeUint32(0),i.isom?(t.writeUint16(e.codecpar.chLayout.nbChannels),65541===e.codecpar.codecId||65540===e.codecpar.codecId?t.writeUint16(8):69643===e.codecpar.codecId?t.writeUint16(e.codecpar.bitsPerCodedSample):t.writeUint16(16),t.writeUint16(-2)):(86028===e.codecpar.codecId||86032===e.codecpar.codecId||86076===e.codecpar.codecId?t.writeUint16(e.codecpar.chLayout.nbChannels):t.writeUint16(2),86028===e.codecpar.codecId||86032===e.codecpar.codecId?t.writeUint16(e.codecpar.bitsPerRawSample):t.writeUint16(16),t.writeUint16(0)),t.writeUint16(0),86076===e.codecpar.codecId?t.writeUint16(48e3):86060===e.codecpar.codecId?t.writeUint32(e.codecpar.sampleRate):t.writeUint16(e.codecpar.sampleRate),86060!==e.codecpar.codecId&&t.writeUint16(0),1===a&&(t.writeUint32(e.codecpar.frameSize),t.writeUint32(0),t.writeUint32(0),t.writeUint32(2))}function A(t,e,i){const a=P(e.codecpar);!i.isom||86018!==e.codecpar.codecId&&86019!==e.codecpar.codecId&&86056!==e.codecpar.codecId&&73728!==e.codecpar.codecId&&86032!==e.codecpar.codecId&&69638!==e.codecpar.codecId&&69633!==e.codecpar.codecId&&86035!==e.codecpar.codecId?86028===e.codecpar.codecId?(0,u.A)(t,e,i):86076===e.codecpar.codecId?(0,f.A)(t,e,i):86019===e.codecpar.codecId?(0,k.A)(t,e,i):86056===e.codecpar.codecId?(0,w.A)(t,e,i):"mp4a"==a&&(0,l.A)(t,e,i):(0,g.A)(t,e,i)}function B(t,e,i){const a=13==e.codecpar.codecId&&15==e.codecpar.format||13==e.codecpar.codecId&&1==e.codecpar.format||202==e.codecpar.codecId||203==e.codecpar.codecId||156==e.codecpar.codecId||127==e.codecpar.codecId;t.writeUint32(0),t.writeUint16(0),t.writeUint16(1),t.writeUint16(a?2:0),t.writeUint16(0),i.isom?(t.writeString("FFMP"),13===e.codecpar.codecId||a?(t.writeUint32(0),t.writeUint32(1024)):(t.writeUint32(512),t.writeUint32(512))):(t.writeUint32(0),t.writeUint32(0),t.writeUint32(0)),t.writeUint16(e.codecpar.width),t.writeUint16(e.codecpar.height),t.writeUint32(4718592),t.writeUint32(4718592),t.writeUint32(0),t.writeUint16(1);let s=e.metadata.compressorName||"";if(s=r()(s).call(s,0,31),t.writeUint8(s.length),t.writeString(s),s.length<31){let e=31-s.length;for(;e>0;)t.writeUint8(0),e--}i.isom&&e.codecpar.bitsPerCodedSample?t.writeUint16(e.codecpar.bitsPerCodedSample):t.writeUint16(24),t.writeUint16(65535)}function x(t,e,i){"mp4v"===P(e.codecpar)?(0,l.A)(t,e,i):27===e.codecpar.codecId?(0,s.A)(t,e,i):173===e.codecpar.codecId?(0,n.A)(t,e,i):196===e.codecpar.codecId?(0,o.A)(t,e,i):167===e.codecpar.codecId?(0,c.A)(t,e,i):225===e.codecpar.codecId&&(0,d.A)(t,e,i)}function T(t,e,i){const a=t.getPos();t.writeUint32(0),t.writeString("stsd");const r=e.privData,s=i.cencs&&i.cencs[r.trackId]&&(1===e.codecpar.codecType||0===e.codecpar.codecType)&&!i.ignoreEncryption;t.writeUint8(0),t.writeUint24(0),t.writeUint32(s?2:1),1===e.codecpar.codecType?(s&&function(t,e,i){const a=t.getPos();t.writeUint32(0),t.writeString("enca"),S(t,e,i),y(t,e,i),A(t,e,i),i.boxsPositionInfo.push({pos:a,type:"enca",size:Number(t.getPos()-a)})}(t,e,i),function(t,e,i){const a=t.getPos(),r=P(e.codecpar);t.writeUint32(0),t.writeString(r),S(t,e,i),A(t,e,i),i.isom||(0,m.A)(t,e,i),i.boxsPositionInfo.push({pos:a,type:r,size:Number(t.getPos()-a)})}(t,e,i)):0===e.codecpar.codecType?(s&&function(t,e,i){const a=t.getPos();t.writeUint32(0),t.writeString("encv"),B(t,e,i),y(t,e,i),x(t,e,i),i.boxsPositionInfo.push({pos:a,type:"encv",size:Number(t.getPos()-a)})}(t,e,i),function(t,e,i){const a=t.getPos(),r=P(e.codecpar);t.writeUint32(0),t.writeString(r),B(t,e,i),x(t,e,i),(0,p.A)(t,e,i),(0,h.A)(t,e,i),i.isom||(0,m.A)(t,e,i),i.boxsPositionInfo.push({pos:a,type:r,size:Number(t.getPos()-a)})}(t,e,i)):3===e.codecpar.codecType&&function(t,e,i){const a=t.getPos(),r=P(e.codecpar);t.writeUint32(0),t.writeString(r),t.writeUint32(0),t.writeUint16(0),t.writeUint16(1),94208===e.codecpar.codecId?(0,l.A)(t,e,i):e.codecpar.extradata&&t.writeBuffer((0,v.s3)(e.codecpar.extradata,e.codecpar.extradataSize)),i.isom||(0,m.A)(t,e,i),i.boxsPositionInfo.push({pos:a,type:r,size:Number(t.getPos()-a)})}(t,e,i),i.boxsPositionInfo.push({pos:a,type:"esds",size:Number(t.getPos()-a)})}},32422:(t,e,i)=>{"use strict";function a(t,e,i){const a=e.privData.stssSampleNumbers;t.writeUint32(16+4*a.length),t.writeString("stss"),t.writeUint8(0),t.writeUint24(0),t.writeUint32(a.length);for(let e=0;e<a.length;e++)t.writeUint32(a[e])}i.d(e,{A:()=>a})},44485:(t,e,i)=>{"use strict";function a(t,e,i){const a=e.privData.sampleSizes;t.writeUint32(20+4*a.length),t.writeString("stsz"),t.writeUint8(0),t.writeUint24(0),t.writeUint32(0),t.writeUint32(a.length);for(let e=0;e<a.length;e++)t.writeUint32(a[e])}i.d(e,{A:()=>a})},16181:(t,e,i)=>{"use strict";i.d(e,{A:()=>s});var a=i(4624);const r="src/avformat/formats/isobmff/writing/stts.ts";function s(t,e,i){const s=e.privData,n=s.sttsSampleCounts||[],o=s.sttsSampleDeltas||[];n.length!==o.length&&a.R8("stts sampleCounts's length is not match sampleDeltas's length",r,39);const c=Math.min(n.length,o.length);t.writeUint32(16+8*c),t.writeString("stts"),t.writeUint8(0),t.writeUint24(0),t.writeUint32(c);for(let e=0;e<c;e++)t.writeUint32(n[e]),t.writeInt32(o[e])}},92777:(t,e,i)=>{"use strict";i.d(e,{A:()=>s});var a=i(71426),r=i.n(a);function s(t,e,i){var a;const s=r()(a=i.currentFragment.tracks).call(a,(t=>t.trackId===e.privData.trackId)),n=s?s.baseMediaDecodeTime:BigInt(0);t.writeUint32(20),t.writeString("tfdt"),t.writeUint8(1),t.writeUint24(0),t.writeUint64(n)}},48933:(t,e,i)=>{"use strict";i.d(e,{A:()=>s});var a=i(71426),r=i.n(a);function s(t,e,i){var a;const s=r()(a=i.currentFragment.tracks).call(a,(t=>t.trackId===e.privData.trackId));let n=57;s.baseIsMoof&&(n&=-2,n|=131072);const o=t.getPos();t.writeUint32(0),t.writeString("tfhd"),t.writeUint8(0),t.writeUint24(n),t.writeUint32(s.trackId),1&n&&t.writeUint64(s.baseDataOffset),8&n&&t.writeUint32(s.defaultSampleDuration),16&n&&t.writeUint32(s.defaultSampleSize),32&n&&t.writeUint32(s.defaultSampleFlags),i.boxsPositionInfo.push({pos:o,type:"tfhd",size:Number(t.getPos()-o)})}},95314:(t,e,i)=>{"use strict";i.d(e,{A:()=>d});var a=i(52730),r=i.n(a),s=i(77231),n=i(75526),o=i(44328),c=i(331);function d(t,e,i){const a=e.privData,d=(0,o.k)((0,c.A)(a),e.timeBase,{den:i.timescale,num:1}),u=e.metadata.creationTime||0,f=e.metadata.modificationTime||0,l=a.layer||0,p=a.alternateGroup||0;let h=e.codecpar.width>0?e.codecpar.width:0,m=e.codecpar.height>0?e.codecpar.height:0;const g=(0,o.lb)(e.codecpar.sampleAspectRatio);0!==g&&g!==1/0&&(h=Math.floor(h*g)),h<s.zg&&(h<<=16),m<s.zg&&(m<<=16);let k=d<BigInt(s.f7)?0:1;k=u<s.f7?0:1,k=f<s.f7?0:1;let w=2;1&r()(a)&&(w|=1),t.writeUint32(1===k?100:92),t.writeString("tkhd"),t.writeUint8(k),t.writeUint24(w),1===k?(t.writeUint64(u),t.writeUint64(f)):(t.writeUint32(Number(u)),t.writeUint32(Number(f))),t.writeUint32(a.trackId),t.writeUint32(0),1===k?t.writeUint64(d):t.writeUint32(Number(d)),t.writeUint32(0),t.writeUint32(0),t.writeInt16(l),t.writeInt16(a.perStreamGrouping?p:e.codecpar.codecType),1===e.codecpar.codecType?t.writeInt16(256):t.writeInt16(0),t.writeInt16(0);const v=e.metadata.matrix;v?(0,n.A)(t,v[0],v[1],v[3],v[4],v[6],v[7]):(0,n.A)(t,1,0,0,1,0,0),t.writeUint32(h),t.writeUint32(m)}},79232:(t,e,i)=>{"use strict";i.d(e,{A:()=>o});var a=i(71426),r=i.n(a),s=i(52730),n=i.n(s);function o(t,e,i){var a,s,o,c,d,u;const f=r()(a=i.currentFragment.tracks).call(a,(t=>t.trackId===e.privData.trackId)),l=r()(s=i.trexs).call(s,(t=>{t.trackId,e.privData.trackId})),p=null!==(o=null==l?void 0:l.duration)&&void 0!==o?o:0,h=null!==(c=null==l?void 0:l.size)&&void 0!==c?c:0,m=null!==(d=null==(u=l)?void 0:n()(u))&&void 0!==d?d:0;t.writeUint32(32),t.writeString("trex"),t.writeUint8(0),t.writeUint24(0),t.writeUint32(f.trackId),t.writeUint32(1),t.writeUint32(p),t.writeUint32(h),t.writeUint32(m)}},81206:(t,e,i)=>{"use strict";i.d(e,{A:()=>s});var a=i(71426),r=i.n(a);function s(t,e,i){var a;const s=e.privData,n=r()(a=i.currentFragment.tracks).call(a,(t=>t.trackId===s.trackId)),o=n.firstSampleFlags||0,c=n.dataOffset||0,d=n.sampleDurations,u=n.sampleSizes,f=n.sampleFlags,l=n.sampleCompositionTimeOffset,p=n.sampleCount,h=d.length>0,m=u.length>0,g=f.length>0,k=l.length>0,w=0!==o;let v=1;w&&(v|=4),h&&(v|=256),m&&(v|=512),g&&(v|=1024),k&&(v|=2048);const b=t.getPos();t.writeUint32(0),t.writeString("trun"),t.writeUint8(1),t.writeUint24(v),t.writeUint32(p),n.dataOffsetPos=t.getPos(),t.writeInt32(c),w&&t.writeUint32(o);for(let e=0;e<p;e++)h&&t.writeUint32(d[e]||0),m&&t.writeUint32(u[e]||0),g&&t.writeUint32(f[e]||0),k&&t.writeInt32(l[e]||0);i.boxsPositionInfo.push({pos:b,type:"trun",size:Number(t.getPos()-b)})}},25362:(t,e,i)=>{"use strict";function a(t,e,i){t.writeUint32(20),t.writeString("vmhd"),t.writeUint8(0),t.writeUint24(1),t.writeUint64(BigInt(0))}i.d(e,{A:()=>a})},40695:(t,e,i)=>{"use strict";i.d(e,{A:()=>r});var a=i(14686);function r(t,e,i){var r;t.writeUint32(12+(null!==(r=e.codecpar.extradataSize)&&void 0!==r?r:0)),t.writeString("vpcC"),t.writeUint8(1),t.writeUint24(0),i.fragment&&e.sideData[1]?(t.writeBuffer(e.sideData[1]),delete e.sideData[1]):e.codecpar.extradata&&t.writeBuffer((0,a.s3)(e.codecpar.extradata,e.codecpar.extradataSize))}},85121:(t,e,i)=>{"use strict";i.d(e,{A:()=>n});var a=i(14686),r=i(60264),s=i(59166);function n(t,e,i){let n;i.fragment&&e.sideData[1]?(n=e.sideData[1],delete e.sideData[1]):e.codecpar.extradata&&(n=(0,a.s3)(e.codecpar.extradata,e.codecpar.extradataSize)),n&&r.Bs(n)&&(n=s.S1(n)),t.writeUint32(12+(n?n.length:0)),t.writeString("vvcC"),t.writeUint8(0),t.writeUint24(0),n&&t.writeBuffer(n)}},63030:(t,e,i)=>{"use strict";i.d(e,{A:()=>s});var a=i(14686),r=i(45086);function s(t,e,i){const s=t.getPos();t.writeUint32(0),t.writeString("wave"),86035!==e.codecpar.codecId&&(t.writeUint32(12),t.writeString("frma"),t.writeUint32(e.codecpar.codecTag)),86018===e.codecpar.codecId?(t.writeUint32(12),t.writeString("mp4a"),t.writeUint32(0),(0,r.A)(t,e,i)):i.fragment&&e.sideData[1]?(t.writeBuffer(e.sideData[1]),delete e.sideData[1]):e.codecpar.extradata&&t.writeBuffer((0,a.s3)(e.codecpar.extradata,e.codecpar.extradataSize)),t.writeUint32(8),t.writeUint32(0),i.boxsPositionInfo.push({pos:s,type:"wave",size:Number(t.getPos()-s)})}},7543:(t,e,i)=>{"use strict";i.d(e,{A:()=>M});var a=i(16181),r=i(613),s=i(32422),n=i(44485),o=i(96598),c=i(51554),d=i(78427),u=i(49562),f=i(75456),l=i(95314),p=i(95297),h=i(14159),m=i(25362),g=i(567),k=i(96451),w=i(97882),v=i(48068),b=i(40222),U=i(79232),I=i(24432),P=i(48933),y=i(92777),S=i(81206),A=i(42259),B=i(2192),x=i(19755),T=i(69856),D=i(73746),C=i(62336);const M={stts:a.A,ctts:r.A,stss:s.A,stsz:n.A,stsc:o.A,stco:c.A,co64:d.A,mdhd:u.A,mvhd:f.A,tkhd:l.A,hdlr:p.A,stsd:h.A,vmhd:m.A,edts:g.A,smhd:k.A,nmhd:w.A,sthd:v.A,dref:b.A,trex:U.A,mfhd:I.A,tfhd:P.A,tfdt:y.A,trun:S.A,minf_hdlr:A.A,saio:x.A,saiz:B.A,senc:T.A,meta:D.A,chpl:C.A}},59989:(t,e,i)=>{"use strict";function a(t,e=0){if(!t)return!1;if(t.length<2)return!0;let i=t[e],a=e+1;for(;a<t.length&&i===t[a];a++);return a===t.length}i.d(e,{A:()=>a})},20841:(t,e,i)=>{"use strict";function a(t,e,i,a){const r=t.getPos(),s=t.getPointer(),n=r-BigInt(Math.floor(s));let o=!1;switch(e<r&&e>=n?(t.seekInline(s+Number(e-r)),o=!0):t.seek(e),a){case"uint8":t.writeUint8(255&i);break;case"int8":t.writeInt8(i);break;case"uint16":t.writeUint16(65535&i);break;case"int16":t.writeInt16(i);break;case"uint32":t.writeUint32(i>>>0);break;case"int32":t.writeInt32(i);break;case"uint64":t.writeUint64(BigInt.asUintN(64,i));break;case"int64":t.writeInt64(i);break;case"float":t.writeFloat(i);break;case"double":t.writeDouble(i)}o?t.seekInline(s):t.seek(r)}i.d(e,{A:()=>a})},92174:(t,e,i)=>{"use strict";i.d(e,{XA:()=>w,bX:()=>b,bx:()=>k,dJ:()=>v,ho:()=>g});var a=i(74707),r=i.n(a),s=i(63939),n=i(50932),o=i(95335),c=i(4624),d=i(72739),u=i(9705),f=i(548),l=i(77231),p=i(43607);const h="src/avformat/mux.ts",m={zeroStart:!1,nonnegative:!1};function g(t,e={}){const i=o.X$({},m,e);t.ioWriter||c.h2("need ioWriter",h,58),t.oformat||c.h2("need oformat",h,61),t.options=i,t.privateData2={firstPts:new(r()),firstDts:new(r()),dtsPtsDelta:new(r())};let a=t.oformat.getCapabilities();if(a)for(let e=0;e<t.streams.length;e++){if(1024&t.streams[e].disposition)continue;const i=t.streams[e].codecpar.codecId,r=t.streams[e].codecpar.codecType;if(16===t.oformat.type){if(i<65536||i>69683)return c.z3(`format ${(0,f.L_)(t.oformat.type)} not support codecId ${(0,f.eG)(t.streams[e].codecpar.codecType,i)}`,h,83),u.r8}else if(2!==r&&4!==r&&!d.zy(a,i))return c.z3(`format ${(0,f.L_)(t.oformat.type)} not support codecId ${(0,f.eG)(t.streams[e].codecpar.codecType,i)}`,h,91),u.r8}return t.oformat.init(t)}function k(t){return t.oformat.writeHeader(t),0}function w(t,e){const i=t.privateData2;return i.firstDts.has(s.f[15](e+32))||i.firstDts.set(s.f[15](e+32),s.f[17](e+16)===l.Dh?BigInt(0):s.f[17](e+16)),i.firstPts.has(s.f[15](e+32))||(i.firstPts.set(s.f[15](e+32),s.f[17](e+8)===l.Dh?BigInt(0):s.f[17](e+8)),i.dtsPtsDelta.set(s.f[15](e+32),p.jk(i.firstDts.get(s.f[15](e+32)),i.firstPts.get(s.f[15](e+32))))),(t.options.zeroStart||t.options.nonnegative&&(i.firstDts.get(s.f[15](e+32))<0||i.firstPts.get(s.f[15](e+32))<0))&&(n.M[17](e+16,s.f[17](e+16)-i.dtsPtsDelta.get(s.f[15](e+32))),n.M[17](e+8,s.f[17](e+8)-i.dtsPtsDelta.get(s.f[15](e+32)))),t.oformat.writeAVPacket(t,e)}function v(t){return t.oformat.writeTrailer(t),0}function b(t){t.oformat.flush(t)}},25115:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>Z});var a=i(18979),r=i.n(a),s=i(61240),n=i.n(s),o=i(64007),c=i.n(o),d=i(86226),u=i.n(d),f=i(14686),l=i(61499),p=i(63939),h=i(9599),m=i(29170),g=i(50932),k=i(12264),w=i(44315),v=i(44527),b=i(9705),U=i(84149),I=i(4624),P=i(35336),y=i(92174),S=i(92695),A=(i(77162),i(71766)),B=i(39148),x=i(60120),T=i(84290),D=i(77231),C=i(44328),M=i(86932),z=i(85224),E=i(10333),F=i(22343),N=i(71517),R=i(37837),O=i(86834),Q=i(85103),W=i(13724),_=i(43607),V=i(65977),q=i(76750),L=i(39381),$=i(62815),Y=i(67659),K=i(71762),X=i(72703),H=i(67672),G=i(44690),j=i(38724);const J="src/avplayer/mse/MSEPipeline.ts";class Z extends v.A{constructor(){super()}async syncToKeyframe(t){let e=!0;if(t.video){let a;for(;;){if(t.video.backPacket=await this.pullAVPacket(t.video,t),t.video.backPacket<0){t.video.packetEnded=!0,t.video.backPacket=0;break}if(t.audio&&!t.audio.packetEnded&&(!t.audio.backPacket||(0,C.Mr)(p.f[17](t.audio.backPacket+8),t.audio.backPacket+72,D.i0)<(0,C.Mr)(p.f[17](t.video.backPacket+8),t.video.backPacket+72,D.i0)))for(;;){if(t.audio.backPacket>0){const e=(0,N.rU)(t.audio.backPacket,1);var i;e&&(a=r()(i=(0,f.s3)(p.f[20](e),p.f[25](e+4))).call(i)),t.avpacketPool.release(t.audio.backPacket)}if(t.audio.backPacket=await this.pullAVPacket(t.audio,t),t.audio.backPacket<0){t.audio.packetEnded=!0,t.audio.backPacket=0;break}if((0,C.Mr)(p.f[17](t.audio.backPacket+8),t.audio.backPacket+72,D.i0)>(0,C.Mr)(p.f[17](t.video.backPacket+8),t.video.backPacket+72,D.i0))break}if(1&p.f[15](t.video.backPacket+36)||27===p.f[15](t.video.codecpar+4)&&$.KD(t.video.backPacket,p.f[20](t.video.codecpar+12)?1+(3&L.r8(p.f[20](t.video.codecpar+12)+4)):4)||173===p.f[15](t.video.codecpar+4)&&Y.KD(t.video.backPacket,p.f[20](t.video.codecpar+12)?1+(3&L.r8(p.f[20](t.video.codecpar+12)+21)):4))break;e=!1,t.avpacketPool.release(t.video.backPacket)}if(t.audio&&t.audio.backPacket&&!(0,N.fQ)(t.audio.backPacket,1)&&a){const e=(0,R.sY)(a.length);(0,f.lW)(e,a.length,a),(0,N.Ow)(t.audio.backPacket,1,e,a.length)}}return e}getSourceOpenHandler(t,e=BigInt(0)){return async()=>{var i,a;await this.syncToKeyframe(t);let r=e,s=e;if(!t.audio||t.audio.backPacket||t.audio.packetEnded||(t.audio.backPacket=await this.pullAVPacket(t.audio,t),t.audio.backPacket<0&&(t.audio.packetEnded=!0,t.audio.backPacket=0)),t.video&&!t.video.backPacket&&t.video.packetEnded&&(t.video.backPacket=await this.pullAVPacket(t.video,t),t.video.backPacket<0&&(t.video.packetEnded=!0,t.video.backPacket=0)),(null===(i=t.audio)||void 0===i?void 0:i.backPacket)>0&&(r=_.T9(r,(0,C.Mr)(p.f[17](t.audio.backPacket+16),t.audio.backPacket+72,D.i0))),(null===(a=t.video)||void 0===a?void 0:a.backPacket)>0&&(s=_.T9(s,(0,C.Mr)(p.f[17](t.video.backPacket+16),t.video.backPacket+72,D.i0))),t.audio&&t.video&&_.tn(r-s)>1e3)if(s>r){const e=(0,C.k)(r,D.i0,(0,m.A)(t.video.backPacket+72,h.P));g.M[17](t.video.backPacket+48,p.f[17](t.video.backPacket+16)-e),g.M[17](t.video.backPacket+16,e),g.M[17](t.video.backPacket+8,e),s=r}else if(r>s&&86018===t.audio.oformatContext.streams[0].codecpar.codecId&&2===t.audio.oformatContext.streams[0].codecpar.profile&&t.audio.oformatContext.streams[0].codecpar.chLayout.nbChannels<3){const e=t.avpacketPool.alloc();(0,N.rN)(e,t.audio.backPacket);const i=1===t.audio.oformatContext.streams[0].codecpar.chLayout.nbChannels?new Uint8Array([0,200,0,128,35,128]):new Uint8Array([33,0,73,144,2,25,0,35,128]),a=(0,R.sY)(i.length);(0,f.lW)(a,i.length,i),(0,N.NX)(e,a,i.length),g.M[17](e+16,(0,C.k)(s,D.i0,(0,m.A)(e+72,h.P))),g.M[17](e+8,(0,C.k)(s,D.i0,(0,m.A)(e+72,h.P)));const n=BigInt(1024e3)/BigInt(0|t.audio.oformatContext.streams[0].codecpar.sampleRate),o=Number(BigInt.asIntN(32,(r-s)/n));let c=p.f[17](e+16)+(0,C.k)(n,D.i0,(0,m.A)(t.audio.backPacket+72,h.P));for(let i=0;i<o-1;i++){const i=t.avpacketPool.alloc();(0,N.rN)(i,e),g.M[17](i+16,c),g.M[17](i+8,c),t.audio.pullQueue.queue.push(i),c+=(0,C.k)(n,D.i0,(0,m.A)(t.audio.backPacket+72,h.P))}t.audio.pullQueue.queue.push(t.audio.backPacket),t.audio.backPacket=e,r=s}const o=[];t.audio&&(t.audio.track.setSourceBuffer(this.createSourceBuffer(t.mediaSource,t.audio.oformatContext.streams[0].codecpar[l.o9])),t.audio.enableRawMpeg||(y.ho(t.audio.oformatContext),y.bx(t.audio.oformatContext)),o.push(this.startMux(t.audio,t,_.T9(r,s)))),t.video&&(t.video.track.setSourceBuffer(this.createSourceBuffer(t.mediaSource,t.video.oformatContext.streams[0].codecpar[l.o9])),t.video.enableRawMpeg||(y.ho(t.video.oformatContext),y.bx(t.video.oformatContext)),o.push(this.startMux(t.video,t,_.T9(r,s)))),await n().all(o);let c=!1,d=!1;t.audio&&(t.audio.backPacket=await this.pullAVPacket(t.audio,t),t.audio.backPacket>0?(c=!0,t.audio.frontPacket=await this.pullAVPacket(t.audio,t),t.audio.frontPacket>0?t.audio.frontBuffered=!0:(t.audio.frontPacket=0,t.audio.packetEnded=!0)):t.audio.packetEnded=!0,t.audio.enableRawMpeg||t.audio.oformatContext.ioWriter.flush(),t.audio.track.addBuffer(t.audio.bufferQueue.flush())),t.video&&(t.video.backPacket=await this.pullAVPacket(t.video,t),t.video.backPacket>0?(d=!0,t.video.frontPacket=await this.pullAVPacket(t.video,t),t.video.frontPacket>0?t.video.frontBuffered=!0:(t.video.frontPacket=0,t.video.packetEnded=!0)):t.video.packetEnded=!0,t.video.enableRawMpeg||t.video.oformatContext.ioWriter.flush(),t.video.track.addBuffer(t.video.bufferQueue.flush())),t.audio&&(c?(this.createLoop(t.audio,t),t.audio.loop.start()):t.audio.track.end()),t.video&&(d?(this.createLoop(t.video,t),t.video.loop.start()):t.video.track.end()),await new W.A(.1);let u=0;t.audio?u=t.video?Math.max(t.audio.track.getBufferedStart(),t.video.track.getBufferedStart()):t.audio.track.getBufferedStart():t.video&&(u=t.video.track.getBufferedStart()),t.currentTimeNTP=(0,M.A)(),e>BigInt(0)?(t.currentTime=(0,Q.yw)(e),t.controlIPCPort.notify("seek",{time:t.currentTime})):(O.A.safari||G.A.ios||u>.1||t.playRate>BigInt(100))&&(t.currentTime=u,t.currentTimeNTP=(0,M.A)(),t.controlIPCPort.notify("seek",{time:u}))}}getMimeType(t){let e="";return 1===p.f[15](t)?e=(0,z.A)(t):0===p.f[15](t)&&(e=(0,E.A)(t)),e||I.h2("invalid stream",J,466),e}createSourceBuffer(t,e){return t.addSourceBuffer(this.getMimeType(e))}mixExtradata(t,e,i){const a=t.oformatContext.streams[0].codecpar;a.extradata&&(0,R.Eb)(a.extradata),a.extradata=(0,R.sY)(i),(0,f.Mr)(a.extradata,e,i),a.extradataSize=i,27===a.codecId?$.XC(t.oformatContext.streams[0],(0,f.s3)(e,i)):173===a.codecId&&Y.XC(t.oformatContext.streams[0],(0,f.s3)(e,i)),t.track.changeMimeType(this.getMimeType(a[l.o9]),t.enableRawMpeg?"sequence":"segments");const r=new S.A({fragmentMode:1,fragment:!0,fastOpen:!0,mp4Mode:0,defaultBaseIsMoof:!0,reverseSpsInAvcc:!0,hasTfra:!1});t.oformatContext.oformat=r,t.timestampOffsetUpdated=!1,t.enableRawMpeg||(y.ho(t.oformatContext),y.bx(t.oformatContext))}checkEnableEncryption(t,e){if(t.oformatContext.streams[0].metadata.encryption){const i=(0,N.fQ)(e,25);if(!i&&!t.ignoreEncryption||i&&t.ignoreEncryption){t.track.changeMimeType(this.getMimeType(t.oformatContext.streams[0].codecpar[l.o9]),t.enableRawMpeg?"sequence":"segments");const e=new S.A({fragmentMode:1,fragment:!0,fastOpen:!0,mp4Mode:0,defaultBaseIsMoof:!0,reverseSpsInAvcc:!0,ignoreEncryption:!i,hasTfra:!1});t.ignoreEncryption=!i,t.oformatContext.oformat=e,t.timestampOffsetUpdated=!1,t.enableRawMpeg||(y.ho(t.oformatContext),y.bx(t.oformatContext))}}}async pullAVPacketInternal(t,e){const i=await e.request("pull");if(H.ai(i)||(0,X.A)(i))return i;{const e=t.avpacketPool.alloc();return(0,K.r0)(i,e),e}}async pullAVPacket(t,e){const i=t.pullQueue;if(i.ended&&!i.queue.length)return-1048576;const a=i.queue.length?i.queue.shift():await this.pullAVPacketInternal(e,t.pullIPC);if(a<0)return i.ended=!0,-1048576;if(p.f[17](a+16)<BigInt(0))return a;if(p.f[17](a+16)<i.lastDTS&&I.R8(`got packet with dts ${p.f[17](a+16)}, which is earlier then the last packet(${i.lastDTS})`,J,578),g.M[17](a+48,D.Dh),"audio"===t.type&&p.f[17](a+16)>0)g.M[17](a+8,p.f[17](a+16));else if("video"===t.type&&!e.isLive)if(1&p.f[15](a+36)&&(27===p.f[15](e.video.codecpar+4)&&$.KD(a,p.f[20](e.video.codecpar+12)?1+(3&L.r8(p.f[20](e.video.codecpar+12)+4)):4)||173===p.f[15](e.video.codecpar+4)&&Y.KD(a,p.f[20](e.video.codecpar+12)?1+(3&L.r8(p.f[20](e.video.codecpar+12)+21)):4)))if(p.f[17](a+8)<i.lastPTS){I.R8(`got video packet with pts ${p.f[17](a+8)}, which is earlier then the last packet(${i.lastPTS}), try to fix it!`,J,615),g.M[17](a+8,i.lastPTS+(p.f[17](a+16)-i.lastDTS));const r=await this.pullAVPacketInternal(e,t.pullIPC);if(r<0)i.ended=!0;else{i.queue.push(r);let s=p.f[17](r+8);const n=p.f[17](r+8);for(;;){const a=await this.pullAVPacketInternal(e,t.pullIPC);if(a<0){i.ended=!0;break}if(i.queue.push(a),p.f[17](a+8)>n)break;s=_.jk(s,p.f[17](a+8))}s<p.f[17](a+8)&&(i.diff=p.f[17](a+16)-i.lastDTS)}}else i.diff=BigInt(0);else g.M[17](a+8,p.f[17](a+8)+i.diff);return p.f[17](a+8)>i.lastPTS&&(i.lastPTS=p.f[17](a+8)),i.lastDTS=p.f[17](a+16),"audio"===t.type&&i.useSampleRateTimeBase&&(i.frameCount===D.Dh?(i.frameCount=(0,C.Mr)(p.f[17](a+16),a+72,t.oformatContext.streams[0].timeBase),g.M[17](a+16,i.frameCount),g.M[17](a+8,i.frameCount)):(i.frameCount=i.frameCount+BigInt(0|p.f[15](t.codecpar+144)),g.M[17](a+16,i.frameCount),g.M[17](a+8,i.frameCount)),(0,f.Mr)(a+72,t.oformatContext.streams[0].timeBase[l.o9],8)),a}writeAVPacket(t,e,i=!1){if(e.enableRawMpeg){var a;if(!e.timestampOffsetUpdated){const i=(0,C.Mr)(p.f[17](t+8),t+72,D.i0);e.track.updateTimestampOffset(Number(BigInt.asIntN(32,i))/1e3),e.timestampOffsetUpdated=!0}e.bufferQueue.write(r()(a=(0,f.s3)(p.f[20](t+24),p.f[15](t+28))).call(a))}else{if("video"===e.type&&1&p.f[15](t+36)||"audio"===e.type){const i=(0,N.rU)(t,1);i&&function(t,e,i,a){if(e!==a)return!0;let r=!1;for(let a=0;a<e;a++)if(p.f[2](t+a)!==p.f[2](i+a)){r=!0;break}return r}(e.oformatContext.streams[0].codecpar.extradata,e.oformatContext.streams[0].codecpar.extradataSize,p.f[20](i),0|p.f[25](i+4))&&this.mixExtradata(e,p.f[20](i),0|p.f[25](i+4))}this.checkEnableEncryption(e,t),y.XA(e.oformatContext,t),i&&e.oformatContext.ioWriter.flush()}}swap(t,e){if(t.backPacket&&e.avpacketPool.release(t.backPacket),t.backPacket=0,!t.frontBuffered)return!1;t.backPacket=t.frontPacket,t.frontPacket=0,t.frontBuffered=!1;const i=(0,M.A)();return this.pullAVPacket(t,e).then((a=>{if(a<0)return t.packetEnded=!0,void(t.frontPacket=0);const r=(0,M.A)()-i;r>5&&(t.startTimestamp+=BigInt(Math.floor(r))),t.frontPacket=a,t.frontBuffered=!0,t.seekSync&&(t.seekSync(),t.seekSync=null),t.backPacket||this.swap(t,e)})),!0}createLoop(t,e){t.loop=new B.A((()=>{const i=t.track.getBufferedDuration(e.currentTime+((0,M.A)()-e.currentTimeNTP)/1e3);if(i>e.maxBuffer*(e.playRate>BigInt(100)?Number(e.playRate)/100:1))return t.loop.emptyTask(),void this.checkWaiting(e);if(!t.backPacket)return void(t.packetEnded&&!t.frontPacket?(t.ended=!0,t.loop.stop(),t.enableRawMpeg||(y.dJ(t.oformatContext),y.bX(t.oformatContext)),t.bufferQueue.size&&t.track.addBuffer(t.bufferQueue.flush()),t.track.end()):t.loop.emptyTask());let a=t.backPacket;const r=(0,C.Mr)(p.f[17](a+16),a+72,D.i0);if(t.lastDTS!==D.Dh&&r-t.lastDTS>1e3&&(y.bX(t.oformatContext),t.startTimestamp-=r-t.lastDTS),t.lastDTS=r,e.enableJitterBuffer&&(p.f[15](e.stats+244)?p.f[15](e.stats+32)/p.f[15](e.stats+244)*1e3:p.f[15](e.stats+232)?p.f[15](e.stats+120)/p.f[15](e.stats+232)*1e3:0)<=p.f[15](e.stats+280)&&this.setPlayRate(e.taskId,1),r*BigInt(100)/e.playRate+t.startTimestamp-BigInt(Math.floor((0,M.A)()))<=0||i<e.minBuffer*(e.playRate>BigInt(100)?Number(e.playRate)/100:1)){t.track.isPaused()&&t.track.enqueue(),g.M[15](a+32,t.oformatContext.streams[0].index),this.writeAVPacket(a,t,!0),t.track.addBuffer(t.bufferQueue.flush());const i=t.oformatContext.streams[0].codecpar.codecType;if(0===i?(g.M[17](e.stats+144,p.f[17](e.stats+144)+BigInt(1)),g.M[17](e.stats+160,p.f[17](e.stats+160)+BigInt(1))):1===i&&(g.M[17](e.stats+56,p.f[17](e.stats+56)+BigInt(1)),g.M[17](e.stats+72,p.f[17](e.stats+72)+BigInt(1))),e.playRate!==e.targetRate&&(t.startTimestamp=BigInt(Math.floor((0,M.A)()))-r*BigInt(100)/e.targetRate,e.playRate=e.targetRate),t.packetEnded&&!t.frontPacket)return t.ended=!0,t.loop.stop(),t.enableRawMpeg||(y.dJ(t.oformatContext),y.bX(t.oformatContext)),t.bufferQueue.size&&t.track.addBuffer(t.bufferQueue.flush()),void t.track.end();this.swap(t,e)}else t.loop.emptyTask()}),0,0)}async startMux(t,e,i=BigInt(0)){let a,r=D.Dh,s=D.Dh,n=BigInt(0),o=e.cacheDuration;const c=t.oformatContext.streams[0].timeBase;for(t.backPacket>0&&(r=p.f[17](t.backPacket+16),s=p.f[17](t.backPacket+8),i>s&&(o+=i-(0,C.k)(r,c,D.i0)),g.M[15](t.backPacket+32,t.oformatContext.streams[0].index),this.writeAVPacket(t.backPacket,t),e.avpacketPool.release(t.backPacket),t.backPacket=0);r===D.Dh||(0,C.k)(n-r,c,D.i0)<o;){if(a=await this.pullAVPacket(t,e),a<0){t.packetEnded=!0;break}n=p.f[17](a+16),r===D.Dh&&(r=n,s=p.f[17](a+8)),p.f[17](a+8)<s&&(s=p.f[17](a+8)),g.M[15](a+32,t.oformatContext.streams[0].index),this.writeAVPacket(a,t),e.avpacketPool.release(a)}s!==D.Dh&&t.startPTS<=BigInt(0)&&(t.startPTS=s),t.pullQueue.diff=BigInt(0),e.currentTimeNTP=(0,M.A)(),e.currentTime=0,t.startTimestamp=BigInt(Math.floor((0,M.A)()))-(0,C.k)(n,c,D.i0)*BigInt(100)/e.playRate}resetResource(t,e){t.bufferQueue.flush(),t.oformatContext.oformat.destroy(t.oformatContext);const i=new S.A({fragmentMode:1,fragment:!0,fastOpen:!0,mp4Mode:0,defaultBaseIsMoof:!0,reverseSpsInAvcc:!0,hasTfra:!1});t.oformatContext.oformat=i;const a=new x.A;a.onQuotaExceededError=()=>{t.startTimestamp-=BigInt(100)},a.onEnded=()=>{e.audio&&!e.audio.ended||e.video&&!e.video.ended||(e.mediaSource.endOfStream(),I.pq(`muxer ended, taskId: ${e.taskId}`,J,945))},t.track=a,t.packetEnded=!1,t.ended=!1,t.startTimestamp=BigInt(0),t.frontBuffered=!1,t.seekSync=null,t.loop&&(t.loop.destroy(),t.loop=null),t.frontPacket&&(e.avpacketPool.release(t.frontPacket),t.frontPacket=0),t.backPacket&&(e.avpacketPool.release(t.backPacket),t.backPacket=0),t.pullQueue.ended=!1,t.pullQueue.index=0,t.pullQueue.frameCount=D.Dh,t.pullQueue.lastPTS=BigInt(0),t.pullQueue.lastDTS=BigInt(0),t.pullQueue.diff=BigInt(0),t.lastDTS=D.Dh}async addStream(t,e,i,a,s,n,o){const c=this.tasks.get(t);if(c){const d=(0,R.Gy)(168);(0,X.A)(i)?(0,A.Yi)(d,i):(0,K.T8)(i,d);const u=new P.A(1048576),f=(0,w.fG)(),h=new S.A({fragmentMode:1,fragment:!0,fastOpen:!0,mp4Mode:0,defaultBaseIsMoof:!0,reverseSpsInAvcc:!0,hasTfra:!1}),m=new F.A;u.onFlush=t=>(m.write(r()(t).call(t)),0),u.onSeek=t=>m.seek(t)?0:b.lh;const k=f.createStream();(0,A.Yi)(k.codecpar[l.o9],d),k.metadata=s,86017===p.f[15](d+4)&&(k.codecpar.codecTag=(0,V.A)(".mp3"));const v=1===p.f[15](d)&&p.f[15](d+144)&&!c.isLive&&(0,C.lb)(a)>(0,C.lb)({num:1,den:p.f[15](d+136)});v?(k.timeBase.den=p.f[15](d+136),k.timeBase.num=1):(k.timeBase.den=a.den,k.timeBase.num=a.num),f.oformat=h,f.ioWriter=u;const y=new x.A,B={type:"audio",codecpar:d,ioWriter:u,oformatContext:f,oformat:h,track:y,bufferQueue:m,streamIndex:e,pullIPC:new U.Ay(o),loop:null,frontPacket:0,backPacket:0,frontBuffered:!1,startTimestamp:BigInt(0),packetEnded:!1,ended:!1,seekSync:null,startPTS:n,lastDTS:D.Dh,pullQueue:{queue:[],index:0,frameCount:D.Dh,diff:BigInt(0),lastPTS:BigInt(0),lastDTS:BigInt(0),ended:!1,useSampleRateTimeBase:v},enableRawMpeg:86017===p.f[15](d+4)&&!O.A.firefox,timestampOffsetUpdated:!1,ignoreEncryption:!1};y.onQuotaExceededError=()=>{B.startTimestamp-=BigInt(100)},y.onEnded=()=>{c.audio&&!c.audio.ended||c.video&&!c.video.ended||(c.mediaSource.endOfStream(),I.pq(`muxer ended, taskId: ${c.taskId}`,J,1093))},1===p.f[15](d)?(c.audio=B,g.M[15](c.stats+4,p.f[15](d+136)),g.M[15](c.stats,p.f[15](d+116))):0===p.f[15](d)&&(B.type="video",c.video=B,g.M[15](c.stats+84,p.f[15](d+56)),g.M[15](c.stats+88,p.f[15](d+60)),p.f[15](c.stats+84)*p.f[15](c.stats+88)>8294400&&(O.A.safari||G.A.ios)&&(c.cacheDuration=_.T9(BigInt(3e3),c.cacheDuration))),I.Yz(`add stream ${e}, taskId: ${t}`,J,1113)}else I.h2("task not found",J,1116)}async reAddStream(t,e,i,a,r,s){const o=this.tasks.get(t);if(o){const u=(0,R.Gy)(168);(0,X.A)(i)?(0,A.Yi)(u,i):(0,K.T8)(i,u);const f=1===p.f[15](u)?o.audio:o.video;if(f){f.bufferQueue.flush(),await new(n())((t=>{f.track.removeAllBuffer((()=>{t()}))})),f.track.reset();const t=new S.A({fragmentMode:1,fragment:!0,fastOpen:!0,mp4Mode:0,defaultBaseIsMoof:!0,reverseSpsInAvcc:!0,hasTfra:!1});f.oformatContext.oformat=t,f.codecpar&&(0,A.dn)(f.codecpar),f.codecpar=u,f.streamIndex=e,f.startPTS=s;const i=f.oformatContext.streams[0];(0,A.Yi)(i.codecpar[l.o9],u),i.metadata=r,86017===p.f[15](u+4)&&(i.codecpar.codecTag=(0,V.A)(".mp3"));const h=1===p.f[15](u)&&p.f[15](u+144)&&!o.isLive&&(0,C.lb)(a)>(0,C.lb)({num:1,den:p.f[15](u+136)});h?(i.timeBase.den=p.f[15](u+136),i.timeBase.num=1):(i.timeBase.den=a.den,i.timeBase.num=a.num),f.enableRawMpeg=86017===p.f[15](u+4)&&!O.A.firefox,f.timestampOffsetUpdated=!1,f.pullQueue.useSampleRateTimeBase=h;try{f.track.changeMimeType(this.getMimeType(i.codecpar[l.o9]),f.enableRawMpeg?"sequence":"segments")}catch(t){var d;if(!O.A.firefox||c()(d=t.message).call(d,"An attempt was made to use an object that is not")<0)throw t}f.enableRawMpeg||(y.ho(f.oformatContext),y.bx(f.oformatContext))}else(0,A.dn)(u);I.Yz(`readd stream ${e}, taskId: ${t}`,J,1219)}else I.h2("task not found",J,1222)}async pause(t){const e=this.tasks.get(t);var i,a,r,s;e?(null!==(i=e.audio)&&void 0!==i&&i.loop||null!==(a=e.video)&&void 0!==a&&a.loop||I.h2("task has not played",J,1230),e.pausing=!0,e.pauseTimestamp=(0,M.A)(),null===(r=e.audio)||void 0===r||r.loop.stop(),null===(s=e.video)||void 0===s||s.loop.stop(),e.fakePlayTimer&&e.fakePlayTimer.stop(),I.Yz(`pause taskId: ${t}`,J,1240)):I.h2("task not found",J,1243)}async unpause(t){const e=this.tasks.get(t);var i,a;e?(null!==(i=e.audio)&&void 0!==i&&i.loop||null!==(a=e.video)&&void 0!==a&&a.loop||I.h2("task has not played",J,1251),e.pausing=!1,e.seeking||(e.audio&&(e.audio.startTimestamp+=BigInt(Math.floor((0,M.A)()-e.pauseTimestamp)),e.audio.loop.start()),e.video&&(e.video.startTimestamp+=BigInt(Math.floor((0,M.A)()-e.pauseTimestamp)),e.video.loop.start())),e.fakePlayTimer&&e.fakePlayTimer.start(),I.Yz(`unpause taskId: ${t}`,J,1269)):I.h2("task not found",J,1272)}async beforeSeek(t){const e=this.tasks.get(t);if(e){var i,a;const o=[];var r,s;if(e.audio&&(e.audio.ended||e.audio.frontBuffered||o.push(new(n())((t=>{e.audio.seekSync=t})))),e.video&&(e.video.ended||e.video.frontBuffered||o.push(new(n())((t=>{e.video.seekSync=t})))),await n().all(o),e.seeking=!0,null===(i=e.audio)||void 0===i||i.loop.stop(),null===(a=e.video)||void 0===a||a.loop.stop(),e.audio)e.audio.enableRawMpeg||y.bX(e.audio.oformatContext),e.audio.bufferQueue.flush(),(O.A.safari||G.A.ios)&&await new(n())((t=>{e.audio.track.removeAllBuffer((()=>{t()}))})),e.audio.track.reset(),e.audio.packetEnded=!1,e.audio.timestampOffsetUpdated=!1,e.audio.backPacket&&(e.avpacketPool.release(e.audio.backPacket),e.audio.backPacket=0),e.audio.frontPacket&&(e.avpacketPool.release(e.audio.frontPacket),e.audio.frontPacket=0),e.audio.pullQueue.queue.length&&u()(r=e.audio.pullQueue.queue).call(r,(t=>{e.avpacketPool.release(t)})),e.audio.pullQueue.queue.length=0,e.audio.pullQueue.ended=!1,e.audio.pullQueue.index=0,e.audio.pullQueue.lastPTS=BigInt(0),e.audio.pullQueue.lastDTS=BigInt(0),e.audio.pullQueue.diff=BigInt(0),e.audio.pullQueue.frameCount=D.Dh,e.audio.lastDTS=D.Dh;if(e.video)e.video.enableRawMpeg||y.bX(e.video.oformatContext),e.video.bufferQueue.flush(),(O.A.safari||G.A.ios)&&await new(n())((t=>{e.video.track.removeAllBuffer((()=>{t()}))})),e.video.track.reset(),e.video.packetEnded=!1,e.video.timestampOffsetUpdated=!1,e.video.backPacket&&(e.avpacketPool.release(e.video.backPacket),e.video.backPacket=0),e.video.frontPacket&&(e.avpacketPool.release(e.video.frontPacket),e.video.frontPacket=0),e.video.pullQueue.queue.length&&u()(s=e.video.pullQueue.queue).call(s,(t=>{e.avpacketPool.release(t)})),e.video.pullQueue.queue.length=0,e.video.pullQueue.ended=!1,e.video.pullQueue.index=0,e.video.pullQueue.diff=BigInt(0),e.video.pullQueue.lastPTS=BigInt(0),e.video.pullQueue.lastDTS=BigInt(0),e.video.lastDTS=D.Dh;I.Yz(`before seek end taskId: ${t}`,J,1383)}}async afterSeek(t,e){const i=this.tasks.get(t);if(i){let a=e,r=e,s=await this.syncToKeyframe(i);i.audio&&i.audio.backPacket>0&&((!s||e<BigInt(0))&&(a=(0,C.Mr)(p.f[17](i.audio.backPacket+8),i.audio.backPacket+72,D.i0)),g.M[15](i.audio.backPacket+32,i.audio.oformatContext.streams[0].index),this.writeAVPacket(i.audio.backPacket,i.audio),i.avpacketPool.release(i.audio.backPacket),i.audio.backPacket=0),i.video&&i.video.backPacket>0&&((!s||e<BigInt(0))&&(r=(0,C.Mr)(p.f[17](i.video.backPacket+8),i.video.backPacket+72,D.i0)),g.M[15](i.video.backPacket+32,i.video.oformatContext.streams[0].index),this.writeAVPacket(i.video.backPacket,i.video),i.avpacketPool.release(i.video.backPacket),i.video.backPacket=0);const o=_.T9(a,r);for(;;){if(i.audio&&!i.audio.packetEnded){if(i.audio.backPacket=await this.pullAVPacket(i.audio,i),i.audio.backPacket<0&&(i.audio.packetEnded=!0,i.audio.backPacket=0,!i.video||i.video.packetEnded))break;if(a<BigInt(0)&&(a=(0,C.Mr)(p.f[17](i.audio.backPacket+8),i.audio.backPacket+72,D.i0)),!((0,C.Mr)(p.f[17](i.audio.backPacket+8),i.audio.backPacket+72,D.i0)<o+i.cacheDuration))break;g.M[15](i.audio.backPacket+32,i.audio.oformatContext.streams[0].index),this.writeAVPacket(i.audio.backPacket,i.audio),i.audio.enableRawMpeg||y.bX(i.audio.oformatContext),i.audio.track.addBuffer(i.audio.bufferQueue.flush()),i.avpacketPool.release(i.audio.backPacket),i.audio.backPacket=0}if(i.video&&!i.video.packetEnded){if(i.video.backPacket=await this.pullAVPacket(i.video,i),i.video.backPacket<0&&(i.video.packetEnded=!0,i.video.backPacket=0,!i.audio||i.audio.packetEnded))break;if(!((0,C.Mr)(p.f[17](i.video.backPacket+8),i.video.backPacket+72,D.i0)<o+i.cacheDuration))break;g.M[15](i.video.backPacket+32,i.video.oformatContext.streams[0].index),this.writeAVPacket(i.video.backPacket,i.video),i.video.enableRawMpeg||y.bX(i.video.oformatContext),i.video.track.addBuffer(i.video.bufferQueue.flush()),i.avpacketPool.release(i.video.backPacket),i.video.backPacket=0}}const c=[];i.audio&&(i.audio.enableRawMpeg||y.bX(i.audio.oformatContext),c.push(new(n())((t=>{i.audio.track.addBuffer(i.audio.bufferQueue.flush(),(()=>{t()}))})))),i.video&&(i.video.enableRawMpeg||y.bX(i.video.oformatContext),c.push(new(n())((t=>{i.video.track.addBuffer(i.video.bufferQueue.flush(),(()=>{t()}))})))),await n().all(c),i.audio&&!i.audio.packetEnded&&(i.audio.backPacket<=0&&(i.audio.backPacket=await this.pullAVPacket(i.audio,i),i.audio.backPacket<0&&(i.audio.packetEnded=!0,i.audio.backPacket=0)),i.audio.packetEnded||(i.audio.frontPacket=await this.pullAVPacket(i.audio,i),i.audio.frontPacket<0?(i.audio.frontPacket=0,i.audio.packetEnded=!0,i.audio.frontBuffered=!1):(i.audio.packetEnded=!1,i.audio.frontBuffered=!0),i.audio.startTimestamp=BigInt(Math.floor((0,M.A)()))-(a+i.cacheDuration+(0,C.k)(i.audio.startPTS,i.audio.oformatContext.streams[0].timeBase,D.i0))*BigInt(100)/i.playRate,i.pausing?i.pauseTimestamp=(0,M.A)():i.audio.loop.start())),i.video&&!i.video.packetEnded&&(i.video.backPacket<=0&&(i.video.backPacket=await this.pullAVPacket(i.video,i),i.video.backPacket<0&&(i.video.packetEnded=!0,i.video.backPacket=0)),i.video.packetEnded||(i.video.frontPacket=await this.pullAVPacket(i.video,i),i.video.frontPacket<0?(i.video.packetEnded=!0,i.video.frontBuffered=!1,i.video.frontPacket=0):(i.video.packetEnded=!1,i.video.frontBuffered=!0),i.video.startTimestamp=BigInt(Math.floor((0,M.A)()))-(r+i.cacheDuration+(0,C.k)(i.video.startPTS,i.video.oformatContext.streams[0].timeBase,D.i0))*BigInt(100)/i.playRate,i.pausing?i.pauseTimestamp=(0,M.A)():i.video.loop.start())),await n().all([new(n())((t=>{i.audio?i.audio.track.insertEnqueueCallback(t):t()})),new(n())((t=>{i.video?i.video.track.insertEnqueueCallback(t):t()}))]);let d=0,u=0;i.audio?i.video?(d=Math.max(i.audio.track.getBufferedStart(),i.video.track.getBufferedStart()),u=Math.min(i.audio.track.getBufferedEnd(),i.video.track.getBufferedEnd())):(d=i.audio.track.getBufferedStart(),u=i.audio.track.getBufferedEnd()):i.video&&(d=i.video.track.getBufferedStart(),u=i.video.track.getBufferedEnd());let f=(0,Q.yw)(o);return f>=d&&f<=u||(f=Math.abs(f-d)>Math.abs(f-u)?u:d),i.currentTimeNTP=(0,M.A)(),i.currentTime=f,i.seeking=!1,I.Yz(`after seek end, seekTime: ${f} taskId: ${t}`,J,1621),f}return 0}async setPlayRate(t,e){const i=this.tasks.get(t);if(i){if(i.enableJitterBuffer){let t=p.f[15](i.stats+244)?p.f[15](i.stats+32)/p.f[15](i.stats+244)*1e3:p.f[15](i.stats+232)?p.f[15](i.stats+120)/p.f[15](i.stats+232)*1e3:0;t&&t<=p.f[15](i.stats+280)&&(e=1)}i.targetRate=BigInt(Math.floor(Math.floor(100*e))),i.enableJitterBuffer||(i.audio&&i.audio.loop&&i.audio.loop.resetInterval(),i.video&&i.video.loop&&i.video.loop.resetInterval())}}async restart(t){const e=this.tasks.get(t);if(e){e.audio&&this.resetResource(e.audio,e),e.video&&this.resetResource(e.video,e);const t=new((0,q.A)());t.onsourceopen=this.getSourceOpenHandler(e),e.mediaSource=t}}async setCurrentTime(t,e){const i=this.tasks.get(t);i?(i.audio&&i.audio.track.removeBuffer(e),i.video&&p.f[15](i.stats+92)>0&&(i.video.track.setMediaBufferMax(Math.max(i.video.track.getMediaBufferMax(),Math.ceil(p.f[15](i.stats+92)/1e3*1.5),10)),i.video.track.removeBuffer(e)),i.currentTime=e,i.currentTimeNTP=(0,M.A)()):I.h2("task not found",J,1694)}async checkWaiting(t){let e=-1,i=-1;const a=t.currentTime+((0,M.A)()-t.currentTimeNTP)/1e3;if(t.audio){const i=t.audio.track.getSourceBuffer();i&&2===i.buffered.length&&i.buffered.end(1)-i.buffered.start(1)>=t.maxBuffer&&i.buffered.end(0)<a&&t.currentTime<i.buffered.start(1)&&(e=i.buffered.start(1))}if(t.video){const e=t.video.track.getSourceBuffer();e&&2===e.buffered.length&&e.buffered.end(1)-e.buffered.start(1)>=t.maxBuffer&&e.buffered.end(0)<a&&t.currentTime<e.buffered.start(1)&&(i=e.buffered.start(1))}if(t.audio&&t.video){if(e>0&&i>0){const a=Math.min(e,i);t.currentTime=a,t.controlIPCPort.notify("seek",{time:a})}}else e>0?(t.currentTime=e,t.controlIPCPort.notify("seek",{time:e})):i>0&&(t.currentTime=i,t.controlIPCPort.notify("seek",{time:i}))}async getMediaSource(t){const e=this.tasks.get(t);if(e)return e.mediaSource.handle?(this.getMediaSource.transfer.push(e.mediaSource.handle),e.mediaSource.handle):e.mediaSource;I.h2("task not found",J,1759)}async isManagedMediaSource(t){const e=this.tasks.get(t);if(e)return"function"==typeof ManagedMediaSource&&e.mediaSource instanceof ManagedMediaSource;I.h2("task not found",J,1770)}createTask(t,e){const i=new U.Ay(t.controlPort),a=new((0,q.A)()),r={...t,mediaSource:a,audio:null,video:null,playRate:BigInt(100),targetRate:BigInt(100),pauseTimestamp:0,seeking:!1,pausing:!1,controlIPCPort:i,currentTime:0,currentTimeNTP:0,cacheDuration:BigInt(Math.floor(500)),avpacketPool:new T.A((0,m.A)(t.avpacketList,k.A),t.avpacketListMutex),maxBuffer:t.isLive?1:4,minBuffer:t.isLive?.5:2,visibilityHidden:!1,fakePlayTimer:null};return this.tasks.set(t.taskId,r),a.onsourceopen=this.getSourceOpenHandler(r,e),i.on(U.Wo,(e=>{"visibilitychange"===e.method&&this.setVisibilityHidden(t.taskId,e.params.visibilityHidden)})),0}async setVisibilityHidden(t,e){const i=this.tasks.get(t);i&&(i.visibilityHidden=e,e?i.isLive&&i.video&&!i.audio&&(i.fakePlayTimer&&i.fakePlayTimer.destroy(),i.fakePlayTimer=new j.A((()=>{this.setCurrentTime(i.taskId,i.currentTime+((0,M.A)()-i.currentTimeNTP)/1e3)}),0,1e3),i.fakePlayTimer.start()):i.fakePlayTimer&&(i.fakePlayTimer.destroy(),i.fakePlayTimer=null,i.video.track.getBufferedTime()>(i.isLive?2:4)&&(this.setCurrentTime(i.taskId,Math.max(i.video.track.getBufferedEnd()-(i.isLive?1:4),i.video.track.getBufferedStart())),i.controlIPCPort.notify("seek",{time:i.currentTime}))))}async registerTask(t,e=BigInt(0)){return this.tasks.has(t.taskId)?b.lh:this.createTask(t,e)}async unregisterTask(t){const e=this.tasks.get(t);if(e){var i,a;if(e.audio)e.audio.loop&&(await e.audio.oformatContext.destroy(),e.audio.loop.destroy()),e.audio.pullIPC&&e.audio.pullIPC.destroy(),e.audio.pullQueue.queue.length&&(u()(i=e.audio.pullQueue.queue).call(i,(t=>{e.avpacketPool.release(t)})),e.audio.pullQueue.queue.length=0),e.audio.codecpar&&(0,A.dn)(e.audio.codecpar);if(e.video)e.video.loop&&(await e.video.oformatContext.destroy(),e.video.loop.destroy()),e.video.pullIPC&&e.video.pullIPC.destroy(),e.video.pullQueue.queue.length&&(u()(a=e.video.pullQueue.queue).call(a,(t=>{e.avpacketPool.release(t)})),e.video.pullQueue.queue.length=0),e.video.codecpar&&(0,A.dn)(e.video.codecpar);e.controlIPCPort&&e.controlIPCPort.destroy(),this.tasks.delete(t)}}}},60120:(t,e,i)=>{"use strict";i.d(e,{A:()=>c});var a,r=i(49859),s=i(95335),n=i(4624);!function(t){t[t.ADD=0]="ADD",t[t.REMOVE=1]="REMOVE",t[t.UPDATE_TIMESTAMP_OFFSET=2]="UPDATE_TIMESTAMP_OFFSET",t[t.CALLBACK=3]="CALLBACK",t[t.CHANGE_MIME_TYPE=4]="CHANGE_MIME_TYPE"}(a||(a={}));const o={mediaBufferMax:10};class c{constructor(t={}){(0,r.A)(this,"sourceBuffer",void 0),(0,r.A)(this,"operatorQueue",void 0),(0,r.A)(this,"updating",void 0),(0,r.A)(this,"lastRemoveTime",void 0),(0,r.A)(this,"paddingCallback",void 0),(0,r.A)(this,"options",void 0),(0,r.A)(this,"ending",void 0),(0,r.A)(this,"onQuotaExceededError",void 0),(0,r.A)(this,"onEnded",void 0),this.options=s.X$({},o,t),this.operatorQueue=[],this.updating=!1,this.lastRemoveTime=0,this.ending=!1}setSourceBuffer(t){this.sourceBuffer&&(this.sourceBuffer.onupdateend=null,this.sourceBuffer.onerror=null),this.sourceBuffer=t,this.sourceBuffer.onupdateend=()=>{this.paddingCallback&&(this.paddingCallback(),this.paddingCallback=null),this.operatorQueue&&this.operatorQueue.length?this.enqueue():(this.updating=!1,this.ending&&this.onEnded&&this.onEnded())},this.sourceBuffer.onerror=t=>{n.z3(`track update buffer error: ${t}`,"src/avrender/track/Track.ts",110)}}changeMimeType(t,e){this.sourceBuffer&&(this.operatorQueue.push({operator:a.CHANGE_MIME_TYPE,type:t,mode:e}),this.updating||this.enqueue())}enqueue(){if(this.operatorQueue.length){const t=this.operatorQueue.shift();if(t.operator===a.ADD)try{this.sourceBuffer.appendBuffer(t.buffer),this.updating=!0,t.callback&&(this.paddingCallback=t.callback)}catch(e){if(!(e instanceof DOMException&&"QuotaExceededError"===e.name))throw e;this.operatorQueue.unshift(t),this.onQuotaExceededError&&this.onQuotaExceededError(),this.updating=!1}else t.operator===a.REMOVE?(this.sourceBuffer.remove(t.start,t.end),this.updating=!0,t.callback&&(this.paddingCallback=t.callback)):t.operator===a.UPDATE_TIMESTAMP_OFFSET?(this.sourceBuffer.timestampOffset=t.timestampOffset,t.callback&&t.callback(),this.operatorQueue.length?this.enqueue():this.updating=!1):t.operator===a.CALLBACK?(t.callback&&t.callback(),this.operatorQueue.length?this.enqueue():this.updating=!1):t.operator===a.CHANGE_MIME_TYPE&&(this.sourceBuffer.changeType(t.type),this.sourceBuffer.mode=t.mode,this.sourceBuffer.timestampOffset=0)}}addBuffer(t,e){t?(this.operatorQueue.push({operator:a.ADD,buffer:t,callback:e}),this.updating||this.enqueue()):e&&e()}insertEnqueueCallback(t){this.operatorQueue.push({operator:a.CALLBACK,callback:t}),this.updating||this.enqueue()}updateTimestampOffset(t,e){this.operatorQueue.push({operator:a.UPDATE_TIMESTAMP_OFFSET,timestampOffset:t,callback:e}),this.updating||this.enqueue()}removeBuffer(t,e){this.ending||(t=Math.floor(t))-this.lastRemoveTime<this.options.mediaBufferMax<<1||(this.operatorQueue.push({operator:a.REMOVE,start:this.lastRemoveTime,end:t-this.options.mediaBufferMax,callback:e}),this.updating||this.enqueue(),this.lastRemoveTime=t-this.options.mediaBufferMax)}removeAllBuffer(t){this.sourceBuffer.buffered.length?(this.operatorQueue.push({operator:a.REMOVE,start:this.sourceBuffer.buffered.start(0),end:this.sourceBuffer.buffered.end(this.sourceBuffer.buffered.length-1),callback:t}),this.updating||this.enqueue()):t&&t()}end(){this.ending=!0,this.updating||this.operatorQueue.length||this.onEnded&&this.onEnded()}stop(){if(this.sourceBuffer){try{this.sourceBuffer.abort(),this.updating=!1}catch(t){}try{this.sourceBuffer.buffered.length&&(this.updating?this.operatorQueue.push({operator:a.REMOVE,start:this.sourceBuffer.buffered.start(0),end:this.sourceBuffer.buffered.end(this.sourceBuffer.buffered.length-1)}):(this.sourceBuffer.remove(this.sourceBuffer.buffered.start(0),this.sourceBuffer.buffered.end(this.sourceBuffer.buffered.length-1)),this.updating=!0)),this.paddingCallback&&(this.paddingCallback(),this.paddingCallback=null)}catch(t){}}}reset(){this.stop(),this.operatorQueue.length=0,this.ending=!1}isPaused(){return!this.updating&&this.operatorQueue.length}getQueueLength(){return this.operatorQueue.length}getBufferedTime(){return this.sourceBuffer&&this.sourceBuffer.buffered.length?this.sourceBuffer.buffered.end(this.sourceBuffer.buffered.length-1)-this.sourceBuffer.buffered.start(0):0}getBufferedStart(){return this.sourceBuffer&&this.sourceBuffer.buffered.length?this.sourceBuffer.buffered.start(0):0}getBufferedEnd(){return this.sourceBuffer&&this.sourceBuffer.buffered.length?this.sourceBuffer.buffered.end(this.sourceBuffer.buffered.length-1):0}getBufferedDuration(t){if(this.sourceBuffer&&this.sourceBuffer.buffered.length){let e=0;try{for(let i=0;i<this.sourceBuffer.buffered.length;i++){const a=Math.max(t,this.sourceBuffer.buffered.start(i));e+=Math.max(t,this.sourceBuffer.buffered.end(i))-a}}catch(t){}return e}return 0}getSourceBuffer(){return this.sourceBuffer}setMediaBufferMax(t){this.options.mediaBufferMax=t}getMediaBufferMax(){return this.options.mediaBufferMax}destroy(){this.stop(),this.operatorQueue=null,this.sourceBuffer&&(this.sourceBuffer.onupdateend=this.sourceBuffer.onerror=null,this.sourceBuffer=null)}}},35336:(t,e,i)=>{"use strict";i.d(e,{A:()=>s});var a=i(49859),r=i(50011);class s{constructor(t=1048576,e=!0,i){if((0,a.A)(this,"data",void 0),(0,a.A)(this,"buffer",void 0),(0,a.A)(this,"pointer",void 0),(0,a.A)(this,"pos",void 0),(0,a.A)(this,"size",void 0),(0,a.A)(this,"littleEndian",void 0),(0,a.A)(this,"error",void 0),(0,a.A)(this,"onFlush",void 0),(0,a.A)(this,"onSeek",void 0),this.pointer=0,this.pos=BigInt(0),this.size=t,this.littleEndian=!e,this.error=0,i&&i.view)this.size=i.length,this.buffer=i,this.data=i.view;else if(i&&!i.byteOffset)this.size=i.length,this.buffer=i,this.data=new DataView(this.buffer.buffer);else{if(i)throw new Error("not support subarray of ArrayBuffer");this.buffer=new Uint8Array(this.size),this.data=new DataView(this.buffer.buffer)}}writeUint8(t){this.remainingLength()<1&&this.flush(),this.data.setUint8(this.pointer,t),this.pointer++,this.pos++}writeUint16(t){this.remainingLength()<2&&this.flush(),this.data.setUint16(this.pointer,t,this.littleEndian),this.pointer+=2,this.pos+=BigInt(2)}writeUint24(t){this.remainingLength()<3&&this.flush();const e=(16711680&t)>>16,i=(65280&t)>>8,a=255&t;this.littleEndian?(this.writeUint8(a),this.writeUint8(i),this.writeUint8(e)):(this.writeUint8(e),this.writeUint8(i),this.writeUint8(a))}writeUint32(t){this.remainingLength()<4&&this.flush(),this.data.setUint32(this.pointer,t,this.littleEndian),this.pointer+=4,this.pos+=BigInt(4)}writeUint64(t){this.remainingLength()<8&&this.flush(),this.data.setBigUint64(this.pointer,t,this.littleEndian),this.pointer+=8,this.pos+=BigInt(8)}writeInt8(t){this.remainingLength()<1&&this.flush(),this.data.setInt8(this.pointer,t),this.pointer++,this.pos++}writeInt16(t){this.remainingLength()<2&&this.flush(),this.data.setInt16(this.pointer,t,this.littleEndian),this.pointer+=2,this.pos+=BigInt(2)}writeInt24(t){this.writeUint24(t<0?t+16777216:t)}writeInt32(t){this.remainingLength()<4&&this.flush(),this.data.setInt32(this.pointer,t,this.littleEndian),this.pointer+=4,this.pos+=BigInt(4)}writeInt64(t){this.remainingLength()<8&&this.flush(),this.data.setBigInt64(this.pointer,t,this.littleEndian),this.pointer+=8,this.pos+=BigInt(8)}writeFloat(t){this.remainingLength()<4&&this.flush(),this.data.setFloat32(this.pointer,t,this.littleEndian),this.pointer+=4,this.pos+=BigInt(4)}writeDouble(t){this.remainingLength()<8&&this.flush(),this.data.setFloat64(this.pointer,t,this.littleEndian),this.pointer+=8,this.pos+=BigInt(8)}getPointer(){return this.pointer}getPos(){return this.pos}remainingLength(){return this.size-this.pointer}writeBuffer(t){if(!t.length)return;let e=t.length;if(this.remainingLength()<e){let i=0;for(;e>0;){this.flush();const a=Math.min(this.size,e);this.buffer.set(t.subarray(i,i+a),this.pointer),this.pointer+=a,this.pos+=BigInt(a),i+=a,e-=a}}else this.buffer.set(t,this.pointer),this.pointer+=e,this.pos+=BigInt(e)}writeString(t){const e=r.encode(t);return this.writeBuffer(e),e.length}flush(){if(!this.onFlush)throw this.error=-1048574,Error("IOWriter error, flush failed because of no flush callback");if(this.pointer){const t=this.onFlush(this.buffer.subarray(0,this.pointer));if(0!==t)throw this.error=t,Error("IOWriter error, flush failed")}this.pointer=0}flushToPos(t){if(!this.onFlush)throw this.error=-1048574,Error("IOWriter error, flush failed because of no flush callback");if(this.pointer){const e=this.onFlush(this.buffer.subarray(0,this.pointer),t);if(0!==e)throw this.error=e,Error("IOWriter error, flush failed")}this.pointer=0}seek(t){if(!this.onSeek)throw this.error=-1048574,Error("IOWriter error, seek failed because of no seek callback");this.flush();const e=this.onSeek(t);if(0!==e)throw this.error=e,Error("IOWriter error, seek failed");this.pos=t}seekInline(t){const e=this.pointer;this.pointer=Math.max(0,Math.min(this.size,t)),this.pos+=BigInt(this.pointer-e)}skip(t){const e=this.pointer;this.pointer=Math.min(this.size,this.pointer+t),this.pos+=BigInt(this.pointer-e)}back(t){const e=this.pointer;this.pointer=Math.max(0,this.pointer-t),this.pos+=BigInt(this.pointer-e)}getBuffer(){return this.buffer.subarray(0,this.pointer)}setEndian(t){this.littleEndian=!t}reset(){this.pointer=0,this.pos=BigInt(0),this.error=0}getBufferSize(){return this.size}}},22343:(t,e,i)=>{"use strict";i.d(e,{A:()=>s});var a=i(49859),r=i(92647);class s{constructor(){(0,a.A)(this,"queue",void 0),(0,a.A)(this,"pos",void 0),(0,a.A)(this,"startPos",void 0),(0,a.A)(this,"endPos",void 0),(0,a.A)(this,"index",void 0),(0,a.A)(this,"offset",void 0),this.queue=[],this.startPos=BigInt(0),this.endPos=BigInt(0),this.pos=BigInt(0)}write(t){if(this.pos===this.endPos)this.queue.push(t),this.endPos+=BigInt(t.length),this.pos+=BigInt(t.length);else if(t.length<this.queue[this.index].length-this.offset)this.queue[this.index].set(t,this.offset),this.offset+=t.length,this.pos+=BigInt(t.length),this.offset===this.queue[this.index].length&&(this.index++,this.offset=0),this.index===this.queue.length&&(this.index=-1,this.offset=-1,this.pos=this.endPos);else{let e=0;for(;e<t.length;){const i=Math.min(this.queue[this.index].length-this.offset,t.length-e);if(this.queue[this.index].set(t.subarray(e,e+i),this.offset),e+=i,this.offset+=i,this.pos+=BigInt(i),this.offset===this.queue[this.index].length){if(this.index+1===this.queue.length){if(e<t.length){const i=t.subarray(t.length-e);this.queue.push(i),this.endPos+=BigInt(i.length)}this.pos=this.endPos,this.index=-1,this.offset=-1;break}this.index++,this.offset=0}}}}seek(t){if(t<this.startPos||t>this.endPos)return!1;this.pos=t,this.index=-1,this.offset=-1;let e=this.startPos;for(let i=0;i<this.queue.length;i++){if(t<=e+BigInt(this.queue[i].length)){this.index=i,this.offset=Number(t-e);break}e+=BigInt(this.queue[i].length)}return this.index<0&&(this.pos=this.endPos),!0}flush(){this.startPos=this.endPos,this.pos=this.endPos,this.index=-1,this.offset=-1;const t=(0,r.A)(Uint8Array,this.queue);return this.queue.length=0,t}get size(){return this.queue.length}}},18182:(t,e,i)=>{t.exports=i(69727)},77034:(t,e,i)=>{"use strict";i(47382);var a=i(92046);t.exports=a.Math.trunc},47382:(t,e,i)=>{"use strict";i(11091)({target:"Math",stat:!0},{trunc:i(41176)})},69727:(t,e,i)=>{"use strict";var a=i(77034);t.exports=a}}]);