(self.webpackChunkAVTranscoder=self.webpackChunkAVTranscoder||[]).push([[257],{51597:(t,e,i)=>{"use strict";i.d(e,{A:()=>a});var r=i(49859);class a{constructor(){(0,r.A)(this,"type",-1)}async destroy(t){}}(0,r.A)(a,"Capabilities",[])},52257:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>A});var r=i(49859),a=i(71426),n=i.n(a),s=i(5496),o=i.n(s),c=i(63939),d=i(51597),g=i(4624),f=i(9705),h=i(64093),l=i(77231),p=i(43607),u=i(75294),m=i(31608),w=i(729),x=i(19028),b=i(14686),T=i(50011),v=i(95335);const k="src/avformat/formats/OMp3Format.ts",U={id3v2Version:4,hasID3v1:!1,hasXing:!0};class A extends d.A{constructor(t={}){super(),(0,r.A)(this,"type",14),(0,r.A)(this,"options",void 0),(0,r.A)(this,"context",void 0),(0,r.A)(this,"xingWriter",void 0),this.options=v.X$({},U,t)}init(t){var e;return t.ioWriter.setEndian(!0),this.context={size:0,frames:0,seen:0,want:1,bag:[],pos:0,initialBitrate:0,hasVariableBitrate:!1,padding:0,delay:0,frameHeader:new u.Vz,xingOffset:-1,xingFrameSize:0,xingFrameOffset:BigInt(0),xingFramePos:BigInt(0),audioSize:0,id3SizePos:BigInt(0)},this.xingWriter=new w.A(new Uint8Array(5e3)),n()(e=t.streams).call(e,(t=>86017===t.codecpar.codecId))?0:(g.z3("can not found stream with mp3 codec",k,126),f.UY)}writeXingTag(t){var e,i,r,a;if(!this.options.hasXing)return;const s=n()(e=t.streams).call(e,(t=>86017===t.codecpar.codecId));let c=-1,d=0,f=-1,w=-1,x=BigInt(0|l.go),b=0,v=0;const U=[44100,48e3,32e3];for(let t=0;t<U.length;t++){const e=U[t];if(s.codecpar.sampleRate===e)b=3;else if(s.codecpar.sampleRate===e/2)b=2;else{if(s.codecpar.sampleRate!==e/4)continue;b=0}c=t}if(c===U.length)return void g.R8("unsupported sample rate, not writing Xing header.",k,172);switch(s.codecpar.chLayout.nbChannels){case 1:d=3;break;case 2:d=0;break;default:return void g.R8("unsupported number of channels, not writing Xing header.",k,186)}let A=-16777216;for(A|=(227|b<<3)<<16,A|=c<<2<<8,A|=d<<6,f=1;f<15;f++){let t=BigInt(Math.floor(1e3*h.oz(b,2,f))),e=p.tn(t-s.codecpar.bitrate);e<x&&(x=e,w=f)}for(f=w;;f++){let t=f<<12;if(15==f)return;A|=t,u.qg(this.context.frameHeader,A);const e=[[0,9,17],[0,0,0],[0,9,17],[0,17,32]];if(this.context.xingOffset=e[this.context.frameHeader.version][s.codecpar.chLayout.nbChannels]+4,v=this.context.xingOffset+m.FN,v<=u.CM(this.context.frameHeader,s.codecpar.sampleRate))break;A&=~t}this.xingWriter.writeUint32(A),this.xingWriter.writeBuffer(o()(i=new Uint8Array(this.context.xingOffset-4)).call(i,0)),this.xingWriter.writeString("Xing"),this.xingWriter.writeUint32(15),this.context.size=u.CM(this.context.frameHeader,s.codecpar.sampleRate),this.context.want=1,this.context.seen=0,this.context.pos=0,this.xingWriter.writeUint32(0),this.xingWriter.writeUint32(0);for(let t=0;t<m.W8;t++)this.xingWriter.writeUint8(255*t/m.W8>>>0);this.xingWriter.writeUint32(0);const W=s.metadata||{};if(W.encoder){const t=T.encode(W.encoder);this.xingWriter.writeBuffer(t.subarray(0,9))}else{var I;this.xingWriter.writeString("Lavf"),this.xingWriter.writeBuffer(o()(I=new Uint8Array(5)).call(I,0))}this.xingWriter.writeUint8(0),this.xingWriter.writeUint8(0),this.xingWriter.writeBuffer(o()(r=new Uint8Array(8)).call(r,0)),this.xingWriter.writeUint8(0),this.xingWriter.writeUint8(0),this.xingWriter.writeUint24(0),this.xingWriter.writeUint8(0),this.xingWriter.writeUint8(0),this.xingWriter.writeUint16(0),this.xingWriter.writeUint32(0),this.xingWriter.writeUint16(0),this.xingWriter.writeUint16(0),this.xingWriter.writeBuffer(o()(a=new Uint8Array(this.context.size-v)).call(a,0)),this.context.xingFrameSize=this.xingWriter.getPos(),this.context.xingFrameOffset=t.ioWriter.getPos(),t.ioWriter.writeBuffer(this.xingWriter.getWroteBuffer()),this.context.audioSize=this.context.xingFrameSize}xingAddFrame(t){if(this.context.frames++,this.context.seen++,this.context.size+=c.f[15](t+28),this.context.want===this.context.seen){if(this.context.bag[this.context.pos]=this.context.size,400==++this.context.pos){for(let t=1;t<400;t+=2)this.context.bag[t>>1]=this.context.bag[t];this.context.want*=2,this.context.pos=200}this.context.seen=0}}updateXing(t){this.context.hasVariableBitrate&&(this.xingWriter.seek(this.context.xingOffset),this.xingWriter.writeString("Info")),this.xingWriter.seek(this.context.xingOffset+8),this.xingWriter.writeUint32(this.context.frames),this.xingWriter.writeUint32(this.context.size),this.xingWriter.seek(this.context.xingFrameSize);const e=this.xingWriter.getWroteBuffer().subarray(this.context.xingOffset+16);e[0]=0;for(let t=1;t<m.W8;t++){let i=t*this.context.pos/m.W8>>>0;const r=256*this.context.bag[i]/this.context.size>>>0;e[t]=Math.min(r,255)}const i=t.ioWriter.getPos();t.ioWriter.seek(this.context.xingFrameOffset),t.ioWriter.writeBuffer(this.xingWriter.getWroteBuffer()),t.ioWriter.seek(i)}writeHeader(t){var e;const i=n()(e=t.streams).call(e,(t=>86017===t.codecpar.codecId));if(this.options.id3v2Version){const e=x.VO(t,this.options.id3v2Version);x.M9(t.ioWriter,this.options.id3v2Version,t.metadataHeaderPadding,v.X$({apic:e},t.metadata,i.metadata))}return this.options.hasXing&&this.writeXingTag(t),0}writeAVPacket(t,e){if(!c.f[15](e+28))return void g.R8(`packet's size is 0: ${c.f[15](e+32)}, ignore it`,k,377);const i=t.getStreamByIndex(c.f[15](e+32));if(!i||1024&i.disposition)g.R8(`can not found the stream width the packet's streamIndex: ${c.f[15](e+32)}, ignore it`,k,384);else{if(86017===i.codecpar.codecId){if(c.f[20](e+24)&&c.f[15](e+28)>4){u.qg(this.context.frameHeader,c.f[8](c.f[20](e+24)));const i=h.oz(this.context.frameHeader.version,this.context.frameHeader.layer,this.context.frameHeader.bitrateIndex);this.context.initialBitrate?i!==this.context.initialBitrate&&(this.context.hasVariableBitrate=!0):this.context.initialBitrate=i,this.xingAddFrame(e),t.ioWriter.writeBuffer((0,b.s3)(c.f[20](e+24),c.f[15](e+28)))}return 0}g.R8(`packet's codecId is not mp3: ${c.f[15](e+32)}, ignore it`,k,389)}}writeTrailer(t){if(this.options.hasID3v1){var e;const i=n()(e=t.streams).call(e,(t=>86017===t.codecpar.codecId)),r=v.X$({},t.metadata,i.metadata),a=new Uint8Array(m.c1),s=new w.A(a);function o(t){const e=T.encode(t);s.writeBuffer(e.subarray(0,30)),e.length<30&&s.skip(30-e.length)}s.writeString("TAG"),r.title?o(r.title):s.skip(30),r.artist?o(r.artist):s.skip(30),r.album?o(r.album):s.skip(30),a[127]=255,r.genre&&(a[127]=+r.genre),t.ioWriter.writeBuffer(a)}return this.options.hasXing&&this.updateXing(t),t.ioWriter.flush(),0}flush(t){return t.ioWriter.flush(),0}getCapabilities(){return A.Capabilities}}(0,r.A)(A,"Capabilities",[86017])},75294:(t,e,i)=>{"use strict";i.d(e,{CM:()=>o,Vz:()=>n,qg:()=>s});var r=i(49859),a=i(64093);class n{constructor(){(0,r.A)(this,"version",void 0),(0,r.A)(this,"layer",void 0),(0,r.A)(this,"protection",void 0),(0,r.A)(this,"bitrateIndex",void 0),(0,r.A)(this,"samplingFrequency",void 0),(0,r.A)(this,"padding",void 0),(0,r.A)(this,"private",void 0),(0,r.A)(this,"mode",void 0),(0,r.A)(this,"modeExtension",void 0),(0,r.A)(this,"copyright",void 0),(0,r.A)(this,"original",void 0),(0,r.A)(this,"emphasis",void 0)}}function s(t,e){t.version=e>>19&3,t.layer=e>>17&3,t.protection=e>>16&1,t.bitrateIndex=e>>12&15,t.samplingFrequency=e>>10&3,t.padding=e>>9&1,t.mode=e>>6&3,t.modeExtension=e>>4&3,t.copyright=e>>3&1,t.original=e>>2&1,t.emphasis=3&e}function o(t,e){let i=a.oz(t.version,t.layer,t.bitrateIndex);switch(t.layer){case 1:default:i=144e3*i/(e<<(3===t.version?0:1))>>>0,i+=t.padding;break;case 2:i=144e3*i/e>>>0,i+=t.padding;break;case 3:i=12e3*i/e>>>0,i=4*(i+t.padding)}return i}},19028:(t,e,i)=>{"use strict";i.d(e,{In:()=>I,M9:()=>M,VO:()=>N,fz:()=>P,hm:()=>z,qg:()=>O});var r=i(52730),a=i.n(r),n=i(86226),s=i.n(n),o=i(18979),c=i.n(o),d=i(5496),g=i.n(d),f=i(64007),h=i.n(f),l=i(63939),p=i(50932),u=i(4624),m=i(50011),w=i(35336),x=i(31865),b=i(71517),T=i(37837),v=i(14686),k=i(72739),U=i(95335),A=i(92647);const W="src/avformat/formats/mp3/id3v2.ts",I={JPG:7,PNG:61,"image/gif":97,"image/jpeg":7,"image/jpg":7,"image/png":61,"image/tiff":96,"image/bmp":78,"image/webp":171},P=["Other","32x32 pixels 'file icon'","Other file icon","Cover (front)","Cover (back)","Leaflet page","Media (e.g. label side of CD)","Lead artist/lead performer/soloist","Artist/performer","Conductor","Band/Orchestra","Composer","Lyricist/text writer","Recording Location","During recording","During performance","Movie/video screen capture","A bright coloured fish","Illustration","Band/artist logotype","Publisher/Studio logotype"];function B(t,e){t.writeUint8(e>>21&127),t.writeUint8(e>>14&127),t.writeUint8(e>>7&127),t.writeUint8(127&e)}function S(t,e){let i="utf-8";return 0===t?i="iso-8859-1":1===t?i="utf-16":2===t&&(i="utf-16be"),new TextDecoder(i).decode(e)}function y(t){return(127&t)+((32512&t)>>1)+((8323072&t)>>2)+((2130706432&t)>>3)}async function C(t,e){await t.seek(e);const i=await t.readString(4);return/^[A-Z0-9]+$/.test(i)}async function O(t,e,i,r){const n=2!==i.version,s=n?10:6;let o=t.getPos()+BigInt(0|e);async function c(){await t.skip(Number(BigInt.asIntN(32,o-t.getPos())))}if(n&&64&a()(i)){let r=await async function(t,e){let i=0;for(;e--;)i=(i<<7)+(127&await t.readUint8());return i}(t,4);if(4===i.version&&(r-=4),r<0)return u.z3("invalid extended header length",W,149),await c();if(await t.skip(r),(e-=r+4)<0)return u.z3("extended header too long",W,155),await c()}for(;e>s;){let o,c;if(n){if(o=await t.readString(4),c=await t.readUint32(),!c){u.z3("invalid frame size",W,168);break}if(4===i.version&&c>127)if(c<e){await t.flush();const e=t.getPos();if(!(1&a()(t)||6+c<t.remainingLength()))break;if(await C(t,e+BigInt(2)+BigInt(y(c))))c=y(c);else if(!await C(t,e+BigInt(2)+BigInt(c)))break;await t.seek(e)}else c=y(c);await t.readUint16()}else o=await t.readString(3),c=await t.readUint24();if("APIC"===o)r.apic||(r.apic=[]),r.apic.push(await t.readBuffer(c));else if("USLT"===o){const e=await t.readUint8(),i=await t.readString(3),a=await t.readBuffer(c-4);r.lyrics=`${i} ${S(e,a)}`}else if("COMM"===o||"COM"===o){const e=await t.readUint8(),i=await t.readString(3),a=await t.readBuffer(c-4);r.comment=`${i} ${S(e,a)}`}else if("PRIV"===o){const e=t.getPos(),i=[];for(;;){const e=await t.readUint8();if(0===e)break;i.push(e)}const a=m.decode(new Uint8Array(i));let n;n="com.apple.streaming.transportStreamTimestamp"===a?await t.readUint64():await t.readBuffer(c-Number(t.getPos()-e)),r[a]=n}else{let e;switch(e="T"===o[0]?S(await t.readUint8(),await t.readBuffer(c-1)):await t.readBuffer(c),o){case"TIT2":case"TT2":r.title=e;break;case"TPE1":case"TP1":r.artist=e;break;case"TPE2":case"TP2":r.albumArtist=e;break;case"TPOS":r.disc=e;break;case"TCOP":r.copyright=e;break;case"TALB":case"TAL":r.album=e;break;case"TRCK":case"TRK":r.track=e;break;case"TYER":case"TDRL":case"TDRC":r.date=e;break;case"COMM":case"COM":r.comment=e;break;case"TCON":case"TCO":r.genre=e;break;case"TSSE":case"TEN":r.encoder=e;break;case"TCOM":r.composer=e;break;case"TENC":r.vendor=e;break;case"TLAN":r.language=e;break;case"TPE3":case"TP3":r.performer=e;break;case"TPUB":r.publisher=e;break;case"TCMP":case"TCP":r.compilation=e;break;case"TDEN":r.creationTime=e;break;case"TSOA":r.albumSort=e;break;case"TSOP":r.artistSort=e;break;case"TSOT":r.titleSort=e;break;case"TIT1":r.grouping=e;break;default:r[o]=e}}e-=c+s}4==i.version&&16&a()(i)&&(o+=BigInt(10)),await t.skip(Number(BigInt.asIntN(32,o-t.getPos())))}function z(t,e,i){const r=2!==i.version;s()(e).call(e,(e=>{const i=new x.A(e),a=i.readUint8();let n;function s(){let t=Number(i.getPos());for(;t<e.length&&e[t];)t++;return t}if(r?(n=i.readString(s()-Number(i.getPos())),i.skip(1)):n=i.readString(3),!I[n])return;const o=i.readUint8();let c;const d=s()-Number(i.getPos());d&&(c=S(a,i.readBuffer(d))),i.skip(1);const g=t.createStream();g.codecpar.codecId=I[n],g.codecpar.codecType=0,g.disposition|=1024,g.attachedPic=(0,b._5)(),p.M[15](g.attachedPic+32,g.index);const f=i.remainingSize(),h=(0,T.sY)(f),u=i.readBuffer(f);(0,v.lW)(h,f,u),u.length>=8&&k.FB(u.subarray(0,8),new Uint8Array([137,80,78,71,13,10,26,10]))&&(g.codecpar.codecId=61),(0,b.NX)(g.attachedPic,h,f),p.M[15](g.attachedPic+36,1|l.f[15](g.attachedPic+36)),g.metadata.comment=P[o],c&&(g.metadata.title=c)}))}function M(t,e,i,r){var a;let n=t.getPos();t.writeString("ID3"),t.writeUint8(e),t.writeUint16(0);const o=t.getPos();function d(i,r){const a=m.encode(r);t.writeString(i),4===e?B(t,a.length+1):t.writeUint32(a.length+1),t.writeUint16(0),t.writeUint8(3),t.writeBuffer(a)}function f(i,r){t.writeString(i),4===e?B(t,r.length):t.writeUint32(r.length),t.writeUint16(0),t.writeBuffer(r)}var h;if(t.writeUint32(0),r.poster&&f("APIC",r.poster),r.apic&&s()(h=r.apic).call(h,(t=>{f("APIC",t)})),r.title&&d("TIT2",r.title),r.artist&&d("TPE1",r.artist),r.albumArtist&&d("TPE2","albumArtist"),r.disc&&d("TPOS",r.disc),r.copyright&&d("TCOP",r.copyright),r.album&&d("TALB",r.album),r.track&&d("TRCK",r.track),r.date&&d("TDRC",r.date),r.comment){let t=r.comment;" "===t[3]&&(t=c()(t).call(t,0,3)+c()(t).call(t,4)),d("COMM",t)}if(r.lyrics){let t=r.lyrics;" "===t[3]&&(t=c()(t).call(t,0,3)+c()(t).call(t,4)),d("USLT",t)}r.genre&&d("TCON",r.genre+""),r.encoder&&d("TSSE",r.encoder),r.composer&&d("TCOM",r.composer),r.vendor&&d("TENC",r.vendor),r.language&&d("TLAN",r.language),r.performer&&d("TPE3",r.performer),r.publisher&&d("TPUB",r.publisher),r.compilation&&d("TCMP",r.compilation),r.creationTime&&d("TDEN",r.creationTime),r.albumSort&&d("TSOA",r.albumSort),r.artistSort&&d("TSOP",r.artistSort),r.titleSort&&d("TSOT",r.titleSort),r.grouping&&d("TIT1",r.grouping),i<10&&(i=10);const l=Number(BigInt.asIntN(32,t.getPos()-n));i>268435455-l&&(i=268435455-l),t.writeBuffer(g()(a=new Uint8Array(i)).call(a,0)),n=t.getPos(),t.seek(o),B(t,l),t.seek(n)}function N(t,e){var i;const r=[],a=new w.A,n=[];a.onFlush=t=>(n.push(c()(t).call(t)),0);const o=2!==e;return s()(i=t.streams).call(i,(t=>{if(1024&t.disposition&&(o&&(7===t.codecpar.codecId||61===t.codecpar.codecId||96===t.codecpar.codecId||97===t.codecpar.codecId||171===t.codecpar.codecId||78===t.codecpar.codecId)||!o&&(61===t.codecpar.codecId||7===t.codecpar.codecId))&&t.attachedPic){n.length=0,a.writeUint8(3),o?(a.writeString(U.BE(I)[t.codecpar.codecId]),a.writeUint8(0)):61===t.codecpar.codecId?a.writeString("PNG"):a.writeString("JPG");let e=0;t.metadata.comment&&h()(P).call(P,t.metadata.comment)>-1&&(e=h()(P).call(P,t.metadata.comment)),a.writeUint8(e),t.metadata.description&&a.writeString(t.metadata.description),a.writeUint8(0),a.writeBuffer((0,b.iI)(t.attachedPic)),a.flush(),r.push((0,A.A)(Uint8Array,n))}})),r}},31608:(t,e,i)=>{"use strict";i.d(e,{FN:()=>n,W8:()=>r,c1:()=>a});const r=100,a=128,n=156},52730:(t,e,i)=>{t.exports=i(64055)},60974:(t,e,i)=>{"use strict";var r=i(88280),a=i(48804),n=RegExp.prototype;t.exports=function(t){return t===n||r(n,t)?a(t):t.flags}},48804:(t,e,i)=>{"use strict";i(9164);var r=i(40663);t.exports=r},9164:()=>{},64055:(t,e,i)=>{"use strict";var r=i(60974);t.exports=r}}]);