(self.webpackChunkAVTranscoder=self.webpackChunkAVTranscoder||[]).push([[3],{64436:(t,e,i)=>{"use strict";i.d(e,{A:()=>n});var a=i(49859),r=i(63939),s=(i(77162),i(37837)),c=i(71766);class n{constructor(){(0,a.A)(this,"inCodecpar",void 0),(0,a.A)(this,"inTimeBase",void 0),(0,a.A)(this,"outCodecpar",void 0)}init(t,e){return this.inCodecpar=(0,s.Gy)(168),(0,c.Yi)(this.inCodecpar,t),this.inTimeBase={den:r.f[15](e+4),num:r.f[15](e)},0}destroy(){this.inCodecpar&&((0,c.dn)(this.inCodecpar),this.inCodecpar=0)}}},26173:(t,e,i)=>{"use strict";i.d(e,{A:()=>m});var a=i(49859),r=i(63939),s=i(50932),c=i(64436),n=i(71517),o=i(62815),d=i(67659),h=i(59166),l=i(14686),p=i(9705),f=i(37837),u=i(4624);class m extends c.A{constructor(t=!1){super(),(0,a.A)(this,"cache",void 0),(0,a.A)(this,"cached",void 0),(0,a.A)(this,"reverseSps",void 0),this.reverseSps=t}init(t,e){return super.init(t,e),this.cache=(0,n._5)(),this.cached=!1,0}destroy(){super.destroy(),(0,n.Qe)(this.cache),this.cache=0}sendAVPacket(t){if(64&r.f[15](t+36)){let e;(0,n.zu)(this.cache,t);const i=(0,l.JW)(r.f[20](t+24),r.f[15](t+28));if(27===r.f[15](this.inCodecpar+4)?e=o.oT(i,this.reverseSps):173===r.f[15](this.inCodecpar+4)?e=d.oT(i,this.reverseSps):196===r.f[15](this.inCodecpar+4)?e=h.oT(i,this.reverseSps):u.h2(`not support for codecId: ${r.f[15](this.inCodecpar+4)}`,"src/avformat/bsf/h2645/Annexb2AvccFilter.ts",97),s.M[15](this.cache+36,-65&r.f[15](this.cache+36)),(0,n.NX)(this.cache,e.bufferPointer,e.length),e.key&&s.M[15](this.cache+36,1|r.f[15](this.cache+36)),e.extradata){const t=(0,f.sY)(e.extradata.length);(0,l.lW)(t,e.extradata.length,e.extradata),(0,n.Ow)(this.cache,1,t,e.extradata.length)}}else(0,n.rN)(this.cache,t);return this.cached=!0,0}receiveAVPacket(t){return this.cached?((0,n.Up)(t),(0,n.rN)(t,this.cache),this.cached=!1,0):p.LR}reset(){return 0}}},4003:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>E});var a=i(49859),r=i(18979),s=i.n(r),c=i(96319),n=i.n(c),o=i(71426),d=i.n(o),h=i(86226),l=i.n(h),p=i(48079),f=i.n(p),u=i(61499),m=i(63939),g=i(9599),w=i(29170),U=i(51597),v=i(58121),I=i(68243),x=i(72739),b=i(35028),M=i(92647),y=i(14686),k=i(4624),A=i(71517),D=i(44328),S=i(26173),P=i(77231),W=i(65977),T=i(73040),F=i(94889),B=i(62815),z=i(67659),C=i(59166),N=i(60264),_=i(35336);const L="src/avformat/formats/OFlvFormat.ts";class E extends U.A{constructor(t={}){super(),(0,a.A)(this,"type",0),(0,a.A)(this,"context",void 0),(0,a.A)(this,"header",void 0),(0,a.A)(this,"script",void 0),(0,a.A)(this,"options",void 0),(0,a.A)(this,"annexb2AvccFilter",void 0),(0,a.A)(this,"avpacket",void 0),(0,a.A)(this,"headerWriter",void 0),(0,a.A)(this,"headerBuffers",void 0),this.header=new v.A,this.script=new I.A,this.headerWriter=new _.A(1e5),this.headerBuffers=[],this.headerWriter.onFlush=t=>(this.headerBuffers.push(s()(t).call(t)),0),this.options=t,this.context={keyframeFilePositions:[],keyFrameTimes:[],lastkeyframelocation:0,lastkeyframetimestamp:BigInt(0),lasttimestamp:BigInt(0),framerate:0,filesize:0,audioSize:0,videosize:0,datasize:0,duration:0,scriptWrote:!1,frameCount:0,firstKeyframePositionWrote:!1,videoMetadataWrote:!1,enableNanoTimestamp:t.enableNanoTimestamp,multiAudioTracks:!1,multiVideoTracks:!1,useLegacyHevc:t.useLegacyHevc}}getDefaultStream(t,e){var i;let a=n()(i=t.streams).call(i,(t=>t.codecpar.codecType===e&&!(1024&t.disposition)));if(a.length<2)return a[0];const r=n()(a).call(a,(t=>!(this.isEnhancedStream(t)||1024&t.disposition)));return d()(r).call(r,(t=>!!(1&t.disposition)))||r[0]||a[0]}isEnhancedStream(t){if(this.context.enableNanoTimestamp)return!0;const e=t.privData;return!(this.context.useLegacyHevc&&173===t.codecpar.codecId&&!e.trackId&&!this.context.multiVideoTracks)&&(F.C$(t.codecpar.codecId)||(null==e?void 0:e.trackId)>0)}init(t){var e;t.ioWriter&&t.ioWriter.setEndian(!0);const i=this.getDefaultStream(t,1),a=this.getDefaultStream(t,0);let r=1,s=1;return l()(e=t.streams).call(e,(t=>{if(!(1024&t.disposition))if(1===t.codecpar.codecType){this.header.hasAudio=!0,this.script.onMetaData.hasAudio=!0,86051===t.codecpar.codecId&&(16e3!==t.codecpar.sampleRate&&k.h2("flv speex only support 16000 sample rate",L,170),1!==t.codecpar.chLayout.nbChannels&&k.h2("flv speex only support 1 channel",L,173));let a=0;var e;t===i?(this.script.onMetaData.audiocodecid=null!==(e=b.FV[t.codecpar.codecId])&&void 0!==e?e:(0,W.A)(b.Tf[t.codecpar.codecId]),this.script.onMetaData.stereo=t.codecpar.chLayout.nbChannels>1,this.script.onMetaData.audiosamplerate=t.codecpar.sampleRate||0,this.script.onMetaData.audiosamplesize=t.codecpar.frameSize||0):(a=r++,this.script.onMetaData.audioTrackIdInfoMap||(this.script.onMetaData.audioTrackIdInfoMap={}),this.script.onMetaData.audioTrackIdInfoMap[a]={audiocodecid:b.Tf[t.codecpar.codecId]?(0,W.A)(b.Tf[t.codecpar.codecId]):b.FV[t.codecpar.codecId],stereo:t.codecpar.chLayout.nbChannels>1,audiosamplerate:t.codecpar.sampleRate||0,audiosamplesize:t.codecpar.frameSize||0},t.metadata.title&&(this.script.onMetaData.audioTrackIdInfoMap[a].title=t.metadata.title),t.metadata.language&&(this.script.onMetaData.audioTrackIdInfoMap[a].lang=t.metadata.language)),t.privData={trackId:a}}else if(0===t.codecpar.codecType){this.header.hasVideo=!0,this.script.onMetaData.hasVideo=!0,27!==a.codecpar.codecId&&173!==a.codecpar.codecId&&196!==a.codecpar.codecId||this.annexb2AvccFilter||(this.annexb2AvccFilter=new S.A,this.annexb2AvccFilter.init(a.codecpar[u.o9],a.timeBase[u.o9]));let e=0;var c;t===a?(this.script.onMetaData.videocodecid=null!==(c=b.FV[t.codecpar.codecId])&&void 0!==c?c:(0,W.A)(b.Tf[t.codecpar.codecId]),this.script.onMetaData.width=t.codecpar.width||0,this.script.onMetaData.height=t.codecpar.height||0,this.script.onMetaData.framerate=(0,D.lb)(t.codecpar.framerate)):(e=s++,this.script.onMetaData.videoTrackIdInfoMap||(this.script.onMetaData.videoTrackIdInfoMap={}),this.script.onMetaData.videoTrackIdInfoMap[e]={videocodecid:b.Tf[t.codecpar.codecId]?(0,W.A)(b.Tf[t.codecpar.codecId]):b.FV[t.codecpar.codecId],width:t.codecpar.width||0,height:t.codecpar.height||0,framerate:(0,D.lb)(t.codecpar.framerate)},t.metadata.title&&(this.script.onMetaData.videoTrackIdInfoMap[e].title=t.metadata.title),t.metadata.language&&(this.script.onMetaData.videoTrackIdInfoMap[e].lang=t.metadata.language)),t.privData={trackId:e}}})),r>1&&(this.context.multiAudioTracks=!0),s>1&&(this.context.multiVideoTracks=!0),this.avpacket=(0,A._5)(),0}async destroy(t){this.annexb2AvccFilter&&(this.annexb2AvccFilter.destroy(),this.annexb2AvccFilter=null),this.avpacket&&((0,A.Qe)(this.avpacket),this.avpacket=0)}writeMetadata(t,e){if((173===e.codecpar.codecId||167===e.codecpar.codecId||225===e.codecpar.codecId)&&this.isEnhancedStream(e)){const i=(0,A.Un)(e.codecpar[u.o9]+20,e.codecpar[u.o9]+24,22),a=(0,A.Un)(e.codecpar[u.o9]+20,e.codecpar[u.o9]+24,20),r={colorConfig:{}};if(2!==e.codecpar.colorTrc&&(r.colorConfig.transferCharacteristics=e.codecpar.colorTrc),2!==e.codecpar.colorSpace&&(r.colorConfig.matrixCoefficients=e.codecpar.colorSpace),2!==e.codecpar.colorPrimaries&&(r.colorConfig.colorPrimaries=e.codecpar.colorPrimaries),i){const t=m.f[20](i);r.hdrCll={maxCLL:m.f[8](t),maxFall:m.f[8](t+4)}}if(a){const t=m.f[20](a);r.hdrMdcv={},m.f[15](t+80)&&(r.hdrMdcv.redX=(0,D.lb)((0,w.A)(t,g.P)),r.hdrMdcv.redY=(0,D.lb)((0,w.A)(t+8,g.P)),r.hdrMdcv.greenX=(0,D.lb)((0,w.A)(t+16,g.P)),r.hdrMdcv.greenY=(0,D.lb)((0,w.A)(t+16+8,g.P)),r.hdrMdcv.blueX=(0,D.lb)((0,w.A)(t+32,g.P)),r.hdrMdcv.blueY=(0,D.lb)((0,w.A)(t+32+8,g.P)),r.hdrMdcv.whitePointX=(0,D.lb)((0,w.A)(t+48,g.P)),r.hdrMdcv.whitePointY=(0,D.lb)((0,w.A)(t+48+8,g.P))),m.f[15](t+84)&&(r.hdrMdcv.maxLuminance=(0,D.lb)((0,w.A)(t+72,g.P)),r.hdrMdcv.minLuminance=(0,D.lb)((0,w.A)(t+64,g.P)))}F.M5(t.ioWriter,9,BigInt(0),(t=>{F.Q4(t,e,this.context,!0,4,1,BigInt(0),0)}),(t=>{T.bD(t,"colorInfo"),T.bD(t,r)}))}}writeMultichannelConfig(t,e){this.isEnhancedStream(e)&&1===e.codecpar.codecType&&F.M5(t.ioWriter,8,BigInt(0),(t=>{F.zk(t,e,this.context,!0,4,BigInt(0),0)}),(t=>{switch(e.codecpar.chLayout.order){case 1:t.writeUint8(1);break;case 2:t.writeUint8(2);break;default:t.writeUint8(0)}if(t.writeUint8(e.codecpar.chLayout.nbChannels),1===e.codecpar.chLayout.order){let i=e.codecpar.chLayout.u.mask&BigInt(262143);i|=e.codecpar.chLayout.u.mask>>BigInt(35)-BigInt(18)&BigInt(16515072),t.writeUint32(Number(BigInt.asUintN(32,i)))}else if(2===e.codecpar.chLayout.order)for(let i=0;i<e.codecpar.chLayout.nbChannels;i++){const a=m.f[15](f()(e.codecpar.chLayout.u)+24*i);a>=0&&a<=17?t.writeUint8(a-0):a>=35&&a<=40?t.writeUint8(a-35+18):512===a?t.writeUint8(254):t.writeUint8(255)}}))}writeHeader(t){var e;return this.header.write(t.ioWriter),t.ioWriter.writeUint32(0),this.options.live&&(this.script.write(t.ioWriter),this.context.scriptWrote=!0),l()(e=t.streams).call(e,(e=>{if(1024&e.disposition)return;const i=e.privData;if(1===e.codecpar.codecType)e.codecpar.extradata&&(this.isEnhancedStream(e)||86018===e.codecpar.codecId)&&F.M5(t.ioWriter,8,BigInt(0),(t=>{F.zk(t,e,this.context,this.isEnhancedStream(e),(this.isEnhancedStream(e),0),BigInt(0),0)}),(0,y.s3)(e.codecpar.extradata,e.codecpar.extradataSize),(t=>{this.context.filesize+=t+4,i.trackId||(this.context.audioSize+=e.codecpar.extradataSize,this.script.onMetaData.hasMetadata=!0),this.context.datasize+=e.codecpar.extradataSize})),this.writeMultichannelConfig(t,e);else if(0===e.codecpar.codecType&&e.codecpar.extradata&&(this.isEnhancedStream(e)||27===e.codecpar.codecId||173===e.codecpar.codecId||12===e.codecpar.codecId)){let a=(0,y.s3)(e.codecpar.extradata,e.codecpar.extradataSize);27!==e.codecpar.codecId&&173!==e.codecpar.codecId&&196!==e.codecpar.codecId||!N.Bs(a)||(27===e.codecpar.codecId?a=B.S1(a):173===e.codecpar.codecId?a=z.S1(a):196===e.codecpar.codecId&&(a=C.S1(a)));const r=t.ioWriter.getPos();F.M5(t.ioWriter,9,BigInt(0),(t=>{F.Q4(t,e,this.context,this.isEnhancedStream(e),(this.isEnhancedStream(e),0),1,BigInt(0),0)}),a,(t=>{this.context.filesize+=t+4,i.trackId||(this.context.videosize+=e.codecpar.extradataSize,this.script.onMetaData.hasMetadata=!0),this.context.datasize+=e.codecpar.extradataSize,this.context.keyFrameTimes.push(0),this.context.keyframeFilePositions.push(Number(r)),this.context.videoMetadataWrote=!0}))}this.writeMetadata(t,e)})),0}isNewExtradata(t,e){if(t.length===e.codecpar.extradataSize){const i=(0,y.s3)(e.codecpar.extradata,e.codecpar.extradataSize);for(let e=0;e<t.length;e++)if(t[e]!==i[e])return!0}return!1}writeAVPacket(t,e){const i=t.getStreamByIndex(m.f[15](e+32));if(!i||1024&i.disposition)return void k.R8(`can not found the stream width the packet's streamIndex: ${m.f[15](e+32)}, ignore it`,L,522);const a=i.privData;if(1===i.codecpar.codecType){const r=(0,A.rU)(e,1);if(r&&(this.isEnhancedStream(i)||86018===i.codecpar.codecId)){const s=(0,y.s3)(m.f[20](r),m.f[25](r+4));this.isNewExtradata(s,i)&&(F.M5(t.ioWriter,8,(0,D.Mr)(m.f[17](e+16),e+72,P.i0),(t=>{F.zk(t,i,this.context,this.isEnhancedStream(i),(this.isEnhancedStream(i),0),m.f[17](e+16),e+72)}),s,(t=>{this.context.filesize+=t+4})),a.trackId||(this.context.audioSize+=s.length),this.context.datasize+=s.length)}if(m.f[15](e+28)){this.headerWriter.reset(),this.headerBuffers.length=0,F.zk(this.headerWriter,i,this.context,this.isEnhancedStream(i),(this.isEnhancedStream(i),1),m.f[17](e+16),e+72),this.headerWriter.flush();const a=(0,M.A)(Uint8Array,this.headerBuffers),r=t.ioWriter.getPos();t.ioWriter.writeUint8(8),t.ioWriter.writeUint24(m.f[15](e+28)+a.length);const s=(0,D.Mr)(m.f[17](e+16),e+72,P.i0);t.ioWriter.writeUint24(Number(s&BigInt(16777215))),t.ioWriter.writeUint8(Number(s>>BigInt(24)&BigInt(255))),t.ioWriter.writeUint24(0),t.ioWriter.writeBuffer(a),t.ioWriter.writeBuffer((0,y.s3)(m.f[20](e+24),m.f[15](e+28)));const c=Number(t.ioWriter.getPos()-r);t.ioWriter.writeUint32(c),this.context.filesize+=c+4}a.trackId||(this.context.audioSize+=m.f[15](e+28),this.context.lasttimestamp=(0,D.Mr)(m.f[17](e+8),e+72,P.i0)),this.context.datasize+=m.f[15](e+28)}else if(0===i.codecpar.codecType){(27===i.codecpar.codecId||173===i.codecpar.codecId||196===i.codecpar.codecId)&&64&m.f[15](e+36)&&(this.annexb2AvccFilter.sendAVPacket(e),this.annexb2AvccFilter.receiveAVPacket(this.avpacket),e=this.avpacket);const r=t.ioWriter.getPos(),s=(0,A.rU)(e,1);if(s){const r=(0,y.s3)(m.f[20](s),m.f[25](s+4));this.isNewExtradata(r,i)&&(this.isEnhancedStream(i)||27===i.codecpar.codecId||173===i.codecpar.codecId||12===i.codecpar.codecId)&&(F.M5(t.ioWriter,9,(0,D.Mr)(m.f[17](e+16),e+72,P.i0),(t=>{F.Q4(t,i,this.context,this.isEnhancedStream(i),(this.isEnhancedStream(i),0),m.f[15](e+36),m.f[17](e+16),e+72)}),r,(t=>{this.context.filesize+=t+4})),a.trackId||(this.context.videosize+=r.length),this.context.datasize+=r.length)}if(m.f[15](e+28)){let s=0;m.f[17](e+8)!==P.Dh&&(s=Number(BigInt.asIntN(32,(0,D.Mr)(m.f[17](e+8)-m.f[17](e+16),e+72,P.i0))));const c=m.f[17](e+16)===m.f[17](e+8)||173!==i.codecpar.codecId&&196!==i.codecpar.codecId&&27!==i.codecpar.codecId?3:1;this.headerWriter.reset(),this.headerBuffers.length=0,F.Q4(this.headerWriter,i,this.context,this.isEnhancedStream(i),this.isEnhancedStream(i)?c:1,m.f[15](e+36),m.f[17](e+16),e+72,s),this.headerWriter.flush();const n=(0,M.A)(Uint8Array,this.headerBuffers),o=t.ioWriter.getPos();t.ioWriter.writeUint8(9),t.ioWriter.writeUint24(m.f[15](e+28)+n.length);const d=(0,D.Mr)(m.f[17](e+16),e+72,P.i0);t.ioWriter.writeUint24(Number(d&BigInt(16777215))),t.ioWriter.writeUint8(Number(d>>BigInt(24)&BigInt(255))),t.ioWriter.writeUint24(0),t.ioWriter.writeBuffer(n),t.ioWriter.writeBuffer((0,y.s3)(m.f[20](e+24),m.f[15](e+28)));const h=Number(t.ioWriter.getPos()-o);t.ioWriter.writeUint32(h),this.context.filesize+=h+4,a.trackId||(this.context.frameCount++,this.context.videosize+=m.f[15](e+28),this.context.lasttimestamp=(0,D.Mr)(m.f[17](e+8),e+72,P.i0)),this.context.datasize+=m.f[15](e+28),1&m.f[15](e+36)&&(this.context.firstKeyframePositionWrote||!this.context.videoMetadataWrote?(this.context.lastkeyframetimestamp=(0,D.Mr)(m.f[17](e+8),e+72,P.i0),this.context.lastkeyframelocation=Number(r),this.context.keyFrameTimes.push(Number((Number(this.context.lastkeyframetimestamp)*(0,D.lb)(P.i0)).toFixed(2))),this.context.keyframeFilePositions.push(this.context.lastkeyframelocation)):this.context.firstKeyframePositionWrote=!0)}}return 0}writeTrailer(t){var e;if(l()(e=t.streams).call(e,(e=>{if(1024&e.disposition)return;const i=e.privData;(27===e.codecpar.codecId||173===e.codecpar.codecId||12===e.codecpar.codecId||this.isEnhancedStream(e))&&(F.M5(t.ioWriter,9,this.context.lasttimestamp,(t=>{F.Q4(t,e,this.context,this.isEnhancedStream(e),this.isEnhancedStream(e)?(e.codecpar.codecType,2):2,32,this.context.lasttimestamp,0)}),void 0,(t=>{this.context.filesize+=t+4})),0!==e.codecpar.codecType||i.trackId||(this.script.onMetaData.canSeekToEnd=!0))})),this.context.scriptWrote)t.ioWriter.flush();else{t.ioWriter.flush(),this.script.onMetaData.filesize=this.context.filesize,this.script.onMetaData.audiosize=this.context.audioSize,this.script.onMetaData.videosize=this.context.videosize,this.script.onMetaData.datasize=this.context.datasize,this.script.onMetaData.lasttimestamp=this.context.lasttimestamp,this.options.addKeyframePositions?(this.script.onMetaData.lastkeyframetimestamp=this.context.lastkeyframetimestamp,this.script.onMetaData.lastkeyframelocation=this.context.lastkeyframelocation,this.context.keyFrameTimes.length>1?(this.script.onMetaData.hasKeyframes=!0,this.script.onMetaData.keyframes={filepositions:this.context.keyframeFilePositions,times:this.context.keyFrameTimes}):this.script.onMetaData.hasKeyframes=!1):this.script.onMetaData.hasKeyframes=!1,this.script.onMetaData.duration=Number(this.context.lasttimestamp)/1e3,this.script.onMetaData.audiodatarate=this.context.audioSize/this.script.onMetaData.duration/1e3*8,this.script.onMetaData.videodatarate=this.context.videosize/this.script.onMetaData.duration/1e3*8,this.script.onMetaData.framerate=this.context.frameCount/this.script.onMetaData.duration;const e=this.script.computeSize();x.__(this.context.keyframeFilePositions,((t,i)=>{this.context.keyframeFilePositions[i]=t+11+e+4})),this.script.onMetaData.keyframes&&(this.script.onMetaData.keyframes.filepositions=this.context.keyframeFilePositions),this.context.filesize+=11+e+4,this.script.onMetaData.filesize=this.context.filesize;const i=[],a=t.ioWriter.onFlush;t.ioWriter.onFlush=t=>(i.push(s()(t).call(t)),0),this.script.write(t.ioWriter),t.ioWriter.flush(),t.ioWriter.onFlush=a;const r=(0,M.A)(Uint8Array,i);a&&a(r,BigInt(13))}return 0}flush(t){return t.ioWriter.flush(),0}getCapabilities(){return E.Capabilities}}(0,a.A)(E,"Capabilities",[86017,86018,86051,69645,86049,65543,65542,86019,86056,86076,86028,12,27,173,225,167,139,196])},51597:(t,e,i)=>{"use strict";i.d(e,{A:()=>r});var a=i(49859);class r{constructor(){(0,a.A)(this,"type",-1)}async destroy(t){}}(0,a.A)(r,"Capabilities",[])},58121:(t,e,i)=>{"use strict";i.d(e,{A:()=>c});var a=i(49859),r=i(52730),s=i.n(r);class c{constructor(){(0,a.A)(this,"signature",void 0),(0,a.A)(this,"version",void 0),(0,a.A)(this,"flags",void 0),(0,a.A)(this,"dataOffset",void 0),(0,a.A)(this,"hasVideo",void 0),(0,a.A)(this,"hasAudio",void 0),this.signature="FLV",this.version=1,this.flags=0,this.dataOffset=9,this.hasAudio=!1,this.hasVideo=!1}async read(t){this.signature=await t.readString(3),this.version=await t.readUint8(),this.flags=await t.readUint8(),this.dataOffset=await t.readUint32(),this.hasAudio=!!(4&s()(this)),this.hasVideo=!!(1&s()(this))}write(t){this.flags=0,this.hasAudio&&(this.flags|=4),this.hasVideo&&(this.flags|=1),t.writeString(this.signature),t.writeUint8(this.version),t.writeUint8(s()(this)),t.writeUint32(this.dataOffset)}}},68243:(t,e,i)=>{"use strict";i.d(e,{A:()=>p});var a=i(49859),r=i(18979),s=i.n(r),c=i(35336),n=i(92647),o=i(4624),d=i(94889),h=i(9705),l=i(73040);class p{constructor(){(0,a.A)(this,"onMetaData",void 0),this.onMetaData={canSeekToEnd:!1}}async read(t,e){const i=t.getPos(),a=i+BigInt(Math.floor(e)),r=await(0,l.$x)(t,a),s=await(0,l.$x)(t,a);this[r]=s,a>t.getPos()&&await t.skip(Number(BigInt.asIntN(32,a-t.getPos())));const c=Number(t.getPos()-i),n=await t.readUint32();return c+11!==n?(o.R8(`script size not match, size: ${c+11}, previousTagSize: ${n}`,"src/avformat/formats/flv/FlvScriptTag.ts",63),h.LR):0}computeSize(){const t=[],e=new c.A;return e.onFlush=e=>(t.push(s()(e).call(e)),0),(0,l.bD)(e,"onMetaData"),(0,l.bD)(e,this.onMetaData),e.flush(),(0,n.A)(Uint8Array,t).length}write(t){if(this.onMetaData){const e=[],i=new c.A;i.onFlush=t=>(e.push(s()(t).call(t)),0),(0,l.bD)(i,"onMetaData"),(0,l.bD)(i,this.onMetaData),i.flush();const a=(0,n.A)(Uint8Array,e);d.M5(t,18,BigInt(0),void 0,a)}}dts2Position(t){if(this.canSeek()){let e=-1;const i=this.onMetaData.keyframes.times,a=this.onMetaData.keyframes.filepositions;let r;for(r=0;r<i.length;r++){if(i[r]===t){e=r;break}if(i[r]>t){e=Math.max(r-1,0);break}}return r&&r===i.length&&(e=i.length-1),{pos:a[e],dts:i[e]}}return{pos:-1,dts:-1}}position2DTS(t){if(this.canSeek()){let i=-1;const a=this.onMetaData.keyframes.times,r=this.onMetaData.keyframes.filepositions;let s=0;for(s=0;s<r.length;s++)if(r[s]>t){i=s;break}var e;return s===r.length?null!==(e=this.onMetaData.duration)&&void 0!==e?e:a[a.length-1]:a[i]}return-1}canSeek(){return!!(this.onMetaData.keyframes&&this.onMetaData.keyframes.filepositions&&this.onMetaData.keyframes.filepositions.length)}}},35028:(t,e,i)=>{"use strict";i.d(e,{FJ:()=>r,FV:()=>a,Tf:()=>c,U5:()=>s});const a={65541:0,65536:3,86018:10,86017:2,86051:11,69645:1,86049:6,65543:7,65542:8,27:7,173:12,12:9,4:2,86:3,92:4,106:5,131:6},r={10:86018,2:86017,11:86051,1:69645,4:86049,5:86049,6:86049,7:65543,8:65542},s={7:27,12:173,9:12,2:4,3:86,4:92,5:106,6:131},c={27:"avc1",173:"hvc1",196:"vvc1",139:"vp08",167:"vp09",225:"av01",86019:"ac-3",86056:"ec-3",86076:"Opus",86028:"fLaC",86017:".mp3",86018:"mp4a"}},94889:(t,e,i)=>{"use strict";i.d(e,{C$:()=>h,M5:()=>d,Q4:()=>l,zk:()=>p});var a=i(35028),r=i(44328),s=i(77231),c=i(65977),n=i(67672);function o(t,e,i){const a=t.getPos(),r=t.getPointer(),s=a-BigInt(Math.floor(r));e<a&&e>=s?(t.seekInline(r+Number(e-a)),t.writeUint24(i),t.seekInline(r)):(t.seek(e),t.writeUint24(i),t.seek(a))}function d(t,e,i,a,r,s){t.flush(),t.writeUint8(e);const c=t.getPos();t.writeUint24(0),t.writeUint24(Number(i&BigInt(16777215))),t.writeUint8(Number(i>>BigInt(24)&BigInt(255))),t.writeUint24(0);const d=t.getPos();a&&a(t),n.Pc(r)?(r(t),o(t,c,Number(t.getPos()-d))):r&&(o(t,c,r.length+Number(t.getPos()-d)),t.writeBuffer(r));const h=Number(t.getPos()-c)+1;s&&s(h),t.writeUint32(h)}function h(t){return 86018!==t&&27!==t&&86017!==t&&12!==t&&!!a.Tf[t]}function l(t,e,i,n,o,d,h,l,p=0){const f=e.privData;let u=n?128:0;if(u|=(1&d?1:2)<<4,n){if(i.enableNanoTimestamp&&l){const e=(0,r.Mr)(h,l,s.FQ)-(0,r.Mr)(h,l,s.i0)*BigInt(1e6);e&&(u|=7,t.writeUint8(u),t.writeUint8(2),t.writeUint24(Number(BigInt.asIntN(32,e))),u=0)}i.multiVideoTracks&&(u|=6,t.writeUint8(u),u=0),u|=o,t.writeUint8(u),t.writeUint32((0,c.A)(a.Tf[e.codecpar.codecId])),i.multiVideoTracks&&t.writeUint8(f.trackId),1===o&&t.writeInt24(p)}else u|=15&a.FV[e.codecpar.codecId],t.writeUint8(u),27!==e.codecpar.codecId&&173!==e.codecpar.codecId&&196!==e.codecpar.codecId&&12!==e.codecpar.codecId||(t.writeUint8(o),t.writeInt24(p))}function p(t,e,i,n,o,d,h){const l=e.privData;let p=(n?9:15&a.FV[e.codecpar.codecId])<<4;if(n){if(i.enableNanoTimestamp){const e=(0,r.Mr)(d,h,s.FQ)-(0,r.Mr)(d,h,s.i0)*BigInt(1e6);e&&(p|=7,t.writeUint8(p),t.writeUint8(2),t.writeUint24(Number(BigInt.asIntN(32,e))),p=0)}i.multiVideoTracks&&(p|=5,t.writeUint8(p),p=0),p|=o,t.writeUint8(p),t.writeUint32((0,c.A)(a.Tf[e.codecpar.codecId])),i.multiVideoTracks&&t.writeUint8(l.trackId)}else(86018===e.codecpar.codecId||e.codecpar.chLayout.nbChannels>1)&&(p|=1),65541!==e.codecpar.codecId&&(p|=2),86018===e.codecpar.codecId||e.codecpar.sampleRate>=44e3?p|=12:e.codecpar.sampleRate>=22e3?p|=8:e.codecpar.sampleRate>=11e3&&(p|=4),t.writeUint8(p),86018===e.codecpar.codecId&&t.writeUint8(o)}},65977:(t,e,i)=>{"use strict";i.d(e,{A:()=>s});var a=i(4624);const r="src/avformat/function/mktag.ts";function s(t){4!==t.length&&a.R8(`tag length is not 4, tag: ${t}`,r,30);let e=0;for(let i=0;i<4;i++)e=e<<8|t.charCodeAt(i);return e}},59166:(t,e,i)=>{"use strict";i.d(e,{HL:()=>T,KD:()=>V,OD:()=>L,S1:()=>B,Ui:()=>O,XC:()=>E,kM:()=>_,oT:()=>C,sL:()=>z,wA:()=>N,wf:()=>R});var a=i(5496),r=i.n(a),s=i(73363),c=i.n(s),n=i(86226),o=i.n(n),d=i(96319),h=i.n(d),l=i(11393),p=i.n(l),f=i(31721),u=i.n(f),m=i(54810),g=i.n(m),w=i(63939),U=i(72739),v=i(729),I=i(31865),x=i(37246),b=i(14686),M=i(60264),y=i(37837),k=i(23991),A=i(83314),D=i(39381),S=i(82774);const P=3;function W(t){const e=t.readU(9),i=t.readU(3),a=t.readU(2),r=t.readU(2),s=t.readU(3);t.readU(5),t.readU(2);const c=t.readU(6),n=t.readU(7),o=t.readU(1),d=t.readU(8),h=t.readU(1),l=t.readU(1),p=[],f=[];if(c){for(let e=0;e<c-1;e++)p[e]=t.readU(8);p[c-1]=t.readU(6)}else t.readU(6);if(i>1){let e=0;for(let a=i-2;a>=0;--a)e|=t.readU(1)<<a;for(let e=i;e<=8&&i>1;++e)t.readU(1);for(let a=i-2;a>=0;--a)e&1<<a&&(f[a]=t.readU(8))}const u=t.readU(8),m=[];if(u)for(let e=0;e<u;e++)m.push(t.readU(8));return{olsIdx:e,numSublayers:i,bitDepthMinus8:s,chromaFormatIdc:r,constantFrameRate:a,generalProfileIdc:n,generalTierFlag:o,generalLevelIdc:d,ptlFrameOnlyConstraintFlag:h,ptlMultilayerEnabledFlag:l,generalConstraintInfo:p,sublayerLevelIdc:f,generalSubProfileIdc:m,maxPictureWidth:t.readU(16),maxPictureHeight:t.readU(16),avgFramerate:t.readU(16)}}function T(t){const e=new I.A(t,!0);if(1&e.readUint8()){const i=new x.A;i.appendBuffer(t.subarray(1)),W(i),e.skip(i.getPointer())}let i=[],a=[],r=[];const s=e.readUint8();for(let t=0;t<s;t++){const t=31&e.readUint8();let s=1;13!==t&&12!==t&&(s=e.readUint16());const c=[];for(let t=0;t<s;t++){const t=e.readUint16();c.push(e.readBuffer(t))}14===t?i=c:15===t?a=c:16===t&&(r=c)}return{vpss:i,spss:a,ppss:r}}function F(t,e,i){const a=e[0];let s;if(a){const t=R(a);let e=t.generalConstraintInfo;var n;e.length||(e=r()(n=new Array(12)).call(n,0));const i=new A.A;if(i.writeU(9,0),i.writeU(3,t.spsMaxSublayersMinus1+1),i.writeU(2,1),i.writeU(2,t.chromaFormatIdc),i.writeU(3,t.bitDepthMinus8),i.writeU(5,31),i.writeU(2,0),i.writeU(6,e.length),i.writeU(7,t.profile),i.writeU1(t.tierFlag),i.writeU(8,t.level),i.writeU1(t.ptlFrameOnlyConstraintFlag),i.writeU1(t.ptlMultilayerEnabledFlag),e.length){for(let t=0;t<e.length-1;t++)i.writeU(8,e[t]);i.writeU(6,e[e.length-1])}else i.writeU(6,63);if(t.spsMaxSublayersMinus1+1>1){let e=0;for(let i=t.spsMaxSublayersMinus1-1;i>=0;i--)e=e<<1|t.ptlSublayerLevelPresentFlag[i];i.writeU(t.spsMaxSublayersMinus1,e);for(let e=t.spsMaxSublayersMinus1+1;e<=8&&t.spsMaxSublayersMinus1>0;++e)i.writeU1(0);for(let e=t.spsMaxSublayersMinus1-1;e>=0;e--)t.ptlSublayerLevelPresentFlag[e]&&i.writeU(8,t.sublayerLevelIdc[e])}i.writeU(8,t.generalSubProfileIdc.length);for(let e=0;e<t.generalSubProfileIdc.length;e++)i.writeU(8,t.sublayerLevelIdc[e]);i.writeU(16,t.width),i.writeU(16,t.height),i.writeU(16,0),i.padding(),s=i.getBuffer().subarray(0,i.getPointer())}let o=2+(s?s.length:0);t.length&&(o+=3,o=c()(t).call(t,((t,e)=>t+2+e.length),o)),e.length&&(o+=3,o=c()(e).call(e,((t,e)=>t+2+e.length),o)),i.length&&(o+=3,o=c()(i).call(i,((t,e)=>t+2+e.length),o));const d=new Uint8Array(o),h=new v.A(d,!0);h.writeUint8(P<<1|(s?1:0)|248),s&&h.writeBuffer(s);let l=0;return t.length&&l++,e.length&&l++,i.length&&l++,h.writeUint8(l),t.length&&(h.writeUint8(142),h.writeUint16(t.length),U.__(t,(t=>{h.writeUint16(t.length),h.writeBuffer(t)}))),e.length&&(h.writeUint8(143),h.writeUint16(e.length),U.__(e,(t=>{h.writeUint16(t.length),h.writeBuffer(t)}))),i.length&&(h.writeUint8(144),h.writeUint16(i.length),U.__(i,(t=>{h.writeUint16(t.length),h.writeBuffer(t)}))),d}function B(t){let e=M.py(t);if(e.length>=2){const t=[],i=[],a=[];if(o()(e).call(e,(e=>{const r=e[1]>>>3&31;14===r?t.push(e):15===r?i.push(e):16===r&&a.push(e)})),i.length&&a.length)return F(t,i,a)}}function z(t){let e=M.py(t);if(e.length>=2){const t=[],i=[],a=[];if(o()(e).call(e,(e=>{const r=e[1]>>>3&31;14===r?t.push(e):15===r?i.push(e):16===r&&a.push(e)})),i.length&&a.length){const e=[i[0],a[0]];return t.length&&e.unshift(t[0]),M.nW(e,0)}}}function C(t,e=!1){let i,a=!1,r=M.py(t);if(r.length){const t=[],s=[],c=[];o()(r).call(r,(e=>{const i=e[1]>>>3&31;14===i?t.push(e):15===i?s.push(e):16===i&&c.push(e),8!==i&&7!==i&&9!==i&&10!==i||(a=!0)})),s.length&&c.length?(i=F(t,s,c),r=h()(r).call(r,(t=>{const i=t[1]>>>3&31;return(e||14!==i&&15!==i&&16!==i)&&20!==i}))):r=h()(r).call(r,(t=>20!=(t[1]>>>3&31)))}const s=c()(r).call(r,((t,e)=>t+P+1+e.length),0),n=(0,y.sY)(s),d=(0,b.s3)(n,s);return M.S9(r,P,d),{bufferPointer:n,length:s,extradata:i,key:a}}function N(t,e,i,a,r){const s=[M.Le(t,0),M.Le(e,0),M.Le(i,0),M.Le(a,2)];let n=c()(s).call(s,((t,e)=>t+e),0);const o=(0,y.sY)(n+7);let d=o;return S.w8((d+=1,d-1),0),S.w8((d+=1,d-1),0),S.w8((d+=1,d-1),0),S.w8((d+=1,d-1),1),S.w8((d+=1,d-1),0),S.w8((d+=1,d-1),161),S.w8((d+=1,d-1),(r?1:0)<<7|40),t.length&&(M.nW(t,0,(0,b.s3)(d,s[0])),d+=s[0]),e.length&&(M.nW(e,0,(0,b.s3)(d,s[1])),d+=s[1]),i.length&&(M.nW(i,0,(0,b.s3)(d,s[2])),d+=s[2]),a.length&&M.nW(a,2,(0,b.s3)(d,s[3])),{bufferPointer:o,length:n+7}}function _(t,e){var i;let a=p()(i=M.py(t)).call(i,M.py(e));if(a.length){let t=[],e=[],i=[],r=[];return o()(a).call(a,(a=>{const s=a[1]>>>3&31;14===s?t.push(a):15===s?e.push(a):16===s?i.push(a):20!==s&&r.push(a)})),N(t,e,i,r,!0)}}function L(t,e,i=P){var a;e&&(i=e[0]>>>1&3);let r=[],s=[],c=[],n=!1;if(e){const t=T(e);r=t.vpss,s=t.spss,c=t.ppss,n=!0}const d=h()(a=M.wN(t,i)).call(a,(t=>20!=(t[1]>>>3&31))),l=[];return o()(d).call(d,(t=>{const e=t[1]>>>3&31;15!==e||s.length?16!==e||c.length?20!==e&&l.push(t):c.push(t):s.push(t),8!==e&&7!==e||(n=!0)})),{...N(r,s,c,l,n),key:n}}function E(t,e){let i;if(!e&&t.sideData[1]&&(e=t.sideData[1]),e&&M.Bs(e))U.__(M.py(e),(t=>{if(15==(t[1]>>>3&31))return i=t,!1}));else if(e&&e.length>=6){const{spss:t}=T(e);t.length&&(i=t[0])}i&&function(t,e){const{profile:i,level:a,width:r,height:s,videoDelay:c,chromaFormatIdc:n,bitDepthMinus8:o}=R(e);switch(t.codecpar.profile=i,t.codecpar.level=a,t.codecpar.width=r,t.codecpar.height=s,t.codecpar.videoDelay=c,o){case 0:t.codecpar.format=3===n?5:2===n?4:0;break;case 2:t.codecpar.format=3===n?68:2===n?64:62}}(t,i)}function V(t,e=4){if(64&w.f[15](t+36)){let e=M.py((0,b.s3)(w.f[20](t+24),w.f[15](t+28)));return u()(e).call(e,(t=>{const e=t[1]>>>3&31;return 8===e||7===e}))}{const i=w.f[15](t+28);let a=0;for(;a<i-e;){const i=D.r8(w.f[20](t+24)+(a+e+1))>>>3&31;if(8===i||7===i)return!0;a+=4===e?D.Sg(w.f[20](t+24)+a):3===e?D.ht(w.f[20](t+24)+a):2===e?D.yd(w.f[20](t+24)+a):D.r8(w.f[20](t+24)+a),a+=e}return!1}}function R(t){if(!t||t.length<3)return;let e=0;0===t[0]&&0===t[1]&&0===t[2]&&1===t[3]&&(e=4);let i=0,a=0,r=0,s=0,c=0,n=1,o=0,d=0,h=0;const l=[],p=[],f=[],u=[],m=M.BN(t.subarray(e)),w=new x.A(m.length);w.appendBuffer(m),w.readU1(),w.readU1(),w.readU(6),w.readU(5),w.readU(3),w.readU(8);const U=w.readU(3);n=w.readU(2);const v=w.readU(2);if(w.readU(1)){if(i=w.readU(7),o=w.readU(1),a=w.readU(8),d=w.readU(1),h=w.readU(1),w.readU(1)){for(let t=0;t<8;t++)l[t]=w.readU(8);l[8]=w.readU(7);const t=w.readU(8);w.readU(t)}w.skipPadding();for(let t=U-1;t>=0;t--)p[t]=w.readU(1);w.skipPadding();for(let t=U-1;t>=0;t--)p[t]&&(f[t]=w.readU(8));const t=w.readU(8);if(t)for(let e=0;e<t;e++)u[e]=w.readU(32)}w.readU1(),w.readU1()&&w.readU1();const I=r=k.xb(w),b=s=k.xb(w);if(w.readU1()&&(k.xb(w),k.xb(w),k.xb(w),k.xb(w)),w.readU1()){const t=k.xb(w),e=v+5,i=1<<e,a=I/(1<<e),r=b/(1<<e),s=Math.ceil(g()(a)),c=Math.ceil(g()(r));let n=0,o=0,d=0;t>0&&(d=w.readU1(),o=w.readU1());for(let e=0;t>0&&e<=t;e++)o&&0!=e||(e>0&&I>i&&w.readU(s),e>0&&b>i&&w.readU(c),e<t&&I>i&&w.readU(s),e<t&&b>i&&w.readU(c)),d||w.readU(2);if(n=k.xb(w)+1,w.readU(1)&&w.readU(1))for(let e=0;e<=t;e++)w.readU(n)}c=k.xb(w),w.readU(1),w.readU(1);const y=w.readU(4),A=w.readU(1);let D=0;A&&(D=k.xb(w));const S=[],P=w.readU(2);for(let t=0;t<8*P;t++)S[t]=w.readU(1);return{profile:i,level:a,width:r,height:s,videoDelay:U+1>2?2:U,chromaFormatIdc:n,bitDepthMinus8:c,generalProfileSpace:0,tierFlag:o,generalConstraintInfo:l,generalSubProfileIdc:u,ptlFrameOnlyConstraintFlag:d,ptlMultilayerEnabledFlag:h,spsMaxSublayersMinus1:U,ptlSublayerLevelPresentFlag:p,sublayerLevelIdc:f,sps_log2_max_pic_order_cnt_lsb_minus4:y,sps_poc_msb_cycle_flag:A,sps_poc_msb_cycle_len_minus1:D,sps_num_extra_ph_bytes:P,sps_extra_ph_bit_present_flag:S}}function O(t){M.Bs(t)&&(t=B(t));const e=new x.A;return e.appendBuffer(t),1&e.readU(8)?W(e):{}}},73040:(t,e,i)=>{"use strict";i.d(e,{$x:()=>n,bD:()=>o});var a=i(67672),r=i(72739),s=i(95335);async function c(t,e){return{key:await t.readString(await t.readUint16()),value:await n(t,e)}}async function n(t,e){let i;switch(await t.readUint8()){case 0:i=await t.readDouble();break;case 1:i=!!await t.readUint8();break;case 2:i=await t.readString(await t.readUint16());break;case 3:for(i={};t.getPos()<e;){const{key:a,value:r}=await c(t,e);if(i[a]=r,9==(16777215&await t.peekUint24())){await t.skip(3);break}}break;case 8:for(i={},await t.skip(4);t.getPos()<e;){const{key:a,value:r}=await c(t,e);if(i[a]=r,9==(16777215&await t.peekUint24())){await t.skip(3);break}}break;case 9:case 5:i=null;break;case 10:i=[];const a=await t.readUint32();for(let r=0;r<a;r++)i.push(await n(t,e));break;case 11:const r=await t.readDouble(),s=await t.readInt16();i=new Date(r+60*s*1e3);break;case 12:i=await t.readString(await t.readUint32())}return i}function o(t,e){a.ai(e)?(t.writeUint8(0),t.writeDouble(e)):a.o(e)?(t.writeUint8(0),t.writeDouble(Number(e))):a.zM(e)?(t.writeUint8(1),t.writeUint8(e?1:0)):a.Yj(e)?e.length>=65536?(t.writeUint8(12),t.writeUint32(e.length),t.writeString(e)):(t.writeUint8(2),t.writeUint16(e.length),t.writeString(e)):a.YO(e)?(t.writeUint8(10),t.writeUint32(e.length),r.__(e,(e=>{o(t,e)}))):a.Ik(e)?(t.writeUint8(3),s.__(e,((e,i)=>{t.writeUint16(i.length),t.writeString(i),o(t,e)})),t.writeUint24(9)):e instanceof Date?(t.writeUint8(11),t.writeDouble(e.getTime()),t.writeInt16(0)):null==e&&t.writeUint8(5)}},52730:(t,e,i)=>{t.exports=i(64055)},60974:(t,e,i)=>{"use strict";var a=i(88280),r=i(48804),s=RegExp.prototype;t.exports=function(t){return t===s||a(s,t)?r(t):t.flags}},48804:(t,e,i)=>{"use strict";i(9164);var a=i(40663);t.exports=a},9164:()=>{},64055:(t,e,i)=>{"use strict";var a=i(60974);t.exports=a}}]);