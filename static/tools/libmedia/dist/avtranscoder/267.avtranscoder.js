"use strict";(self.webpackChunkAVTranscoder=self.webpackChunkAVTranscoder||[]).push([[267],{267:(e,t,r)=>{r.r(t),r.d(t,{default:()=>w});var i=r(4467),n=r(7127),a=r(9983),s=r(6911),l=r(9681),c=r(3674),o=r(495),d=r(4187),h=r(1755),f=r(1497),u=r(4229),p=r(4096),U=r(9906);const g="packages/avformat/src/formats/OH26XFormat.ts";class w extends s.A{constructor(){super(),(0,i.A)(this,"type",11),(0,i.A)(this,"filter",void 0),(0,i.A)(this,"muxStream",void 0),(0,i.A)(this,"extradata",void 0)}init(e){return 0}async destroy(e){this.filter&&this.filter.destroy()}writeHeader(e){const t=e.streams.find((e=>27===e.codecpar.codecId||173===e.codecpar.codecId||196===e.codecpar.codecId));return t?(this.muxStream=t,1&t.codecpar.flags||(this.filter=new l.A,this.filter.init(t.codecpar[n.o9],t.timeBase[n.o9])),t.codecpar.extradataSize&&(this.extradata=(0,c.s3)(t.codecpar.extradata,t.codecpar.extradataSize).slice()),0):(U.z3("can not found stream with h264, hevc, vvc codec",g,90),o.UY)}writeAVPacket(e,t){if(!a.f[15](t+28))return void U.R8(`packet's size is 0: ${a.f[15](t+32)}, ignore it`,g,110);const r=e.getStreamByIndex(a.f[15](t+32));if(r&&!(1024&r.disposition)&&r===this.muxStream){if(this.filter){if(this.extradata){if(!(0,d.rU)(t,1)){const e=(0,h.sY)(this.extradata.length);(0,c.lW)(e,this.extradata.length,this.extradata),(0,d.Ow)(t,1,e,this.extradata.length)}this.extradata=null}this.filter.sendAVPacket(t),this.filter.receiveAVPacket(t)}else this.extradata&&((27===r.codecpar.codecId&&!f.sL((0,d.iI)(t))||173===r.codecpar.codecId&&!u.sL((0,d.iI)(t))||196===r.codecpar.codecId&&!p.sL((0,d.iI)(t)))&&e.ioWriter.writeBuffer(this.extradata),this.extradata=null);return e.ioWriter.writeBuffer((0,d.iI)(t)),0}U.R8(`can not found the stream width the packet's streamIndex: ${a.f[15](t+32)}, ignore it`,g,117)}writeTrailer(e){return e.ioWriter.flush(),0}flush(e){return e.ioWriter.flush(),0}getCapabilities(){return w.Capabilities}}(0,i.A)(w,"Capabilities",[27,173,196])},3458:(e,t,r)=>{r.d(t,{A:()=>l});var i=r(4467),n=r(9983),a=r(1755),s=r(2836);class l{constructor(){(0,i.A)(this,"inCodecpar",void 0),(0,i.A)(this,"inTimeBase",void 0),(0,i.A)(this,"outCodecpar",void 0)}init(e,t){return this.inCodecpar=(0,a.Gy)(168),(0,s.Yi)(this.inCodecpar,e),this.inTimeBase={den:n.f[15](t+4),num:n.f[15](t)},0}destroy(){this.inCodecpar&&((0,s.dn)(this.inCodecpar),this.inCodecpar=0)}}},4096:(e,t,r)=>{r.d(t,{HL:()=>w,OD:()=>A,S1:()=>y,Ui:()=>L,XC:()=>S,kM:()=>M,mW:()=>_,oT:()=>m,sL:()=>x,wA:()=>v,wf:()=>I});var i=r(9983),n=r(1958),a=r(1755),s=r(2149),l=r(2171),c=r(8636),o=r(3674),d=r(3321),h=r(84),f=r(4916),u=r(5815),p=r(187);const U=3;function g(e){const t=e.readU(9),r=e.readU(3),i=e.readU(2),n=e.readU(2),a=e.readU(3);e.readU(5),e.readU(2);const s=e.readU(6),l=e.readU(7),c=e.readU(1),o=e.readU(8),d=e.readU(1),h=e.readU(1),f=[],u=[];if(s){for(let t=0;t<s-1;t++)f[t]=e.readU(8);f[s-1]=e.readU(6)}else e.readU(6);if(r>1){let t=0;for(let i=r-2;i>=0;--i)t|=e.readU(1)<<i;for(let t=r;t<=8&&r>1;++t)e.readU(1);for(let i=r-2;i>=0;--i)t&1<<i&&(u[i]=e.readU(8))}const p=e.readU(8),U=[];if(p)for(let t=0;t<p;t++)U.push(e.readU(8));return{olsIdx:t,numSublayers:r,bitDepthMinus8:a,chromaFormatIdc:n,constantFrameRate:i,generalProfileIdc:l,generalTierFlag:c,generalLevelIdc:o,ptlFrameOnlyConstraintFlag:d,ptlMultilayerEnabledFlag:h,generalConstraintInfo:f,sublayerLevelIdc:u,generalSubProfileIdc:U,maxPictureWidth:e.readU(16),maxPictureHeight:e.readU(16),avgFramerate:e.readU(16)}}function w(e){const t=new u.A(e,!0);if(1&t.readUint8()){const r=new h.A;r.appendBuffer(e.subarray(1)),g(r),t.skip(r.getPointer())}let r=[],i=[],n=[];const a=t.readUint8();for(let e=0;e<a;e++){const e=31&t.readUint8();let a=1;13!==e&&12!==e&&(a=t.readUint16());const s=[];for(let e=0;e<a;e++){const e=t.readUint16();s.push(t.readBuffer(e))}14===e?r=s:15===e?i=s:16===e&&(n=s)}return{vpss:r,spss:i,ppss:n}}function b(e,t,r){const i=t[0];let n;if(i){const e=I(i);let t=e.generalConstraintInfo;t.length||(t=new Array(12).fill(0));const r=new f.A;if(r.writeU(9,0),r.writeU(3,e.spsMaxSublayersMinus1+1),r.writeU(2,1),r.writeU(2,e.chromaFormatIdc),r.writeU(3,e.bitDepthMinus8),r.writeU(5,31),r.writeU(2,0),r.writeU(6,t.length),r.writeU(7,e.profile),r.writeU1(e.tierFlag),r.writeU(8,e.level),r.writeU1(e.ptlFrameOnlyConstraintFlag),r.writeU1(e.ptlMultilayerEnabledFlag),t.length){for(let e=0;e<t.length-1;e++)r.writeU(8,t[e]);r.writeU(6,t[t.length-1])}else r.writeU(6,63);if(e.spsMaxSublayersMinus1+1>1){let t=0;for(let r=e.spsMaxSublayersMinus1-1;r>=0;r--)t=t<<1|e.ptlSublayerLevelPresentFlag[r];r.writeU(e.spsMaxSublayersMinus1,t);for(let t=e.spsMaxSublayersMinus1+1;t<=8&&e.spsMaxSublayersMinus1>0;++t)r.writeU1(0);for(let t=e.spsMaxSublayersMinus1-1;t>=0;t--)e.ptlSublayerLevelPresentFlag[t]&&r.writeU(8,e.sublayerLevelIdc[t])}r.writeU(8,e.generalSubProfileIdc.length);for(let t=0;t<e.generalSubProfileIdc.length;t++)r.writeU(8,e.sublayerLevelIdc[t]);r.writeU(16,e.width),r.writeU(16,e.height),r.writeU(16,0),r.padding(),n=r.getBuffer().subarray(0,r.getPointer())}let a=2+(n?n.length:0);e.length&&(a+=3,a=e.reduce(((e,t)=>e+2+t.length),a)),t.length&&(a+=3,a=t.reduce(((e,t)=>e+2+t.length),a)),r.length&&(a+=3,a=r.reduce(((e,t)=>e+2+t.length),a));const s=new Uint8Array(a),l=new p.A(s,!0);l.writeUint8(U<<1|(n?1:0)|248),n&&l.writeBuffer(n);let c=0;return e.length&&c++,t.length&&c++,r.length&&c++,l.writeUint8(c),e.length&&(l.writeUint8(142),l.writeUint16(e.length),d.__(e,(e=>{l.writeUint16(e.length),l.writeBuffer(e)}))),t.length&&(l.writeUint8(143),l.writeUint16(t.length),d.__(t,(e=>{l.writeUint16(e.length),l.writeBuffer(e)}))),r.length&&(l.writeUint8(144),l.writeUint16(r.length),d.__(r,(e=>{l.writeUint16(e.length),l.writeBuffer(e)}))),s}function y(e){let t=n.py(e);if(t.length>=2){const e=[],r=[],i=[];if(t.forEach((t=>{const n=t[1]>>>3&31;14===n?e.push(t):15===n?r.push(t):16===n&&i.push(t)})),r.length&&i.length)return b(e,r,i)}}function x(e){let t=n.py(e);if(t.length>=2){const e=[],r=[],i=[];if(t.forEach((t=>{const n=t[1]>>>3&31;14===n?e.push(t):15===n?r.push(t):16===n&&i.push(t)})),r.length&&i.length){const t=[r[0],i[0]];return e.length&&t.unshift(e[0]),n.nW(t,0)}}}function m(e){let t,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=!1,s=n.py(e);if(s.length){const e=[],n=[],a=[];s.forEach((t=>{const r=t[1]>>>3&31;14===r?e.push(t):15===r?n.push(t):16===r&&a.push(t),8!==r&&7!==r&&9!==r&&10!==r||(i=!0)})),n.length&&a.length?(t=b(e,n,a),s=s.filter((e=>{const t=e[1]>>>3&31;return(r||14!==t&&15!==t&&16!==t)&&20!==t}))):s=s.filter((e=>20!=(e[1]>>>3&31)))}const l=s.reduce(((e,t)=>e+U+1+t.length),0),c=(0,a.sY)(l),d=(0,o.s3)(c,l);return n.S9(s,U,d),{bufferPointer:c,length:l,extradata:t,key:i}}function v(e,t,r,i,s){const l=[n.Le(e,0),n.Le(t,0),n.Le(r,0),n.Le(i,2)];let d=l.reduce(((e,t)=>e+t),0);const h=(0,a.sY)(d+7);let f=h;return c.w8((f+=1,f-1),0),c.w8((f+=1,f-1),0),c.w8((f+=1,f-1),0),c.w8((f+=1,f-1),1),c.w8((f+=1,f-1),0),c.w8((f+=1,f-1),161),c.w8((f+=1,f-1),(s?1:0)<<7|40),e.length&&(n.nW(e,0,(0,o.s3)(f,l[0])),f+=l[0]),t.length&&(n.nW(t,0,(0,o.s3)(f,l[1])),f+=l[1]),r.length&&(n.nW(r,0,(0,o.s3)(f,l[2])),f+=l[2]),i.length&&n.nW(i,2,(0,o.s3)(f,l[3])),{bufferPointer:h,length:d+7}}function M(e,t){let r=n.py(e).concat(n.py(t));if(r.length){let e=[],t=[],i=[],n=[];return r.forEach((r=>{const a=r[1]>>>3&31;14===a?e.push(r):15===a?t.push(r):16===a?i.push(r):20!==a&&n.push(r)})),v(e,t,i,n,!0)}}function A(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:U;t&&(r=t[0]>>>1&3);let i=[],a=[],s=[],l=!1;if(t){const e=w(t);i=e.vpss,a=e.spss,s=e.ppss,l=!0}const c=n.wN(e,r).filter((e=>20!=(e[1]>>>3&31))),o=[];return c.forEach((e=>{const t=e[1]>>>3&31;15!==t||a.length?16!==t||s.length?20!==t&&o.push(e):s.push(e):a.push(e),8!==t&&7!==t||(l=!0)})),{...v(i,a,s,o,l),key:l}}function S(e,t){let r;if(!t&&e.sideData[1]&&(t=e.sideData[1]),t&&n.Bs(t))d.__(n.py(t),(e=>{if(15==(e[1]>>>3&31))return r=e,!1}));else if(t&&t.length>=6){const{spss:e}=w(t);e.length&&(r=e[0])}r&&function(e,t){const{profile:r,level:i,width:n,height:a,videoDelay:s,chromaFormatIdc:l,bitDepthMinus8:c}=I(t);switch(e.codecpar.profile=r,e.codecpar.level=i,e.codecpar.width=n,e.codecpar.height=a,e.codecpar.videoDelay=s,c){case 0:e.codecpar.format=3===l?5:2===l?4:0;break;case 2:e.codecpar.format=3===l?68:2===l?64:62}}(e,r)}function _(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4;if(64&i.f[15](e+36))return n.py((0,o.s3)(i.f[20](e+24),i.f[15](e+28))).some((e=>{const t=e[1]>>>3&31;return 8===t||7===t||9===t}));{const r=i.f[15](e+28);let n=0;for(;n<r-t;){const r=l.r8(i.f[20](e+24)+(n+t+1))>>>3&31;if(8===r||7===r||9===r)return!0;n+=4===t?l.Sg(i.f[20](e+24)+n):3===t?l.ht(i.f[20](e+24)+n):2===t?l.yd(i.f[20](e+24)+n):l.r8(i.f[20](e+24)+n),n+=t}return!1}}function I(e){if(!e||e.length<3)return;let t=0;0===e[0]&&0===e[1]&&0===e[2]&&1===e[3]&&(t=4);let r=0,i=0,a=0,l=0,c=0,o=1,d=0,f=0,u=0;const p=[],U=[],g=[],w=[],b=n.BN(e.subarray(t)),y=new h.A(b.length);y.appendBuffer(b),y.readU1(),y.readU1(),y.readU(6),y.readU(5),y.readU(3),y.readU(8);const x=y.readU(3);o=y.readU(2);const m=y.readU(2);if(y.readU(1)){if(r=y.readU(7),d=y.readU(1),i=y.readU(8),f=y.readU(1),u=y.readU(1),y.readU(1)){for(let e=0;e<8;e++)p[e]=y.readU(8);p[8]=y.readU(7);const e=y.readU(8);y.readU(e)}y.skipPadding();for(let e=x-1;e>=0;e--)U[e]=y.readU(1);y.skipPadding();for(let e=x-1;e>=0;e--)U[e]&&(g[e]=y.readU(8));const e=y.readU(8);if(e)for(let t=0;t<e;t++)w[t]=y.readU(32)}y.readU1(),y.readU1()&&y.readU1();const v=a=s.xb(y),M=l=s.xb(y);if(y.readU1()&&(s.xb(y),s.xb(y),s.xb(y),s.xb(y)),y.readU1()){const e=s.xb(y),t=m+5,r=1<<t,i=v/(1<<t),n=M/(1<<t),a=Math.ceil(Math.log2(i)),l=Math.ceil(Math.log2(n));let c=0,o=0,d=0;e>0&&(d=y.readU1(),o=y.readU1());for(let t=0;e>0&&t<=e;t++)o&&0!=t||(t>0&&v>r&&y.readU(a),t>0&&M>r&&y.readU(l),t<e&&v>r&&y.readU(a),t<e&&M>r&&y.readU(l)),d||y.readU(2);if(c=s.xb(y)+1,y.readU(1)&&y.readU(1))for(let t=0;t<=e;t++)y.readU(c)}c=s.xb(y),y.readU(1),y.readU(1);const A=y.readU(4),S=y.readU(1);let _=0;S&&(_=s.xb(y));const I=[],L=y.readU(2);for(let e=0;e<8*L;e++)I[e]=y.readU(1);return{profile:r,level:i,width:a,height:l,videoDelay:x+1>2?2:x,chromaFormatIdc:o,bitDepthMinus8:c,generalProfileSpace:0,tierFlag:d,generalConstraintInfo:p,generalSubProfileIdc:w,ptlFrameOnlyConstraintFlag:f,ptlMultilayerEnabledFlag:u,spsMaxSublayersMinus1:x,ptlSublayerLevelPresentFlag:U,sublayerLevelIdc:g,sps_log2_max_pic_order_cnt_lsb_minus4:A,sps_poc_msb_cycle_flag:S,sps_poc_msb_cycle_len_minus1:_,sps_num_extra_ph_bytes:L,sps_extra_ph_bit_present_flag:I}}function L(e){n.Bs(e)&&(e=y(e));const t=new h.A;return t.appendBuffer(e),1&t.readU(8)?g(t):{}}},6911:(e,t,r)=>{r.d(t,{A:()=>n});var i=r(4467);class n{constructor(){(0,i.A)(this,"type",-1)}async destroy(e){}}(0,i.A)(n,"Capabilities",[])},9681:(e,t,r)=>{r.d(t,{A:()=>U});var i=r(4467),n=r(9983),a=r(2320),s=r(3458),l=r(3674),c=r(9906),o=r(495),d=r(4187),h=r(1958),f=r(1497),u=r(4229),p=r(4096);class U extends s.A{constructor(){super(...arguments),(0,i.A)(this,"cache",void 0),(0,i.A)(this,"cached",void 0),(0,i.A)(this,"naluLengthSizeMinusOne",void 0)}init(e,t){if(super.init(e,t),this.cache=(0,d._5)(),this.cached=!1,n.f[20](e+12)){const t=(0,l.s3)(n.f[20](e+12),n.f[15](e+16));h.Bs(t)||(27===n.f[15](e+4)?this.naluLengthSizeMinusOne=3&t[4]:173===n.f[15](e+4)?this.naluLengthSizeMinusOne=3&t[21]:196===n.f[15](e+4)&&(this.naluLengthSizeMinusOne=t[0]>>>1&3))}return 0}destroy(){super.destroy(),(0,d.Qe)(this.cache),this.cache=0}sendAVPacket(e){if(64&n.f[15](e+36))(0,d.rN)(this.cache,e);else{let t;(0,d.zu)(this.cache,e);const r=(0,d.rU)(e,1);let i=null;r&&(i=(0,l.JW)(n.f[20](r),n.f[25](r+4)),h.Bs(i)||(27===n.f[15](this.inCodecpar+4)?this.naluLengthSizeMinusOne=3&i[4]:173===n.f[15](this.inCodecpar+4)?this.naluLengthSizeMinusOne=3&i[21]:196===n.f[15](this.inCodecpar+4)&&(this.naluLengthSizeMinusOne=i[0]>>>1&3)));const s=(0,l.JW)(n.f[20](e+24),n.f[15](e+28));27===n.f[15](this.inCodecpar+4)?t=f.OD(s,i,this.naluLengthSizeMinusOne):173===n.f[15](this.inCodecpar+4)?t=u.OD(s,i,this.naluLengthSizeMinusOne):196===n.f[15](this.inCodecpar+4)?t=p.OD(s,i,this.naluLengthSizeMinusOne):c.h2(`not support for codecId: ${n.f[15](this.inCodecpar+4)}`,"packages/avformat/src/bsf/h2645/Avcc2AnnexbFilter.ts",138),a.M[15](this.cache+36,64|n.f[15](this.cache+36)),(0,d.NX)(this.cache,t.bufferPointer,t.length),t.key&&a.M[15](this.cache+36,1|n.f[15](this.cache+36))}return this.cached=!0,0}receiveAVPacket(e){return this.cached?((0,d.Up)(e),(0,d.rN)(e,this.cache),this.cached=!1,0):o.LR}reset(){return 0}}}}]);