"use strict";(self.webpackChunkAVTranscoder=self.webpackChunkAVTranscoder||[]).push([[105],{810:(t,e,i)=>{i.d(e,{FJ:()=>r,FV:()=>a,Tf:()=>c,U5:()=>s});const a={65541:0,65536:3,86018:10,86017:2,86051:11,69645:1,86049:6,65543:7,65542:8,27:7,173:12,12:9,4:2,86:3,92:4,106:5,131:6},r={10:86018,2:86017,11:86051,1:69645,4:86049,5:86049,6:86049,7:65543,8:65542},s={7:27,12:173,9:12,2:4,3:86,4:92,5:106,6:131},c={27:"avc1",173:"hvc1",196:"vvc1",139:"vp08",167:"vp09",225:"av01",86019:"ac-3",86056:"ec-3",86076:"Opus",86028:"fLaC",86017:".mp3",86018:"mp4a"}},1135:(t,e,i)=>{i.d(e,{C$:()=>h,M5:()=>d,Q4:()=>l,zk:()=>f});var a=i(810),r=i(9515),s=i(3262),c=i(1237),o=i(8590);function n(t,e,i){const a=t.getPos(),r=t.getPointer(),s=a-BigInt(Math.floor(r));e<a&&e>=s?(t.seekInline(r+Number(e-a)),t.writeUint24(i),t.seekInline(r)):(t.seek(e),t.writeUint24(i),t.seek(a))}function d(t,e,i,a,r,s){t.flush(),t.writeUint8(e);const c=t.getPos();t.writeUint24(0),t.writeUint24(Number(i&BigInt(16777215))),t.writeUint8(Number(i>>BigInt(24)&BigInt(255))),t.writeUint24(0);const d=t.getPos();a&&a(t),o.Pc(r)?(r(t),n(t,c,Number(t.getPos()-d))):r&&(n(t,c,r.length+Number(t.getPos()-d)),t.writeBuffer(r));const h=Number(t.getPos()-c)+1;s&&s(h),t.writeUint32(h)}function h(t){return 86018!==t&&27!==t&&86017!==t&&12!==t&&!!a.Tf[t]}function l(t,e,i,o,n,d,h,l){let f=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0;const p=e.privData;let u=o?128:0;if(u|=(1&d?1:2)<<4,o){if(i.enableNanoTimestamp&&l){const e=(0,s.Mr)(h,l,c.FQ)-(0,s.Mr)(h,l,c.i0)*BigInt(1e6);e&&(u|=7,t.writeUint8(u),t.writeUint8(2),t.writeUint24(Number(BigInt.asIntN(32,e))),u=0)}i.multiVideoTracks&&(u|=6,t.writeUint8(u),u=0),u|=n,t.writeUint8(u),t.writeUint32((0,r.A)(a.Tf[e.codecpar.codecId])),i.multiVideoTracks&&t.writeUint8(p.trackId),1===n&&t.writeInt24(f)}else u|=15&a.FV[e.codecpar.codecId],t.writeUint8(u),27!==e.codecpar.codecId&&173!==e.codecpar.codecId&&196!==e.codecpar.codecId&&12!==e.codecpar.codecId||(t.writeUint8(n),t.writeInt24(f))}function f(t,e,i,o,n,d,h){const l=e.privData;let f=(o?9:15&a.FV[e.codecpar.codecId])<<4;if(o){if(i.enableNanoTimestamp){const e=(0,s.Mr)(d,h,c.FQ)-(0,s.Mr)(d,h,c.i0)*BigInt(1e6);e&&(f|=7,t.writeUint8(f),t.writeUint8(2),t.writeUint24(Number(BigInt.asIntN(32,e))),f=0)}i.multiVideoTracks&&(f|=5,t.writeUint8(f),f=0),f|=n,t.writeUint8(f),t.writeUint32((0,r.A)(a.Tf[e.codecpar.codecId])),i.multiVideoTracks&&t.writeUint8(l.trackId)}else(86018===e.codecpar.codecId||e.codecpar.chLayout.nbChannels>1)&&(f|=1),65541!==e.codecpar.codecId&&(f|=2),86018===e.codecpar.codecId||e.codecpar.sampleRate>=44e3?f|=12:e.codecpar.sampleRate>=22e3?f|=8:e.codecpar.sampleRate>=11e3&&(f|=4),t.writeUint8(f),86018===e.codecpar.codecId&&t.writeUint8(n)}},1794:(t,e,i)=>{i.d(e,{$x:()=>o,bD:()=>n});var a=i(8590),r=i(3321),s=i(665);async function c(t,e){return{key:await t.readString(await t.readUint16()),value:await o(t,e)}}async function o(t,e){let i;switch(await t.readUint8()){case 0:i=await t.readDouble();break;case 1:i=!!await t.readUint8();break;case 2:i=await t.readString(await t.readUint16());break;case 3:for(i={};t.getPos()<e;){const{key:a,value:r}=await c(t,e);if(i[a]=r,9==(16777215&await t.peekUint24())){await t.skip(3);break}}break;case 8:for(i={},await t.skip(4);t.getPos()<e;){const{key:a,value:r}=await c(t,e);if(i[a]=r,9==(16777215&await t.peekUint24())){await t.skip(3);break}}break;case 9:case 5:i=null;break;case 10:i=[];const a=await t.readUint32();for(let r=0;r<a;r++)i.push(await o(t,e));break;case 11:const r=await t.readDouble(),s=await t.readInt16();i=new Date(r+60*s*1e3);break;case 12:i=await t.readString(await t.readUint32())}return i}function n(t,e){a.ai(e)?(t.writeUint8(0),t.writeDouble(e)):a.o(e)?(t.writeUint8(0),t.writeDouble(Number(e))):a.zM(e)?(t.writeUint8(1),t.writeUint8(e?1:0)):a.Yj(e)?e.length>=65536?(t.writeUint8(12),t.writeUint32(e.length),t.writeString(e)):(t.writeUint8(2),t.writeUint16(e.length),t.writeString(e)):a.YO(e)?(t.writeUint8(10),t.writeUint32(e.length),r.__(e,(e=>{n(t,e)}))):a.Ik(e)?(t.writeUint8(3),s.__(e,((e,i)=>{t.writeUint16(i.length),t.writeString(i),n(t,e)})),t.writeUint24(9)):e instanceof Date?(t.writeUint8(11),t.writeDouble(e.getTime()),t.writeInt16(0)):null==e&&t.writeUint8(5)}},2105:(t,e,i)=>{i.r(e),i.d(e,{default:()=>W});var a=i(4467),r=i(7127),s=i(9983),c=i(7145),o=i(6890),n=i(6911),d=i(7195),h=i(8589),l=i(810),f=i(8547),p=i(9515),u=i(1135),g=i(3674),m=i(4187),w=i(3262),U=i(1237),v=i(1958),I=i(1497),x=i(4229),M=i(4096),b=i(1794),k=i(3321),y=i(9906),A=i(3737),D=i(8370);const S="packages/avformat/src/formats/OFlvFormat.ts";class W extends n.A{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(),(0,a.A)(this,"type",0),(0,a.A)(this,"context",void 0),(0,a.A)(this,"header",void 0),(0,a.A)(this,"script",void 0),(0,a.A)(this,"options",void 0),(0,a.A)(this,"annexb2AvccFilter",void 0),(0,a.A)(this,"avpacket",void 0),(0,a.A)(this,"headerWriter",void 0),(0,a.A)(this,"headerBuffers",void 0),this.header=new d.A,this.script=new h.A,this.headerWriter=new D.A(1e5),this.headerBuffers=[],this.headerWriter.onFlush=t=>(this.headerBuffers.push(t.slice()),0),this.options=t,this.context={keyframeFilePositions:[],keyFrameTimes:[],lastkeyframelocation:0,lastkeyframetimestamp:BigInt(0),lasttimestamp:BigInt(0),framerate:0,filesize:0,audioSize:0,videosize:0,datasize:0,duration:0,scriptWrote:!1,frameCount:0,firstKeyframePositionWrote:!1,videoMetadataWrote:!1,enableNanoTimestamp:t.enableNanoTimestamp,multiAudioTracks:!1,multiVideoTracks:!1,useLegacyHevc:t.useLegacyHevc}}getDefaultStream(t,e){let i=t.streams.filter((t=>t.codecpar.codecType===e&&!(1024&t.disposition)));if(i.length<2)return i[0];const a=i.filter((t=>!(this.isEnhancedStream(t)||1024&t.disposition)));return a.find((t=>!!(1&t.disposition)))||a[0]||i[0]}isEnhancedStream(t){if(this.context.enableNanoTimestamp)return!0;const e=t.privData;return!(this.context.useLegacyHevc&&173===t.codecpar.codecId&&!e.trackId&&!this.context.multiVideoTracks)&&(u.C$(t.codecpar.codecId)||(null==e?void 0:e.trackId)>0)}init(t){t.ioWriter&&t.ioWriter.setEndian(!0);const e=this.getDefaultStream(t,1),i=this.getDefaultStream(t,0);let a=1,s=1;return t.streams.forEach((t=>{if(!(1024&t.disposition))if(1===t.codecpar.codecType){this.header.hasAudio=!0,this.script.onMetaData.hasAudio=!0,86051===t.codecpar.codecId&&(16e3!==t.codecpar.sampleRate&&y.h2("flv speex only support 16000 sample rate",S,196),1!==t.codecpar.chLayout.nbChannels&&y.h2("flv speex only support 1 channel",S,199));let i=0;var c;t===e?(this.script.onMetaData.audiocodecid=null!==(c=l.FV[t.codecpar.codecId])&&void 0!==c?c:(0,p.A)(l.Tf[t.codecpar.codecId]),this.script.onMetaData.stereo=t.codecpar.chLayout.nbChannels>1,this.script.onMetaData.audiosamplerate=t.codecpar.sampleRate||0,this.script.onMetaData.audiosamplesize=t.codecpar.frameSize||0):(i=a++,this.script.onMetaData.audioTrackIdInfoMap||(this.script.onMetaData.audioTrackIdInfoMap={}),this.script.onMetaData.audioTrackIdInfoMap[i]={audiocodecid:l.Tf[t.codecpar.codecId]?(0,p.A)(l.Tf[t.codecpar.codecId]):l.FV[t.codecpar.codecId],stereo:t.codecpar.chLayout.nbChannels>1,audiosamplerate:t.codecpar.sampleRate||0,audiosamplesize:t.codecpar.frameSize||0},t.metadata.title&&(this.script.onMetaData.audioTrackIdInfoMap[i].title=t.metadata.title),t.metadata.language&&(this.script.onMetaData.audioTrackIdInfoMap[i].lang=t.metadata.language)),t.privData={trackId:i}}else if(0===t.codecpar.codecType){this.header.hasVideo=!0,this.script.onMetaData.hasVideo=!0,27!==i.codecpar.codecId&&173!==i.codecpar.codecId&&196!==i.codecpar.codecId||this.annexb2AvccFilter||(this.annexb2AvccFilter=new f.A,this.annexb2AvccFilter.init(i.codecpar[r.o9],i.timeBase[r.o9]));let e=0;var o;t===i?(this.script.onMetaData.videocodecid=null!==(o=l.FV[t.codecpar.codecId])&&void 0!==o?o:(0,p.A)(l.Tf[t.codecpar.codecId]),this.script.onMetaData.width=t.codecpar.width||0,this.script.onMetaData.height=t.codecpar.height||0,this.script.onMetaData.framerate=(0,w.lb)(t.codecpar.framerate)):(e=s++,this.script.onMetaData.videoTrackIdInfoMap||(this.script.onMetaData.videoTrackIdInfoMap={}),this.script.onMetaData.videoTrackIdInfoMap[e]={videocodecid:l.Tf[t.codecpar.codecId]?(0,p.A)(l.Tf[t.codecpar.codecId]):l.FV[t.codecpar.codecId],width:t.codecpar.width||0,height:t.codecpar.height||0,framerate:(0,w.lb)(t.codecpar.framerate)},t.metadata.title&&(this.script.onMetaData.videoTrackIdInfoMap[e].title=t.metadata.title),t.metadata.language&&(this.script.onMetaData.videoTrackIdInfoMap[e].lang=t.metadata.language)),t.privData={trackId:e}}})),a>1&&(this.context.multiAudioTracks=!0),s>1&&(this.context.multiVideoTracks=!0),this.avpacket=(0,m._5)(),0}async destroy(t){this.annexb2AvccFilter&&(this.annexb2AvccFilter.destroy(),this.annexb2AvccFilter=null),this.avpacket&&((0,m.Qe)(this.avpacket),this.avpacket=0)}writeMetadata(t,e){if((173===e.codecpar.codecId||167===e.codecpar.codecId||225===e.codecpar.codecId)&&this.isEnhancedStream(e)){const i=(0,m.Un)(e.codecpar[r.o9]+20,e.codecpar[r.o9]+24,22),a=(0,m.Un)(e.codecpar[r.o9]+20,e.codecpar[r.o9]+24,20),n={colorConfig:{}};if(2!==e.codecpar.colorTrc&&(n.colorConfig.transferCharacteristics=e.codecpar.colorTrc),2!==e.codecpar.colorSpace&&(n.colorConfig.matrixCoefficients=e.codecpar.colorSpace),2!==e.codecpar.colorPrimaries&&(n.colorConfig.colorPrimaries=e.codecpar.colorPrimaries),i){const t=s.f[20](i);n.hdrCll={maxCLL:s.f[8](t),maxFall:s.f[8](t+4)}}if(a){const t=s.f[20](a);n.hdrMdcv={},s.f[15](t+80)&&(n.hdrMdcv.redX=(0,w.lb)((0,o.A)(t,c.Q)),n.hdrMdcv.redY=(0,w.lb)((0,o.A)(t+8,c.Q)),n.hdrMdcv.greenX=(0,w.lb)((0,o.A)(t+16,c.Q)),n.hdrMdcv.greenY=(0,w.lb)((0,o.A)(t+16+8,c.Q)),n.hdrMdcv.blueX=(0,w.lb)((0,o.A)(t+32,c.Q)),n.hdrMdcv.blueY=(0,w.lb)((0,o.A)(t+32+8,c.Q)),n.hdrMdcv.whitePointX=(0,w.lb)((0,o.A)(t+48,c.Q)),n.hdrMdcv.whitePointY=(0,w.lb)((0,o.A)(t+48+8,c.Q))),s.f[15](t+84)&&(n.hdrMdcv.maxLuminance=(0,w.lb)((0,o.A)(t+72,c.Q)),n.hdrMdcv.minLuminance=(0,w.lb)((0,o.A)(t+64,c.Q)))}u.M5(t.ioWriter,9,BigInt(0),(t=>{u.Q4(t,e,this.context,!0,4,1,BigInt(0),0)}),(t=>{b.bD(t,"colorInfo"),b.bD(t,n)}))}}writeMultichannelConfig(t,e){this.isEnhancedStream(e)&&1===e.codecpar.codecType&&u.M5(t.ioWriter,8,BigInt(0),(t=>{u.zk(t,e,this.context,!0,4,BigInt(0),0)}),(t=>{switch(e.codecpar.chLayout.order){case 1:t.writeUint8(1);break;case 2:t.writeUint8(2);break;default:t.writeUint8(0)}if(t.writeUint8(e.codecpar.chLayout.nbChannels),1===e.codecpar.chLayout.order){let i=e.codecpar.chLayout.u.mask&BigInt(262143);i|=e.codecpar.chLayout.u.mask>>BigInt(35)-BigInt(18)&BigInt(16515072),t.writeUint32(Number(BigInt.asUintN(32,i)))}else if(2===e.codecpar.chLayout.order)for(let i=0;i<e.codecpar.chLayout.nbChannels;i++){const a=s.f[15](e.codecpar.chLayout.u.map+24*i);a>=0&&a<=17?t.writeUint8(a-0):a>=35&&a<=40?t.writeUint8(a-35+18):512===a?t.writeUint8(254):t.writeUint8(255)}}))}writeHeader(t){return this.header.write(t.ioWriter),t.ioWriter.writeUint32(0),this.options.live&&(this.script.write(t.ioWriter),this.context.scriptWrote=!0),t.streams.forEach((e=>{if(1024&e.disposition)return;const i=e.privData;if(1===e.codecpar.codecType)e.codecpar.extradata&&(this.isEnhancedStream(e)||86018===e.codecpar.codecId)&&u.M5(t.ioWriter,8,BigInt(0),(t=>{u.zk(t,e,this.context,this.isEnhancedStream(e),(this.isEnhancedStream(e),0),BigInt(0),0)}),(0,g.s3)(e.codecpar.extradata,e.codecpar.extradataSize),(t=>{this.context.filesize+=t+4,i.trackId||(this.context.audioSize+=e.codecpar.extradataSize,this.script.onMetaData.hasMetadata=!0),this.context.datasize+=e.codecpar.extradataSize})),this.writeMultichannelConfig(t,e);else if(0===e.codecpar.codecType&&e.codecpar.extradata&&(this.isEnhancedStream(e)||27===e.codecpar.codecId||173===e.codecpar.codecId||12===e.codecpar.codecId)){let a=(0,g.s3)(e.codecpar.extradata,e.codecpar.extradataSize);27!==e.codecpar.codecId&&173!==e.codecpar.codecId&&196!==e.codecpar.codecId||!v.Bs(a)||(27===e.codecpar.codecId?a=I.S1(a):173===e.codecpar.codecId?a=x.S1(a):196===e.codecpar.codecId&&(a=M.S1(a)));const r=t.ioWriter.getPos();u.M5(t.ioWriter,9,BigInt(0),(t=>{u.Q4(t,e,this.context,this.isEnhancedStream(e),(this.isEnhancedStream(e),0),1,BigInt(0),0)}),a,(t=>{this.context.filesize+=t+4,i.trackId||(this.context.videosize+=e.codecpar.extradataSize,this.script.onMetaData.hasMetadata=!0),this.context.datasize+=e.codecpar.extradataSize,this.context.keyFrameTimes.push(0),this.context.keyframeFilePositions.push(Number(r)),this.context.videoMetadataWrote=!0}))}this.writeMetadata(t,e)})),0}isNewExtradata(t,e){if(t.length===e.codecpar.extradataSize){const i=(0,g.s3)(e.codecpar.extradata,e.codecpar.extradataSize);for(let e=0;e<t.length;e++)if(t[e]!==i[e])return!0}return!1}writeAVPacket(t,e){const i=t.getStreamByIndex(s.f[15](e+32));if(!i||1024&i.disposition)return void y.R8(`can not found the stream width the packet's streamIndex: ${s.f[15](e+32)}, ignore it`,S,548);const a=i.privData;if(1===i.codecpar.codecType){const r=(0,m.rU)(e,1);if(r&&(this.isEnhancedStream(i)||86018===i.codecpar.codecId)){const c=(0,g.s3)(s.f[20](r),s.f[25](r+4));this.isNewExtradata(c,i)&&(u.M5(t.ioWriter,8,(0,w.Mr)(s.f[17](e+16),e+72,U.i0),(t=>{u.zk(t,i,this.context,this.isEnhancedStream(i),(this.isEnhancedStream(i),0),s.f[17](e+16),e+72)}),c,(t=>{this.context.filesize+=t+4})),a.trackId||(this.context.audioSize+=c.length),this.context.datasize+=c.length)}if(s.f[15](e+28)){this.headerWriter.reset(),this.headerBuffers.length=0,u.zk(this.headerWriter,i,this.context,this.isEnhancedStream(i),(this.isEnhancedStream(i),1),s.f[17](e+16),e+72),this.headerWriter.flush();const a=(0,A.A)(Uint8Array,this.headerBuffers),r=t.ioWriter.getPos();t.ioWriter.writeUint8(8),t.ioWriter.writeUint24(s.f[15](e+28)+a.length);const c=(0,w.Mr)(s.f[17](e+16),e+72,U.i0);t.ioWriter.writeUint24(Number(c&BigInt(16777215))),t.ioWriter.writeUint8(Number(c>>BigInt(24)&BigInt(255))),t.ioWriter.writeUint24(0),t.ioWriter.writeBuffer(a),t.ioWriter.writeBuffer((0,g.s3)(s.f[20](e+24),s.f[15](e+28)));const o=Number(t.ioWriter.getPos()-r);t.ioWriter.writeUint32(o),this.context.filesize+=o+4}a.trackId||(this.context.audioSize+=s.f[15](e+28),this.context.lasttimestamp=(0,w.Mr)(s.f[17](e+8),e+72,U.i0)),this.context.datasize+=s.f[15](e+28)}else if(0===i.codecpar.codecType){(27===i.codecpar.codecId||173===i.codecpar.codecId||196===i.codecpar.codecId)&&64&s.f[15](e+36)&&(this.annexb2AvccFilter.sendAVPacket(e),this.annexb2AvccFilter.receiveAVPacket(this.avpacket),e=this.avpacket);const r=t.ioWriter.getPos(),c=(0,m.rU)(e,1);if(c){const r=(0,g.s3)(s.f[20](c),s.f[25](c+4));this.isNewExtradata(r,i)&&(this.isEnhancedStream(i)||27===i.codecpar.codecId||173===i.codecpar.codecId||12===i.codecpar.codecId)&&(u.M5(t.ioWriter,9,(0,w.Mr)(s.f[17](e+16),e+72,U.i0),(t=>{u.Q4(t,i,this.context,this.isEnhancedStream(i),(this.isEnhancedStream(i),0),s.f[15](e+36),s.f[17](e+16),e+72)}),r,(t=>{this.context.filesize+=t+4})),a.trackId||(this.context.videosize+=r.length),this.context.datasize+=r.length)}if(s.f[15](e+28)){let c=0;s.f[17](e+8)!==U.Dh&&(c=Number(BigInt.asIntN(32,(0,w.Mr)(s.f[17](e+8)-s.f[17](e+16),e+72,U.i0))));const o=s.f[17](e+16)===s.f[17](e+8)||173!==i.codecpar.codecId&&196!==i.codecpar.codecId&&27!==i.codecpar.codecId?3:1;this.headerWriter.reset(),this.headerBuffers.length=0,u.Q4(this.headerWriter,i,this.context,this.isEnhancedStream(i),this.isEnhancedStream(i)?o:1,s.f[15](e+36),s.f[17](e+16),e+72,c),this.headerWriter.flush();const n=(0,A.A)(Uint8Array,this.headerBuffers),d=t.ioWriter.getPos();t.ioWriter.writeUint8(9),t.ioWriter.writeUint24(s.f[15](e+28)+n.length);const h=(0,w.Mr)(s.f[17](e+16),e+72,U.i0);t.ioWriter.writeUint24(Number(h&BigInt(16777215))),t.ioWriter.writeUint8(Number(h>>BigInt(24)&BigInt(255))),t.ioWriter.writeUint24(0),t.ioWriter.writeBuffer(n),t.ioWriter.writeBuffer((0,g.s3)(s.f[20](e+24),s.f[15](e+28)));const l=Number(t.ioWriter.getPos()-d);t.ioWriter.writeUint32(l),this.context.filesize+=l+4,a.trackId||(this.context.frameCount++,this.context.videosize+=s.f[15](e+28),this.context.lasttimestamp=(0,w.Mr)(s.f[17](e+8),e+72,U.i0)),this.context.datasize+=s.f[15](e+28),1&s.f[15](e+36)&&(this.context.firstKeyframePositionWrote||!this.context.videoMetadataWrote?(this.context.lastkeyframetimestamp=(0,w.Mr)(s.f[17](e+8),e+72,U.i0),this.context.lastkeyframelocation=Number(r),this.context.keyFrameTimes.push(Number((Number(this.context.lastkeyframetimestamp)*(0,w.lb)(U.i0)).toFixed(2))),this.context.keyframeFilePositions.push(this.context.lastkeyframelocation)):this.context.firstKeyframePositionWrote=!0)}}return 0}writeTrailer(t){if(t.streams.forEach((e=>{if(1024&e.disposition)return;const i=e.privData;(27===e.codecpar.codecId||173===e.codecpar.codecId||12===e.codecpar.codecId||this.isEnhancedStream(e))&&(u.M5(t.ioWriter,9,this.context.lasttimestamp,(t=>{u.Q4(t,e,this.context,this.isEnhancedStream(e),this.isEnhancedStream(e)?(e.codecpar.codecType,2):2,32,this.context.lasttimestamp,0)}),void 0,(t=>{this.context.filesize+=t+4})),0!==e.codecpar.codecType||i.trackId||(this.script.onMetaData.canSeekToEnd=!0))})),this.context.scriptWrote)t.ioWriter.flush();else{t.ioWriter.flush(),this.script.onMetaData.filesize=this.context.filesize,this.script.onMetaData.audiosize=this.context.audioSize,this.script.onMetaData.videosize=this.context.videosize,this.script.onMetaData.datasize=this.context.datasize,this.script.onMetaData.lasttimestamp=this.context.lasttimestamp,this.options.addKeyframePositions?(this.script.onMetaData.lastkeyframetimestamp=this.context.lastkeyframetimestamp,this.script.onMetaData.lastkeyframelocation=this.context.lastkeyframelocation,this.context.keyFrameTimes.length>1?(this.script.onMetaData.hasKeyframes=!0,this.script.onMetaData.keyframes={filepositions:this.context.keyframeFilePositions,times:this.context.keyFrameTimes}):this.script.onMetaData.hasKeyframes=!1):this.script.onMetaData.hasKeyframes=!1,this.script.onMetaData.duration=Number(this.context.lasttimestamp)/1e3,this.script.onMetaData.audiodatarate=this.context.audioSize/this.script.onMetaData.duration/1e3*8,this.script.onMetaData.videodatarate=this.context.videosize/this.script.onMetaData.duration/1e3*8,this.script.onMetaData.framerate=this.context.frameCount/this.script.onMetaData.duration;const e=this.script.computeSize();k.__(this.context.keyframeFilePositions,((t,i)=>{this.context.keyframeFilePositions[i]=t+11+e+4})),this.script.onMetaData.keyframes&&(this.script.onMetaData.keyframes.filepositions=this.context.keyframeFilePositions),this.context.filesize+=11+e+4,this.script.onMetaData.filesize=this.context.filesize;const i=[],a=t.ioWriter.onFlush;t.ioWriter.onFlush=t=>(i.push(t.slice()),0),this.script.write(t.ioWriter),t.ioWriter.flush(),t.ioWriter.onFlush=a;const r=(0,A.A)(Uint8Array,i);a&&a(r,BigInt(13))}return 0}flush(t){return t.ioWriter.flush(),0}getCapabilities(){return W.Capabilities}}(0,a.A)(W,"Capabilities",[86017,86018,86051,69645,86049,65543,65542,86019,86056,86076,86028,12,27,173,225,167,139,196])},3458:(t,e,i)=>{i.d(e,{A:()=>o});var a=i(4467),r=i(9983),s=i(1755),c=i(2836);class o{constructor(){(0,a.A)(this,"inCodecpar",void 0),(0,a.A)(this,"inTimeBase",void 0),(0,a.A)(this,"outCodecpar",void 0)}init(t,e){return this.inCodecpar=(0,s.Gy)(168),(0,c.Yi)(this.inCodecpar,t),this.inTimeBase={den:r.f[15](e+4),num:r.f[15](e)},0}destroy(){this.inCodecpar&&((0,c.dn)(this.inCodecpar),this.inCodecpar=0)}}},4096:(t,e,i)=>{i.d(e,{HL:()=>w,OD:()=>k,S1:()=>v,Ui:()=>S,XC:()=>y,kM:()=>b,mW:()=>A,oT:()=>x,sL:()=>I,wA:()=>M,wf:()=>D});var a=i(9983),r=i(1958),s=i(1755),c=i(2149),o=i(2171),n=i(8636),d=i(3674),h=i(3321),l=i(84),f=i(4916),p=i(5815),u=i(187);const g=3;function m(t){const e=t.readU(9),i=t.readU(3),a=t.readU(2),r=t.readU(2),s=t.readU(3);t.readU(5),t.readU(2);const c=t.readU(6),o=t.readU(7),n=t.readU(1),d=t.readU(8),h=t.readU(1),l=t.readU(1),f=[],p=[];if(c){for(let e=0;e<c-1;e++)f[e]=t.readU(8);f[c-1]=t.readU(6)}else t.readU(6);if(i>1){let e=0;for(let a=i-2;a>=0;--a)e|=t.readU(1)<<a;for(let e=i;e<=8&&i>1;++e)t.readU(1);for(let a=i-2;a>=0;--a)e&1<<a&&(p[a]=t.readU(8))}const u=t.readU(8),g=[];if(u)for(let e=0;e<u;e++)g.push(t.readU(8));return{olsIdx:e,numSublayers:i,bitDepthMinus8:s,chromaFormatIdc:r,constantFrameRate:a,generalProfileIdc:o,generalTierFlag:n,generalLevelIdc:d,ptlFrameOnlyConstraintFlag:h,ptlMultilayerEnabledFlag:l,generalConstraintInfo:f,sublayerLevelIdc:p,generalSubProfileIdc:g,maxPictureWidth:t.readU(16),maxPictureHeight:t.readU(16),avgFramerate:t.readU(16)}}function w(t){const e=new p.A(t,!0);if(1&e.readUint8()){const i=new l.A;i.appendBuffer(t.subarray(1)),m(i),e.skip(i.getPointer())}let i=[],a=[],r=[];const s=e.readUint8();for(let t=0;t<s;t++){const t=31&e.readUint8();let s=1;13!==t&&12!==t&&(s=e.readUint16());const c=[];for(let t=0;t<s;t++){const t=e.readUint16();c.push(e.readBuffer(t))}14===t?i=c:15===t?a=c:16===t&&(r=c)}return{vpss:i,spss:a,ppss:r}}function U(t,e,i){const a=e[0];let r;if(a){const t=D(a);let e=t.generalConstraintInfo;e.length||(e=new Array(12).fill(0));const i=new f.A;if(i.writeU(9,0),i.writeU(3,t.spsMaxSublayersMinus1+1),i.writeU(2,1),i.writeU(2,t.chromaFormatIdc),i.writeU(3,t.bitDepthMinus8),i.writeU(5,31),i.writeU(2,0),i.writeU(6,e.length),i.writeU(7,t.profile),i.writeU1(t.tierFlag),i.writeU(8,t.level),i.writeU1(t.ptlFrameOnlyConstraintFlag),i.writeU1(t.ptlMultilayerEnabledFlag),e.length){for(let t=0;t<e.length-1;t++)i.writeU(8,e[t]);i.writeU(6,e[e.length-1])}else i.writeU(6,63);if(t.spsMaxSublayersMinus1+1>1){let e=0;for(let i=t.spsMaxSublayersMinus1-1;i>=0;i--)e=e<<1|t.ptlSublayerLevelPresentFlag[i];i.writeU(t.spsMaxSublayersMinus1,e);for(let e=t.spsMaxSublayersMinus1+1;e<=8&&t.spsMaxSublayersMinus1>0;++e)i.writeU1(0);for(let e=t.spsMaxSublayersMinus1-1;e>=0;e--)t.ptlSublayerLevelPresentFlag[e]&&i.writeU(8,t.sublayerLevelIdc[e])}i.writeU(8,t.generalSubProfileIdc.length);for(let e=0;e<t.generalSubProfileIdc.length;e++)i.writeU(8,t.sublayerLevelIdc[e]);i.writeU(16,t.width),i.writeU(16,t.height),i.writeU(16,0),i.padding(),r=i.getBuffer().subarray(0,i.getPointer())}let s=2+(r?r.length:0);t.length&&(s+=3,s=t.reduce(((t,e)=>t+2+e.length),s)),e.length&&(s+=3,s=e.reduce(((t,e)=>t+2+e.length),s)),i.length&&(s+=3,s=i.reduce(((t,e)=>t+2+e.length),s));const c=new Uint8Array(s),o=new u.A(c,!0);o.writeUint8(g<<1|(r?1:0)|248),r&&o.writeBuffer(r);let n=0;return t.length&&n++,e.length&&n++,i.length&&n++,o.writeUint8(n),t.length&&(o.writeUint8(142),o.writeUint16(t.length),h.__(t,(t=>{o.writeUint16(t.length),o.writeBuffer(t)}))),e.length&&(o.writeUint8(143),o.writeUint16(e.length),h.__(e,(t=>{o.writeUint16(t.length),o.writeBuffer(t)}))),i.length&&(o.writeUint8(144),o.writeUint16(i.length),h.__(i,(t=>{o.writeUint16(t.length),o.writeBuffer(t)}))),c}function v(t){let e=r.py(t);if(e.length>=2){const t=[],i=[],a=[];if(e.forEach((e=>{const r=e[1]>>>3&31;14===r?t.push(e):15===r?i.push(e):16===r&&a.push(e)})),i.length&&a.length)return U(t,i,a)}}function I(t){let e=r.py(t);if(e.length>=2){const t=[],i=[],a=[];if(e.forEach((e=>{const r=e[1]>>>3&31;14===r?t.push(e):15===r?i.push(e):16===r&&a.push(e)})),i.length&&a.length){const e=[i[0],a[0]];return t.length&&e.unshift(t[0]),r.nW(e,0)}}}function x(t){let e,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=!1,c=r.py(t);if(c.length){const t=[],r=[],s=[];c.forEach((e=>{const i=e[1]>>>3&31;14===i?t.push(e):15===i?r.push(e):16===i&&s.push(e),8!==i&&7!==i&&9!==i&&10!==i||(a=!0)})),r.length&&s.length?(e=U(t,r,s),c=c.filter((t=>{const e=t[1]>>>3&31;return(i||14!==e&&15!==e&&16!==e)&&20!==e}))):c=c.filter((t=>20!=(t[1]>>>3&31)))}const o=c.reduce(((t,e)=>t+g+1+e.length),0),n=(0,s.sY)(o),h=(0,d.s3)(n,o);return r.S9(c,g,h),{bufferPointer:n,length:o,extradata:e,key:a}}function M(t,e,i,a,c){const o=[r.Le(t,0),r.Le(e,0),r.Le(i,0),r.Le(a,2)];let h=o.reduce(((t,e)=>t+e),0);const l=(0,s.sY)(h+7);let f=l;return n.w8((f+=1,f-1),0),n.w8((f+=1,f-1),0),n.w8((f+=1,f-1),0),n.w8((f+=1,f-1),1),n.w8((f+=1,f-1),0),n.w8((f+=1,f-1),161),n.w8((f+=1,f-1),(c?1:0)<<7|40),t.length&&(r.nW(t,0,(0,d.s3)(f,o[0])),f+=o[0]),e.length&&(r.nW(e,0,(0,d.s3)(f,o[1])),f+=o[1]),i.length&&(r.nW(i,0,(0,d.s3)(f,o[2])),f+=o[2]),a.length&&r.nW(a,2,(0,d.s3)(f,o[3])),{bufferPointer:l,length:h+7}}function b(t,e){let i=r.py(t).concat(r.py(e));if(i.length){let t=[],e=[],a=[],r=[];return i.forEach((i=>{const s=i[1]>>>3&31;14===s?t.push(i):15===s?e.push(i):16===s?a.push(i):20!==s&&r.push(i)})),M(t,e,a,r,!0)}}function k(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:g;e&&(i=e[0]>>>1&3);let a=[],s=[],c=[],o=!1;if(e){const t=w(e);a=t.vpss,s=t.spss,c=t.ppss,o=!0}const n=r.wN(t,i).filter((t=>20!=(t[1]>>>3&31))),d=[];return n.forEach((t=>{const e=t[1]>>>3&31;15!==e||s.length?16!==e||c.length?20!==e&&d.push(t):c.push(t):s.push(t),8!==e&&7!==e||(o=!0)})),{...M(a,s,c,d,o),key:o}}function y(t,e){let i;if(!e&&t.sideData[1]&&(e=t.sideData[1]),e&&r.Bs(e))h.__(r.py(e),(t=>{if(15==(t[1]>>>3&31))return i=t,!1}));else if(e&&e.length>=6){const{spss:t}=w(e);t.length&&(i=t[0])}i&&function(t,e){const{profile:i,level:a,width:r,height:s,videoDelay:c,chromaFormatIdc:o,bitDepthMinus8:n}=D(e);switch(t.codecpar.profile=i,t.codecpar.level=a,t.codecpar.width=r,t.codecpar.height=s,t.codecpar.videoDelay=c,n){case 0:t.codecpar.format=3===o?5:2===o?4:0;break;case 2:t.codecpar.format=3===o?68:2===o?64:62}}(t,i)}function A(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4;if(64&a.f[15](t+36))return r.py((0,d.s3)(a.f[20](t+24),a.f[15](t+28))).some((t=>{const e=t[1]>>>3&31;return 8===e||7===e||9===e}));{const i=a.f[15](t+28);let r=0;for(;r<i-e;){const i=o.r8(a.f[20](t+24)+(r+e+1))>>>3&31;if(8===i||7===i||9===i)return!0;r+=4===e?o.Sg(a.f[20](t+24)+r):3===e?o.ht(a.f[20](t+24)+r):2===e?o.yd(a.f[20](t+24)+r):o.r8(a.f[20](t+24)+r),r+=e}return!1}}function D(t){if(!t||t.length<3)return;let e=0;0===t[0]&&0===t[1]&&0===t[2]&&1===t[3]&&(e=4);let i=0,a=0,s=0,o=0,n=0,d=1,h=0,f=0,p=0;const u=[],g=[],m=[],w=[],U=r.BN(t.subarray(e)),v=new l.A(U.length);v.appendBuffer(U),v.readU1(),v.readU1(),v.readU(6),v.readU(5),v.readU(3),v.readU(8);const I=v.readU(3);d=v.readU(2);const x=v.readU(2);if(v.readU(1)){if(i=v.readU(7),h=v.readU(1),a=v.readU(8),f=v.readU(1),p=v.readU(1),v.readU(1)){for(let t=0;t<8;t++)u[t]=v.readU(8);u[8]=v.readU(7);const t=v.readU(8);v.readU(t)}v.skipPadding();for(let t=I-1;t>=0;t--)g[t]=v.readU(1);v.skipPadding();for(let t=I-1;t>=0;t--)g[t]&&(m[t]=v.readU(8));const t=v.readU(8);if(t)for(let e=0;e<t;e++)w[e]=v.readU(32)}v.readU1(),v.readU1()&&v.readU1();const M=s=c.xb(v),b=o=c.xb(v);if(v.readU1()&&(c.xb(v),c.xb(v),c.xb(v),c.xb(v)),v.readU1()){const t=c.xb(v),e=x+5,i=1<<e,a=M/(1<<e),r=b/(1<<e),s=Math.ceil(Math.log2(a)),o=Math.ceil(Math.log2(r));let n=0,d=0,h=0;t>0&&(h=v.readU1(),d=v.readU1());for(let e=0;t>0&&e<=t;e++)d&&0!=e||(e>0&&M>i&&v.readU(s),e>0&&b>i&&v.readU(o),e<t&&M>i&&v.readU(s),e<t&&b>i&&v.readU(o)),h||v.readU(2);if(n=c.xb(v)+1,v.readU(1)&&v.readU(1))for(let e=0;e<=t;e++)v.readU(n)}n=c.xb(v),v.readU(1),v.readU(1);const k=v.readU(4),y=v.readU(1);let A=0;y&&(A=c.xb(v));const D=[],S=v.readU(2);for(let t=0;t<8*S;t++)D[t]=v.readU(1);return{profile:i,level:a,width:s,height:o,videoDelay:I+1>2?2:I,chromaFormatIdc:d,bitDepthMinus8:n,generalProfileSpace:0,tierFlag:h,generalConstraintInfo:u,generalSubProfileIdc:w,ptlFrameOnlyConstraintFlag:f,ptlMultilayerEnabledFlag:p,spsMaxSublayersMinus1:I,ptlSublayerLevelPresentFlag:g,sublayerLevelIdc:m,sps_log2_max_pic_order_cnt_lsb_minus4:k,sps_poc_msb_cycle_flag:y,sps_poc_msb_cycle_len_minus1:A,sps_num_extra_ph_bytes:S,sps_extra_ph_bit_present_flag:D}}function S(t){r.Bs(t)&&(t=v(t));const e=new l.A;return e.appendBuffer(t),1&e.readU(8)?m(e):{}}},6911:(t,e,i)=>{i.d(e,{A:()=>r});var a=i(4467);class r{constructor(){(0,a.A)(this,"type",-1)}async destroy(t){}}(0,a.A)(r,"Capabilities",[])},7195:(t,e,i)=>{i.d(e,{A:()=>r});var a=i(4467);class r{constructor(){(0,a.A)(this,"signature",void 0),(0,a.A)(this,"version",void 0),(0,a.A)(this,"flags",void 0),(0,a.A)(this,"dataOffset",void 0),(0,a.A)(this,"hasVideo",void 0),(0,a.A)(this,"hasAudio",void 0),this.signature="FLV",this.version=1,this.flags=0,this.dataOffset=9,this.hasAudio=!1,this.hasVideo=!1}async read(t){this.signature=await t.readString(3),this.version=await t.readUint8(),this.flags=await t.readUint8(),this.dataOffset=await t.readUint32(),this.hasAudio=!!(4&this.flags),this.hasVideo=!!(1&this.flags)}write(t){this.flags=0,this.hasAudio&&(this.flags|=4),this.hasVideo&&(this.flags|=1),t.writeString(this.signature),t.writeUint8(this.version),t.writeUint8(this.flags),t.writeUint32(this.dataOffset)}}},8547:(t,e,i)=>{i.d(e,{A:()=>g});var a=i(4467),r=i(9983),s=i(2320),c=i(3458),o=i(3674),n=i(9906),d=i(495),h=i(4187),l=i(1755),f=i(1497),p=i(4229),u=i(4096);class g extends c.A{constructor(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];super(),(0,a.A)(this,"cache",void 0),(0,a.A)(this,"cached",void 0),(0,a.A)(this,"reverseSps",void 0),this.reverseSps=t}init(t,e){return super.init(t,e),this.cache=(0,h._5)(),this.cached=!1,0}destroy(){super.destroy(),(0,h.Qe)(this.cache),this.cache=0}sendAVPacket(t){if(64&r.f[15](t+36)){let e;(0,h.zu)(this.cache,t);const i=(0,o.JW)(r.f[20](t+24),r.f[15](t+28));if(27===r.f[15](this.inCodecpar+4)?e=f.oT(i,this.reverseSps):173===r.f[15](this.inCodecpar+4)?e=p.oT(i,this.reverseSps):196===r.f[15](this.inCodecpar+4)?e=u.oT(i,this.reverseSps):n.h2(`not support for codecId: ${r.f[15](this.inCodecpar+4)}`,"packages/avformat/src/bsf/h2645/Annexb2AvccFilter.ts",114),s.M[15](this.cache+36,-65&r.f[15](this.cache+36)),(0,h.NX)(this.cache,e.bufferPointer,e.length),e.key&&s.M[15](this.cache+36,1|r.f[15](this.cache+36)),e.extradata){const t=(0,l.sY)(e.extradata.length);(0,o.lW)(t,e.extradata.length,e.extradata),(0,h.Ow)(this.cache,1,t,e.extradata.length)}}else(0,h.rN)(this.cache,t);return this.cached=!0,0}receiveAVPacket(t){return this.cached?((0,h.Up)(t),(0,h.rN)(t,this.cache),this.cached=!1,0):d.LR}reset(){return 0}}},8589:(t,e,i)=>{i.d(e,{A:()=>h});var a=i(4467),r=i(1135),s=i(1794),c=i(495),o=i(9906),n=i(3737),d=i(8370);class h{constructor(){(0,a.A)(this,"onMetaData",void 0),this.onMetaData={canSeekToEnd:!1}}async read(t,e){const i=t.getPos(),a=i+BigInt(Math.floor(e)),r=await s.$x(t,a),n=await s.$x(t,a);this[r]=n,a>t.getPos()&&await t.skip(Number(BigInt.asIntN(32,a-t.getPos())));const d=Number(t.getPos()-i),h=await t.readUint32();return d+11!==h?(o.R8(`script size not match, size: ${d+11}, previousTagSize: ${h}`,"packages/avformat/src/formats/flv/FlvScriptTag.ts",60),c.LR):0}computeSize(){const t=[],e=new d.A;return e.onFlush=e=>(t.push(e.slice()),0),s.bD(e,"onMetaData"),s.bD(e,this.onMetaData),e.flush(),(0,n.A)(Uint8Array,t).length}write(t){if(this.onMetaData){const e=[],i=new d.A;i.onFlush=t=>(e.push(t.slice()),0),s.bD(i,"onMetaData"),s.bD(i,this.onMetaData),i.flush();const a=(0,n.A)(Uint8Array,e);r.M5(t,18,BigInt(0),void 0,a)}}dts2Position(t){if(this.canSeek()){let e=-1;const i=this.onMetaData.keyframes.times,a=this.onMetaData.keyframes.filepositions;let r;for(r=0;r<i.length;r++){if(i[r]===t){e=r;break}if(i[r]>t){e=Math.max(r-1,0);break}}return r&&r===i.length&&(e=i.length-1),{pos:a[e],dts:i[e]}}return{pos:-1,dts:-1}}position2DTS(t){if(this.canSeek()){let i=-1;const a=this.onMetaData.keyframes.times,r=this.onMetaData.keyframes.filepositions;let s=0;for(s=0;s<r.length;s++)if(r[s]>t){i=s;break}var e;return s===r.length?null!==(e=this.onMetaData.duration)&&void 0!==e?e:a[a.length-1]:a[i]}return-1}canSeek(){return!!(this.onMetaData.keyframes&&this.onMetaData.keyframes.filepositions&&this.onMetaData.keyframes.filepositions.length)}}},9515:(t,e,i)=>{i.d(e,{A:()=>s});var a=i(9906);const r="packages/avformat/src/function/mktag.ts";function s(t){4!==t.length&&a.R8(`tag length is not 4, tag: ${t}`,r,31);let e=0;for(let i=0;i<4;i++)e=e<<8|t.charCodeAt(i);return e}}}]);