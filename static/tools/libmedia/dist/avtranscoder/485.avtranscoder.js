"use strict";(self.webpackChunkAVTranscoder=self.webpackChunkAVTranscoder||[]).push([[485],{1945:(t,e,i)=>{i.d(e,{A:()=>n});var s=i(4467);class n{constructor(){(0,s.A)(this,"type",-1),(0,s.A)(this,"onStreamAdd",void 0)}async destroy(t){}}},2485:(t,e,i)=>{i.r(e),i.d(e,{default:()=>T});var s=i(4467),n=i(2320),r=i(1945),a=i(3674),o=i(495),h=i(4187),u=i(1755),d=i(3262),c=i(1237),f=i(3321),g=i(9906),l=i(4405),B=i(7571);const p="packages/avformat/src/formats/IWebVttFormat.ts";class T extends r.A{constructor(){super(),(0,s.A)(this,"type",18),(0,s.A)(this,"queue",void 0),(0,s.A)(this,"index",void 0),(0,s.A)(this,"baseTs",void 0)}init(t){this.queue=[],this.baseTs=BigInt(0)}async readChunk(t){let e="";const i=t.ioReader.getPos();for(;;){const i=await t.ioReader.readLine();if(""===i||"WEBVTT"===i)break;e+=i+"\n"}return{chunk:e.trim(),pos:i}}async readCue(t,e){for(;;){const{chunk:i,pos:s}=await this.readChunk(t);if(""===i||/^NOTE/.test(i)||"WEBVTT"===i)continue;if(/^STYLE/.test(i)){e.push({style:i.replace(/STYLE[\s|\n]?/,""),pos:s});continue}if(/^X-TIMESTAMP-MAP/.test(i)){const t=i.split("=")[1].split(",");let e=BigInt(0),s=BigInt(0);t.forEach((t=>{const i=t.split(":");"LOCAL"===i[0]?(i.shift(),e=B.j(i.join(":").trim())):"MPEGTS"===i[0]&&(s=BigInt(+i[1])*BigInt(1e3)/BigInt(9e4))})),this.baseTs=s-e;continue}const n=i.split("\n");let r,a;-1===n[0].indexOf("--\x3e")&&(r=n.shift().trim());let o=n.shift().split("--\x3e");const h=B.j(o.shift())+this.baseTs;o=o.shift().trim().split(" ");const u=B.j(o.shift())+this.baseTs;if(u<=h)continue;o=o.filter((t=>""!==t)),o.length&&(a=o.join(" "));const d=n.join("\n").trim();if(d)return{identifier:r,options:a,context:d,startTs:h,endTs:u,pos:s}}}async readHeader(t){const e=await t.ioReader.peekBuffer(3);if(239===e[0]&&187===e[1]&&191===e[2]&&await t.ioReader.skip(3),"WEBVTT"!==await t.ioReader.peekString(6))return g.z3("the file format is not vtt",p,187),o.LR;const i=t.createStream();i.codecpar.codecId=94226,i.codecpar.codecType=3,i.timeBase.den=1e3,i.timeBase.num=1;const s=await t.ioReader.readLine();s.indexOf("-")>0&&(i.metadata.title=s.split("-").pop().trim()),this.index=0;const n=[];let r=BigInt(0);try{for(;;){const e=await this.readCue(t,n);if(i.nbFrames++,i.duration=e.endTs,e.startTs>=r?(this.queue.push(e),r=e.startTs):f._(this.queue,e,(t=>t.startTs<e.startTs?1:-1)),2&t.ioReader.flags)break}}catch(t){}return i.metadata.styles=n,0}async readAVPacket(t,e){const i=t.streams.find((t=>3===t.codecpar.codecType));if(2&t.ioReader.flags){if(this.index>=this.queue.length)try{const s=await this.readCue(t,i.metadata.styles);if(this.queue.length){const i=this.queue[this.queue.length-1];if(i.startTs===s.startTs&&i.endTs===s.endTs&&i.context===s.context)return this.readAVPacket(t,e)}this.queue.push(s),i.nbFrames++,i.duration=s.endTs}catch(e){return-1048576!==t.ioReader.error&&-1048572!==t.ioReader.error?(g.z3(`read cue error, ${e}`,p,270),o.LR):t.ioReader.error}}else{if(!this.queue.length)return o.LR;if(this.index>=this.queue.length)return-1048576}const s=this.queue[this.index++];if(n.M[15](e+32,i.index),n.M[15](e+76,i.timeBase.den),n.M[15](e+72,i.timeBase.num),n.M[17](e+16,s.startTs),n.M[17](e+8,s.startTs),n.M[17](e+48,s.endTs-s.startTs),s.identifier){const t=l.encode(s.identifier),i=(0,u.sY)(t.length);(0,a.lW)(i,t.length,t),(0,h.Ow)(e,16,i,t.length)}if(s.options){const t=l.encode(s.options),i=(0,u.sY)(t.length);(0,a.lW)(i,t.length,t),(0,h.Ow)(e,17,i,t.length)}const r=l.encode(s.context),d=(0,u.sY)(r.length);return(0,a.lW)(d,r.length,r),(0,h.NX)(e,d,r.length),0}async seek(t,e,i,s){if(2&s)return BigInt(o.E$);if(16&s&&2&t.ioReader.flags){const s=(0,d.k)(i,e.timeBase,c.i0);return await t.ioReader.seek(s,!0),this.queue.length=0,this.index=0,BigInt(0)}if(i<=BigInt(0))return this.index=0,BigInt(0);const n=f.El(this.queue,(t=>t.startTs>i?-1:1));if(n>=0){for(g.Yz(`seek in cues, found index: ${n}, pts: ${this.queue[n].startTs}, pos: ${this.queue[n].pos}`,p,337),this.index=Math.max(n-1,0);this.index>0&&(this.queue[this.index-1].startTs===this.queue[this.index].startTs||this.queue[this.index-1].endTs>i);)this.index--;return BigInt(0)}return BigInt(o.LR)}getAnalyzeStreamsCount(){return 1}}},7571:(t,e,i)=>{function s(t){if(!t)return-BigInt(1);let e=(t=t.trim()).split(":"),i=BigInt(0);if(3===e.length&&(i+=BigInt(+e.shift().trim())*BigInt(36e5)),i+=BigInt(+e.shift().trim())*BigInt(6e4),e=e.shift().trim().split("."),i+=BigInt(+e.shift().trim())*BigInt(1e3),e.length){let t=e[0].trim().length,s=BigInt(+e.shift().trim());1===t?s*=BigInt(100):2===t&&(s*=BigInt(10)),i+=s}return i}function n(t){if(!t)return-BigInt(1);let e=(t=t.trim()).split(":"),i=BigInt(0);if(3===e.length&&(i+=BigInt(+e.shift().trim())*BigInt(36e5)),i+=BigInt(+e.shift().trim())*BigInt(6e4),e=e.shift().trim().split(","),i+=BigInt(+e.shift().trim())*BigInt(1e3),e.length){let t=e[0].trim().length,s=BigInt(+e.shift().trim());1===t?s*=BigInt(100):2===t&&(s*=BigInt(10)),i+=s}return i}i.d(e,{j:()=>s,t:()=>n})}}]);