"use strict";(self.webpackChunkAVTranscoder=self.webpackChunkAVTranscoder||[]).push([[507],{935:(t,e,i)=>{i.d(e,{CM:()=>o,Vz:()=>n,qg:()=>s});var r=i(4467),a=i(9935);class n{constructor(){(0,r.A)(this,"version",void 0),(0,r.A)(this,"layer",void 0),(0,r.A)(this,"protection",void 0),(0,r.A)(this,"bitrateIndex",void 0),(0,r.A)(this,"samplingFrequency",void 0),(0,r.A)(this,"padding",void 0),(0,r.A)(this,"private",void 0),(0,r.A)(this,"mode",void 0),(0,r.A)(this,"modeExtension",void 0),(0,r.A)(this,"copyright",void 0),(0,r.A)(this,"original",void 0),(0,r.A)(this,"emphasis",void 0)}}function s(t,e){t.version=e>>19&3,t.layer=e>>17&3,t.protection=e>>16&1,t.bitrateIndex=e>>12&15,t.samplingFrequency=e>>10&3,t.padding=e>>9&1,t.mode=e>>6&3,t.modeExtension=e>>4&3,t.copyright=e>>3&1,t.original=e>>2&1,t.emphasis=3&e}function o(t,e){let i=a.oz(t.version,t.layer,t.bitrateIndex);switch(t.layer){case 1:default:i=144e3*i/(e<<(3===t.version?0:1))>>>0,i+=t.padding;break;case 2:i=144e3*i/e>>>0,i+=t.padding;break;case 3:i=12e3*i/e>>>0,i=4*(i+t.padding)}return i}},4222:(t,e,i)=>{i.d(e,{FN:()=>n,W8:()=>r,c1:()=>a});const r=100,a=128,n=156},4906:(t,e,i)=>{i.d(e,{In:()=>m,M9:()=>W,VO:()=>I,fz:()=>w,hm:()=>A,qg:()=>U});var r=i(9983),a=i(2320),n=i(3674),s=i(4187),o=i(1755),c=i(3321),d=i(665),f=i(9906),g=i(4405),h=i(3737),l=i(8370),p=i(5815);const u="packages/avformat/src/formats/mp3/id3v2.ts",m={JPG:7,PNG:61,"image/gif":97,"image/jpeg":7,"image/jpg":7,"image/png":61,"image/tiff":96,"image/bmp":78,"image/webp":171},w=["Other","32x32 pixels 'file icon'","Other file icon","Cover (front)","Cover (back)","Leaflet page","Media (e.g. label side of CD)","Lead artist/lead performer/soloist","Artist/performer","Conductor","Band/Orchestra","Composer","Lyricist/text writer","Recording Location","During recording","During performance","Movie/video screen capture","A bright coloured fish","Illustration","Band/artist logotype","Publisher/Studio logotype"];function x(t,e){t.writeUint8(e>>21&127),t.writeUint8(e>>14&127),t.writeUint8(e>>7&127),t.writeUint8(127&e)}function b(t,e){let i="utf-8";return 0===t?i="iso-8859-1":1===t?i="utf-16":2===t&&(i="utf-16be"),new TextDecoder(i).decode(e)}function T(t){return(127&t)+((32512&t)>>1)+((8323072&t)>>2)+((2130706432&t)>>3)}async function k(t,e){await t.seek(e);const i=await t.readString(4);return/^[A-Z0-9]+$/.test(i)}async function U(t,e,i,r){const a=2!==i.version,n=a?10:6;let s=t.getPos()+BigInt(0|e);async function o(){await t.skip(Number(BigInt.asIntN(32,s-t.getPos())))}if(a&&64&i.flags){let r=await async function(t,e){let i=0;for(;e--;)i=(i<<7)+(127&await t.readUint8());return i}(t,4);if(4===i.version&&(r-=4),r<0)return f.z3("invalid extended header length",u,149),await o();if(await t.skip(r),(e-=r+4)<0)return f.z3("extended header too long",u,155),await o()}for(;e>n;){let s,o;if(a){if(s=await t.readString(4),o=await t.readUint32(),!o){f.z3("invalid frame size",u,168);break}if(4===i.version&&o>127)if(o<e){await t.flush();const e=t.getPos();if(!(1&t.flags||6+o<t.remainingLength()))break;if(await k(t,e+BigInt(2)+BigInt(T(o))))o=T(o);else if(!await k(t,e+BigInt(2)+BigInt(o)))break;await t.seek(e)}else o=T(o);await t.readUint16()}else s=await t.readString(3),o=await t.readUint24();if("APIC"===s)r.apic||(r.apic=[]),r.apic.push(await t.readBuffer(o));else if("USLT"===s){const e=await t.readUint8(),i=await t.readString(3),a=await t.readBuffer(o-4);r.lyrics=`${i} ${b(e,a)}`}else if("COMM"===s||"COM"===s){const e=await t.readUint8(),i=await t.readString(3),a=await t.readBuffer(o-4);r.comment=`${i} ${b(e,a)}`}else if("PRIV"===s){const e=t.getPos(),i=[];for(;;){const e=await t.readUint8();if(0===e)break;i.push(e)}const a=g.decode(new Uint8Array(i));let n;n="com.apple.streaming.transportStreamTimestamp"===a?await t.readUint64():await t.readBuffer(o-Number(t.getPos()-e)),r[a]=n}else{let e;switch(e="T"===s[0]?b(await t.readUint8(),await t.readBuffer(o-1)):await t.readBuffer(o),s){case"TIT2":case"TT2":r.title=e;break;case"TPE1":case"TP1":r.artist=e;break;case"TPE2":case"TP2":r.albumArtist=e;break;case"TPOS":r.disc=e;break;case"TCOP":r.copyright=e;break;case"TALB":case"TAL":r.album=e;break;case"TRCK":case"TRK":r.track=e;break;case"TYER":case"TDRL":case"TDRC":r.date=e;break;case"COMM":case"COM":r.comment=e;break;case"TCON":case"TCO":r.genre=e;break;case"TSSE":case"TEN":r.encoder=e;break;case"TCOM":r.composer=e;break;case"TENC":r.vendor=e;break;case"TLAN":r.language=e;break;case"TPE3":case"TP3":r.performer=e;break;case"TPUB":r.publisher=e;break;case"TCMP":case"TCP":r.compilation=e;break;case"TDEN":r.creationTime=e;break;case"TSOA":r.albumSort=e;break;case"TSOP":r.artistSort=e;break;case"TSOT":r.titleSort=e;break;case"TIT1":r.grouping=e;break;default:r[s]=e}}e-=o+n}4==i.version&&16&i.flags&&(s+=BigInt(10)),await t.skip(Number(BigInt.asIntN(32,s-t.getPos())))}function A(t,e,i){const d=2!==i.version;e.forEach((e=>{const i=new p.A(e),f=i.readUint8();let g;function h(){let t=Number(i.getPos());for(;t<e.length&&e[t];)t++;return t}if(d?(g=i.readString(h()-Number(i.getPos())),i.skip(1)):g=i.readString(3),!m[g])return;const l=i.readUint8();let u;const x=h()-Number(i.getPos());x&&(u=b(f,i.readBuffer(x))),i.skip(1);const T=t.createStream();T.codecpar.codecId=m[g],T.codecpar.codecType=0,T.disposition|=1024,T.attachedPic=(0,s._5)(),a.M[15](T.attachedPic+32,T.index);const k=i.remainingSize(),U=(0,o.sY)(k),A=i.readBuffer(k);(0,n.lW)(U,k,A),A.length>=8&&c.FB(A.subarray(0,8),new Uint8Array([137,80,78,71,13,10,26,10]))&&(T.codecpar.codecId=61),(0,s.NX)(T.attachedPic,U,k),a.M[15](T.attachedPic+36,1|r.f[15](T.attachedPic+36)),T.metadata.comment=w[l],u&&(T.metadata.title=u)}))}function W(t,e,i,r){let a=t.getPos();t.writeString("ID3"),t.writeUint8(e),t.writeUint16(0);const n=t.getPos();function s(i,r){const a=g.encode(r);t.writeString(i),4===e?x(t,a.length+1):t.writeUint32(a.length+1),t.writeUint16(0),t.writeUint8(3),t.writeBuffer(a)}function o(i,r){t.writeString(i),4===e?x(t,r.length):t.writeUint32(r.length),t.writeUint16(0),t.writeBuffer(r)}if(t.writeUint32(0),r.poster&&o("APIC",r.poster),r.apic&&r.apic.forEach((t=>{o("APIC",t)})),r.title&&s("TIT2",r.title),r.artist&&s("TPE1",r.artist),r.albumArtist&&s("TPE2","albumArtist"),r.disc&&s("TPOS",r.disc),r.copyright&&s("TCOP",r.copyright),r.album&&s("TALB",r.album),r.track&&s("TRCK",r.track),r.date&&s("TDRC",r.date),r.comment){let t=r.comment;" "===t[3]&&(t=t.slice(0,3)+t.slice(4)),s("COMM",t)}if(r.lyrics){let t=r.lyrics;" "===t[3]&&(t=t.slice(0,3)+t.slice(4)),s("USLT",t)}r.genre&&s("TCON",r.genre+""),r.encoder&&s("TSSE",r.encoder),r.composer&&s("TCOM",r.composer),r.vendor&&s("TENC",r.vendor),r.language&&s("TLAN",r.language),r.performer&&s("TPE3",r.performer),r.publisher&&s("TPUB",r.publisher),r.compilation&&s("TCMP",r.compilation),r.creationTime&&s("TDEN",r.creationTime),r.albumSort&&s("TSOA",r.albumSort),r.artistSort&&s("TSOP",r.artistSort),r.titleSort&&s("TSOT",r.titleSort),r.grouping&&s("TIT1",r.grouping),i<10&&(i=10);const c=Number(BigInt.asIntN(32,t.getPos()-a));i>268435455-c&&(i=268435455-c),t.writeBuffer(new Uint8Array(i).fill(0)),a=t.getPos(),t.seek(n),x(t,c),t.seek(a)}function I(t,e){const i=[],r=new l.A,a=[];r.onFlush=t=>(a.push(t.slice()),0);const n=2!==e;return t.streams.forEach((t=>{if(1024&t.disposition&&(n&&(7===t.codecpar.codecId||61===t.codecpar.codecId||96===t.codecpar.codecId||97===t.codecpar.codecId||171===t.codecpar.codecId||78===t.codecpar.codecId)||!n&&(61===t.codecpar.codecId||7===t.codecpar.codecId))&&t.attachedPic){a.length=0,r.writeUint8(3),n?(r.writeString(d.BE(m)[t.codecpar.codecId]),r.writeUint8(0)):61===t.codecpar.codecId?r.writeString("PNG"):r.writeString("JPG");let e=0;t.metadata.comment&&w.indexOf(t.metadata.comment)>-1&&(e=w.indexOf(t.metadata.comment)),r.writeUint8(e),t.metadata.description&&r.writeString(t.metadata.description),r.writeUint8(0),r.writeBuffer((0,s.iI)(t.attachedPic)),r.flush(),i.push((0,h.A)(Uint8Array,a))}})),i}},6911:(t,e,i)=>{i.d(e,{A:()=>a});var r=i(4467);class a{constructor(){(0,r.A)(this,"type",-1)}async destroy(t){}}(0,r.A)(a,"Capabilities",[])},8507:(t,e,i)=>{i.r(e),i.d(e,{default:()=>T});var r=i(4467),a=i(9983),n=i(6911),s=i(935),o=i(4222),c=i(4906),d=i(3674),f=i(495),g=i(1237),h=i(9935),l=i(665),p=i(1605),u=i(9906),m=i(4405),w=i(187);const x="packages/avformat/src/formats/OMp3Format.ts",b={id3v2Version:4,hasID3v1:!1,hasXing:!0};class T extends n.A{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(),(0,r.A)(this,"type",14),(0,r.A)(this,"options",void 0),(0,r.A)(this,"context",void 0),(0,r.A)(this,"xingWriter",void 0),this.options=l.X$({},b,t)}init(t){return t.ioWriter.setEndian(!0),this.context={size:0,frames:0,seen:0,want:1,bag:[],pos:0,initialBitrate:0,hasVariableBitrate:!1,padding:0,delay:0,frameHeader:new s.Vz,xingOffset:-1,xingFrameSize:0,xingFrameOffset:BigInt(0),xingFramePos:BigInt(0),audioSize:0,id3SizePos:BigInt(0)},this.xingWriter=new w.A(new Uint8Array(5e3)),t.streams.find((t=>86017===t.codecpar.codecId))?0:(u.z3("can not found stream with mp3 codec",x,142),f.UY)}writeXingTag(t){if(!this.options.hasXing)return;const e=t.streams.find((t=>86017===t.codecpar.codecId));let i=-1,r=0,a=-1,n=-1,c=BigInt(0|g.go),d=0,f=0;const l=[44100,48e3,32e3];for(let t=0;t<l.length;t++){const r=l[t];if(e.codecpar.sampleRate===r)d=3;else if(e.codecpar.sampleRate===r/2)d=2;else{if(e.codecpar.sampleRate!==r/4)continue;d=0}i=t}if(i===l.length)return void u.R8("unsupported sample rate, not writing Xing header.",x,188);switch(e.codecpar.chLayout.nbChannels){case 1:r=3;break;case 2:r=0;break;default:return void u.R8("unsupported number of channels, not writing Xing header.",x,202)}let w=-16777216;for(w|=(227|d<<3)<<16,w|=i<<2<<8,w|=r<<6,a=1;a<15;a++){let t=BigInt(Math.floor(1e3*h.oz(d,2,a))),i=p.tn(t-e.codecpar.bitrate);i<c&&(c=i,n=a)}for(a=n;;a++){let t=a<<12;if(15==a)return;w|=t,s.qg(this.context.frameHeader,w);const i=[[0,9,17],[0,0,0],[0,9,17],[0,17,32]];if(this.context.xingOffset=i[this.context.frameHeader.version][e.codecpar.chLayout.nbChannels]+4,f=this.context.xingOffset+o.FN,f<=s.CM(this.context.frameHeader,e.codecpar.sampleRate))break;w&=~t}this.xingWriter.writeUint32(w),this.xingWriter.writeBuffer(new Uint8Array(this.context.xingOffset-4).fill(0)),this.xingWriter.writeString("Xing"),this.xingWriter.writeUint32(15),this.context.size=s.CM(this.context.frameHeader,e.codecpar.sampleRate),this.context.want=1,this.context.seen=0,this.context.pos=0,this.xingWriter.writeUint32(0),this.xingWriter.writeUint32(0);for(let t=0;t<o.W8;t++)this.xingWriter.writeUint8(255*t/o.W8>>>0);this.xingWriter.writeUint32(0);const b=e.metadata||{};if(b.encoder){const t=m.encode(b.encoder);this.xingWriter.writeBuffer(t.subarray(0,9))}else this.xingWriter.writeString("Lavf"),this.xingWriter.writeBuffer(new Uint8Array(5).fill(0));this.xingWriter.writeUint8(0),this.xingWriter.writeUint8(0),this.xingWriter.writeBuffer(new Uint8Array(8).fill(0)),this.xingWriter.writeUint8(0),this.xingWriter.writeUint8(0),this.xingWriter.writeUint24(0),this.xingWriter.writeUint8(0),this.xingWriter.writeUint8(0),this.xingWriter.writeUint16(0),this.xingWriter.writeUint32(0),this.xingWriter.writeUint16(0),this.xingWriter.writeUint16(0),this.xingWriter.writeBuffer(new Uint8Array(this.context.size-f).fill(0)),this.context.xingFrameSize=this.xingWriter.getPos(),this.context.xingFrameOffset=t.ioWriter.getPos(),t.ioWriter.writeBuffer(this.xingWriter.getWroteBuffer()),this.context.audioSize=this.context.xingFrameSize}xingAddFrame(t){if(this.context.frames++,this.context.seen++,this.context.size+=a.f[15](t+28),this.context.want===this.context.seen){if(this.context.bag[this.context.pos]=this.context.size,400==++this.context.pos){for(let t=1;t<400;t+=2)this.context.bag[t>>1]=this.context.bag[t];this.context.want*=2,this.context.pos=200}this.context.seen=0}}updateXing(t){this.context.hasVariableBitrate&&(this.xingWriter.seek(this.context.xingOffset),this.xingWriter.writeString("Info")),this.xingWriter.seek(this.context.xingOffset+8),this.xingWriter.writeUint32(this.context.frames),this.xingWriter.writeUint32(this.context.size),this.xingWriter.seek(this.context.xingFrameSize);const e=this.xingWriter.getWroteBuffer().subarray(this.context.xingOffset+16);e[0]=0;for(let t=1;t<o.W8;t++){let i=t*this.context.pos/o.W8>>>0;const r=256*this.context.bag[i]/this.context.size>>>0;e[t]=Math.min(r,255)}const i=t.ioWriter.getPos();t.ioWriter.seek(this.context.xingFrameOffset),t.ioWriter.writeBuffer(this.xingWriter.getWroteBuffer()),t.ioWriter.seek(i)}writeHeader(t){const e=t.streams.find((t=>86017===t.codecpar.codecId));if(this.options.id3v2Version){const i=c.VO(t,this.options.id3v2Version);c.M9(t.ioWriter,this.options.id3v2Version,t.metadataHeaderPadding,l.X$({apic:i},t.metadata,e.metadata))}return this.options.hasXing&&this.writeXingTag(t),0}writeAVPacket(t,e){if(!a.f[15](e+28))return void u.R8(`packet's size is 0: ${a.f[15](e+32)}, ignore it`,x,393);const i=t.getStreamByIndex(a.f[15](e+32));if(!i||1024&i.disposition)u.R8(`can not found the stream width the packet's streamIndex: ${a.f[15](e+32)}, ignore it`,x,400);else{if(86017===i.codecpar.codecId){if(a.f[20](e+24)&&a.f[15](e+28)>4){s.qg(this.context.frameHeader,a.f[8](a.f[20](e+24)));const i=h.oz(this.context.frameHeader.version,this.context.frameHeader.layer,this.context.frameHeader.bitrateIndex);this.context.initialBitrate?i!==this.context.initialBitrate&&(this.context.hasVariableBitrate=!0):this.context.initialBitrate=i,this.xingAddFrame(e),t.ioWriter.writeBuffer((0,d.s3)(a.f[20](e+24),a.f[15](e+28)))}return 0}u.R8(`packet's codecId is not mp3: ${a.f[15](e+32)}, ignore it`,x,405)}}writeTrailer(t){if(this.options.hasID3v1){const e=t.streams.find((t=>86017===t.codecpar.codecId)),i=l.X$({},t.metadata,e.metadata),r=new Uint8Array(o.c1),a=new w.A(r);function n(t){const e=m.encode(t);a.writeBuffer(e.subarray(0,30)),e.length<30&&a.skip(30-e.length)}a.writeString("TAG"),i.title?n(i.title):a.skip(30),i.artist?n(i.artist):a.skip(30),i.album?n(i.album):a.skip(30),r[127]=255,i.genre&&(r[127]=+i.genre),t.ioWriter.writeBuffer(r)}return this.options.hasXing&&this.updateXing(t),t.ioWriter.flush(),0}flush(t){return t.ioWriter.flush(),0}getCapabilities(){return T.Capabilities}}(0,r.A)(T,"Capabilities",[86017])}}]);